<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suno Architect v5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body { overscroll-behavior: none; background-color: #f8fafc; color: #0f172a; }

        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(2px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- SELECTION STATES --- */
        /* Specific, high-specificity classes to ensure highlighting works */
        button.btn-selected {
            background-color: #4f46e5 !important; /* Indigo 600 */
            border-color: #4338ca !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3) !important;
        }

        .btn-base {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            color: #64748b;
            transition: all 0.1s ease;
        }
        .btn-base:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            color: #334155;
        }

        /* Filter Chips */
        .filter-chip { font-size: 11px; font-weight: 500; text-transform: uppercase; background: #ffffff; color: #64748b; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 99px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .filter-chip:hover { border-color: #cbd5e1; color: #334155; background: #f8fafc; }
        .filter-chip.active-filter { background: #4f46e5; color: white; border-color: #4f46e5; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); }
        
        /* Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #e2e8f0; border-radius: 99px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #ffffff; border: 2px solid #4f46e5; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-sm"><i data-lucide="music" class="w-5 h-5 text-white"></i></div>
                    <div><h1 class="text-lg font-bold text-slate-900">Suno Architect</h1><p class="text-xs text-slate-500">Studio Manager v5.2</p></div>
                </div>
                <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl overflow-x-auto max-w-full no-scrollbar">
                    <button onclick="switchTab('studio')" id="tab-btn-studio" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg">Studio</button>
                    <button onclick="switchTab('artist')" id="tab-btn-artist" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg">Artist</button>
                    <button onclick="switchTab('dials')" id="tab-btn-dials" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg">Tuner</button>
                    <button onclick="switchTab('style')" id="tab-btn-style" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg">Blueprint</button>
                    <button onclick="switchTab('lyrics')" id="tab-btn-lyrics" class="nav-btn px-4 py-2 text-sm font-medium rounded-lg">Lyrics</button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 w-full flex-grow relative z-0">

        <!-- TAB: STUDIO -->
        <div id="tab-studio" class="tab-content active">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)] min-h-[600px]">
                <!-- Artists List -->
                <div class="lg:col-span-3 bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-xs uppercase tracking-wide">1. Artists</h3>
                        <button onclick="switchTab('artist')" class="p-1 hover:bg-slate-200 rounded text-indigo-600" title="Create Artist"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="studio-artist-list" class="overflow-y-auto p-2 space-y-1 flex-grow"></div>
                </div>

                <!-- Albums List -->
                <div class="lg:col-span-3 bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-xs uppercase tracking-wide">2. Albums</h3>
                        <button onclick="promptCreateAlbum()" class="p-1 hover:bg-slate-200 rounded text-indigo-600" title="New Album"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="studio-album-list" class="overflow-y-auto p-2 space-y-1 flex-grow">
                        <div class="text-center py-10 text-slate-400 text-xs">Select an Artist</div>
                    </div>
                </div>

                <!-- Songs List -->
                <div class="lg:col-span-6 bg-white border border-slate-200 rounded-2xl shadow-sm flex flex-col overflow-hidden">
                     <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-xs uppercase tracking-wide">3. Songs</h3>
                    </div>
                    <div id="studio-song-list" class="overflow-y-auto p-4 space-y-3 flex-grow">
                        <div class="text-center py-20 text-slate-400 text-sm">Select an Album to view songs</div>
                    </div>
                </div>
             </div>
        </div>

        <!-- TAB: ARTIST BUILDER (Unique IDs) -->
        <div id="tab-artist" class="tab-content">
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Builder Form -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 text-indigo-600">
                            <i data-lucide="mic-2" class="w-5 h-5"></i>
                            <h2 class="font-bold text-slate-900">Artist Builder</h2>
                        </div>
                        <div class="space-y-4">
                            <input type="text" id="builder-artist-name" placeholder="Artist / Band Name" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-slate-900 focus:outline-none focus:border-indigo-500">
                            <textarea id="builder-artist-bio" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 h-24 text-sm resize-none focus:outline-none focus:border-indigo-500" placeholder="Internal Bio / Sound Identity..."></textarea>
                            <input type="text" id="builder-artist-exclusions" placeholder="Signature Exclusions (e.g. No Drums)" class="w-full bg-slate-50 border border-red-100 rounded-lg px-4 py-3 text-sm text-red-600 focus:outline-none focus:border-red-400">
                            
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Current Sound State</h4>
                                <div id="builder-preview-stats" class="text-xs text-slate-600 font-mono space-y-1">
                                    <span class="italic text-slate-400">Set Genres/Instruments in Blueprint tab first...</span>
                                </div>
                            </div>
                            
                            <button onclick="saveArtistToDB()" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 transition-colors">
                                Create Artist
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Artist Roster List (Read Only) -->
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm h-[600px] flex flex-col">
                    <h2 class="font-bold text-slate-900 mb-4">Roster</h2>
                    <div id="roster-list" class="overflow-y-auto pr-2 space-y-3 flex-grow"></div>
                </div>
            </div>
        </div>

        <!-- TAB: STYLE TUNER (DIALS) -->
        <div id="tab-dials" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Controls -->
                <div class="lg:col-span-7 space-y-6 pb-10">
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h2 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-4">1. Foundation</h2>
                        <div class="space-y-4">
                            <div id="dial-category-filters" class="flex flex-wrap gap-2"></div>
                            <select id="dial-genre-select" onchange="updateDials()" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500"><option value="">Select Base Genre...</option></select>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h2 class="text-sm font-bold text-slate-900 uppercase tracking-wide mb-6">2. Style Shaping</h2>
                        <div class="space-y-6">
                            <!-- Sliders -->
                            <div class="space-y-2"><div class="flex justify-between text-sm"><span class="font-medium">Innovation</span><span id="val-weird" class="text-xs text-purple-600 font-bold bg-purple-50 px-2 py-0.5 rounded">Standard</span></div><input type="range" id="dial-weirdness" min="0" max="100" value="0" oninput="updateDials()"></div>
                            <div class="space-y-2"><div class="flex justify-between text-sm"><span class="font-medium">Texture</span><span id="val-era" class="text-xs text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded">Clean</span></div><input type="range" id="dial-era" min="0" max="100" value="50" oninput="updateDials()"></div>
                            <div class="space-y-2"><div class="flex justify-between text-sm"><span class="font-medium">Energy</span><span id="val-intensity" class="text-xs text-yellow-600 font-bold bg-yellow-50 px-2 py-0.5 rounded">Balanced</span></div><input type="range" id="dial-intensity" min="0" max="100" value="50" oninput="updateDials()"></div>
                            <div class="space-y-2"><div class="flex justify-between text-sm"><span class="font-medium">Speed</span><span id="val-tempo" class="text-xs text-red-600 font-bold bg-red-50 px-2 py-0.5 rounded">Mid</span></div><input type="range" id="dial-tempo" min="0" max="100" value="50" oninput="updateDials()"></div>
                            <div class="space-y-2"><div class="flex justify-between text-sm"><span class="font-medium">Vocals</span><span id="val-vocals" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded">Vocal</span></div><input type="range" id="dial-vocals" min="0" max="100" value="75" oninput="updateDials()"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Output -->
                <div class="lg:col-span-5">
                    <div class="sticky top-24 bg-white rounded-2xl border border-slate-200 shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-900">Live Output</h3><button onclick="promptSaveSong()" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded"><i data-lucide="save" class="w-5 h-5"></i></button></div>
                        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 text-xs font-mono text-slate-600 space-y-2 mb-4">
                            <div id="preview-genre">Select Genre...</div>
                            <div id="preview-dials"></div>
                        </div>
                        <button onclick="applyDialsToMain()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md transition-colors">Send to Blueprint</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: BLUEPRINT (Main Selection) -->
        <div id="tab-style" class="tab-content">
             <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-7 space-y-8 pb-20">
                    <!-- Quick Presets -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border border-indigo-100">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-indigo-900 text-sm">Quick Presets</h3></div>
                        <div id="preset-container" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Genre -->
                    <section class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h2 class="font-bold text-slate-900 mb-4 flex items-center"><i data-lucide="list-music" class="w-4 h-4 mr-2 text-purple-600"></i>1. Genre Foundation</h2>
                        <!-- Category Filters for Genre -->
                        <div id="genre-cats" class="flex flex-wrap gap-2 mb-3"></div>
                        <div id="genre-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                        <div id="subgenre-container" class="flex flex-wrap gap-2"></div>
                    </section>
                    
                    <!-- Players -->
                    <section class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                         <h2 class="font-bold text-slate-900 mb-4 flex items-center"><i data-lucide="mic-2" class="w-4 h-4 mr-2 text-blue-600"></i>2. Players</h2>
                         <div class="mb-4">
                             <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Singer Identity</label>
                             <input id="singer-desc" type="text" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm" placeholder="e.g. Raspy Male Baritone" oninput="updatePrompt()">
                         </div>
                         <div id="voices-container" class="flex flex-wrap gap-2 mb-4"></div>
                         <label class="text-xs font-bold text-slate-500 uppercase block mb-2">Instruments</label>
                         <div id="instrument-cats" class="flex flex-wrap gap-2 mb-3"></div>
                         <div id="instruments-container" class="flex flex-wrap gap-2 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    </section>

                    <!-- Vibe & Production -->
                    <section class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h2 class="font-bold text-slate-900 mb-4 flex items-center"><i data-lucide="zap" class="w-4 h-4 mr-2 text-yellow-500"></i>3. Vibe & Production</h2>
                        <div id="mood-cats" class="flex flex-wrap gap-2 mb-2"></div>
                        <div id="moods-container" class="flex flex-wrap gap-2 mb-4"></div>
                        <div id="prod-cats" class="flex flex-wrap gap-2 mb-2"></div>
                        <div id="production-container" class="flex flex-wrap gap-2 mb-4"></div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Tempo</label>
                        <select id="tempo-select" onchange="updatePrompt()" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm mb-4"><option value="">Select...</option></select>
                        <label class="text-xs font-bold text-red-500 uppercase block mb-1">Exclusions</label>
                        <input id="exclusion-input" type="text" class="w-full bg-red-50 border border-red-100 text-red-600 rounded px-3 py-2 text-sm" placeholder="No Drums, No Synth..." oninput="updateExclusions(this.value)">
                    </section>
                </div>
                
                <!-- Output -->
                <div class="lg:col-span-5">
                     <div class="sticky top-24 bg-white rounded-2xl border border-slate-200 shadow-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-900">Prompt Output</h3>
                            <button onclick="promptSaveSong()" class="p-2 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100"><i data-lucide="save" class="w-4 h-4"></i></button>
                        </div>
                        <div class="mb-4">
                             <select id="platform-select" onchange="updatePrompt()" class="w-full text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1"><option value="suno">Format: Suno</option><option value="udio">Format: Udio</option></select>
                        </div>
                        
                        <!-- Conflict Warning -->
                        <div id="conflict-box" class="hidden mb-3 p-2 bg-amber-50 text-amber-700 text-xs rounded border border-amber-100"></div>

                        <textarea id="style-output" readonly class="w-full h-40 bg-slate-50 border border-slate-200 rounded-xl p-4 text-slate-900 font-mono text-sm resize-none mb-3"></textarea>
                        <div id="char-count" class="text-right text-xs text-slate-400 mb-3">0/200</div>
                        <button onclick="copyToClipboard('style-output', this)" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow transition-colors btn-text">Copy Prompt</button>
                     </div>
                </div>
             </div>
        </div>

        <!-- TAB: LYRICS (Minimal) -->
        <div id="tab-lyrics" class="tab-content"><div class="max-w-4xl mx-auto bg-white rounded-xl p-6 border shadow-sm h-[600px] flex flex-col"><textarea id="lyrics-input" class="flex-grow bg-slate-50 border p-4 rounded resize-none font-mono text-sm"></textarea></div></div>

    </main>

    <!-- SAVE MODAL -->
    <div id="save-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="font-bold text-lg">Save Song</h3>
            <select id="save-artist-select" class="w-full border rounded p-2 text-sm" onchange="populateSaveAlbums()"></select>
            <div class="flex gap-2"><select id="save-album-select" class="w-full border rounded p-2 text-sm"></select><button onclick="promptCreateAlbum()" class="bg-slate-100 px-3 rounded text-xs font-bold">+</button></div>
            <input id="save-title" type="text" placeholder="Song Title" class="w-full border rounded p-2 text-sm">
            <input id="save-link" type="text" placeholder="Suno Link (Optional)" class="w-full border rounded p-2 text-sm">
            <div class="flex gap-2"><button onclick="document.getElementById('save-modal').classList.add('hidden')" class="flex-1 bg-slate-100 py-2 rounded text-sm">Cancel</button><button onclick="commitSaveSong()" class="flex-1 bg-indigo-600 text-white py-2 rounded text-sm">Save</button></div>
        </div>
    </div>

    <!-- VERSION MODAL -->
    <div id="version-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 space-y-4">
             <h3 class="text-lg font-bold text-slate-900">Add Version</h3>
             <input type="hidden" id="version-song-id">
             <input type="text" id="version-label" placeholder="Version Name (e.g. V2, Remix)" class="w-full bg-slate-50 border rounded-lg px-3 py-2">
             <input type="text" id="version-link" placeholder="Suno Link" class="w-full bg-slate-50 border rounded-lg px-3 py-2">
             <div class="flex gap-3"><button onclick="closeVersionModal()" class="flex-1 py-2 bg-slate-100 rounded-lg">Cancel</button><button onclick="commitAddVersion()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg">Add</button></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const PROMPT_PREFIX = "[Is_MAX_MODE: MAX](MAX)\n[QUALITY: MAX](MAX)\n[REALISM: MAX](MAX)\n[REAL_INSTRUMENTS: MAX](MAX)\n";
        const LYRICS_PREFIX = "///*****///\n\n";
        
        // COMPREHENSIVE DATA (Restored)
        const GENRES = {
            "Indie/Alt": ["Dream Pop", "Shoegaze", "Slowcore", "Indie Folk", "Art Pop", "Noise Pop", "Indie Rock", "Post-Rock", "Math Rock", "Bedroom Pop", "Twee Pop", "Jangle Pop", "Folktronica"],
            "Rock": ["Alternative Rock", "Art Rock", "Blues Rock", "Classic Rock", "Garage Rock", "Glam Rock", "Gothic Rock", "Grunge", "Hard Rock", "Indie Rock", "Industrial Rock", "Prog Rock", "Psychedelic Rock", "Punk", "Rockabilly", "Soft Rock", "Southern Rock", "Stoner Rock", "Surf Rock", "Yacht Rock"],
            "Metal": ["Alternative Metal", "Black Metal", "Death Metal", "Deathcore", "Djent", "Doom Metal", "Drone Metal", "Folk Metal", "Glam Metal", "Gothic Metal", "Grindcore", "Groove Metal", "Heavy Metal", "Industrial Metal", "Metalcore", "Nu Metal", "Power Metal", "Sludge Metal", "Speed Metal", "Symphonic Metal", "Thrash Metal"],
            "Electronic": ["Acid House", "Acid Techno", "Ambient", "Big Beat", "Breakbeat", "Chillstep", "Chillwave", "Chiptune", "Deep House", "Downtempo", "Drum and Bass", "Dubstep", "Electro", "Eurodance", "Future Bass", "Gabber", "Glitch", "Glitch Pop", "Hardcore", "Hardstyle", "House", "IDM", "Industrial", "Jungle", "Lo-Fi", "Melodic Techno", "Minimal", "Phonk", "Psytrance", "Synth-Pop", "Synthwave", "Tech House", "Techno", "Trance", "Trap", "Trip Hop", "UK Garage", "Vaporwave", "Witch House"],
            "Pop": ["Art Pop", "Baroque Pop", "Bedroom Pop", "Britpop", "Bubblegum Pop", "City Pop", "Country-Pop", "Dance-Pop", "Dream Pop", "Electropop", "Europop", "Hyperpop", "Indie Pop", "J-Pop", "K-Pop", "Latin Pop", "Power Pop", "Sophisti-Pop", "Sunshine Pop", "Teen Pop"],
            "Hip Hop": ["Abstract Hip Hop", "Boom Bap", "Cloud Rap", "Conscious Hip Hop", "Crunk", "Drill", "East Coast", "Experimental Hip Hop", "G-Funk", "Gangsta Rap", "Grime", "Hardcore Hip Hop", "Horrorcore", "Jazz Rap", "Lyrical Hip Hop", "Mumble Rap", "Old School", "Pop Rap", "Trap", "Turntablism", "West Coast"],
            "R&B/Soul": ["Alternative R&B", "Blue-Eyed Soul", "Contemporary R&B", "Disco", "Doo-Wop", "Funk", "Gospel", "Modern Soul", "Motown", "Neo-Soul", "New Jack Swing", "Northern Soul", "Psychedelic Soul", "Quiet Storm", "Soul"],
            "Jazz": ["Acid Jazz", "Afro-Cuban Jazz", "Avant-Garde Jazz", "Bebop", "Big Band", "Bossa Nova", "Cool Jazz", "Dixieland", "Free Jazz", "Fusion", "Gypsy Jazz", "Hard Bop", "Latin Jazz", "Modal Jazz", "Smooth Jazz", "Swing"],
            "Folk/Country": ["Alt-Country", "Americana", "Bluegrass", "Celtic Folk", "Contemporary Folk", "Country", "Country Rock", "Dark Folk", "Folk Punk", "Folk Rock", "Freak Folk", "Honky Tonk", "Indie Folk", "Neofolk", "Outlaw Country", "Traditional Folk", "Western Swing"],
            "Classical/Score": ["Baroque", "Chamber Music", "Choral", "Cinematic", "Classical Period", "Drone", "Epic Trailer", "Experimental", "Impressionist", "Medieval", "Minimalism", "Modern Classical", "Neoclassical", "Opera", "Orchestral", "Romantic", "Score", "Soundtrack", "Symphonic"],
            "Latin/World": ["Afrobeat", "Bachata", "Bossa Nova", "Cumbia", "Dancehall", "Flamenco", "Latin Jazz", "Latin Pop", "Latin Rock", "Mariachi", "Merengue", "Reggae", "Reggaeton", "Salsa", "Samba", "Ska", "Tango"],
            "Blues/Roots": ["Acoustic Blues", "Chicago Blues", "Country Blues", "Delta Blues", "Electric Blues", "Rhythm and Blues", "Roots Rock", "Swamp Blues", "Zydeco"],
            "Atmospheric": ["Ethereal", "Cinematic", "Dark Ambient", "Drone", "Space Rock"],
            "Time Period": ["1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s", "2020s"],
            "Suno/Meta": ["Ritmiczna", "Melodyjna", "Dynamiczna", "Szybka", "Wolna", "Staccato", "Legato", "Syncopated", "Anthemic", "Broadcasting", "Trailer", "Anime Opening", "Eurovision", "Billboard 100", "Commercial", "Jingle"]
        };

        const INSTRUMENT_GROUPS = {
            "Strings": ["Violin", "Cello", "Double Bass", "String Quartet", "Fiddle", "Harp", "Erhu", "Koto", "Sitar", "Sarangi", "Shamisen", "Zither"],
            "Guitars": ["Fingerstyle Acoustic Guitar", "Electric Guitar", "Bass Guitar", "Distorted Guitar", "Clean Guitar", "Slide Guitar", "Pedal Steel", "Glide Guitar", "Shoegaze Guitar", "12-String Guitar", "Banjo", "Ukulele", "Mandolin", "Lute"],
            "Keys": ["Piano", "Electric Piano", "Rhodes", "Wurlitzer", "Organ", "Hammond", "Synthesizer", "Modular Synthesizer", "Analog Synth", "Mellotron", "Toy Piano", "Celesta", "Harpsichord"],
            "Percussion": ["Drum Kit", "Electronic Drums", "808 Drums", "909 Kit", "Hybrid Drums", "LinnDrum", "Congas", "Bongos", "Tabla", "Glitch Drums", "Brushes", "Shaker", "Tambourine", "Timpani", "Handclaps"],
            "Wind/Brass": ["Saxophone", "Processed Saxophone", "Trumpet", "Flute", "Clarinet", "Oboe", "Trombone", "Tuba", "French Horn", "Bassoon", "Bagpipes", "Didgeridoo", "Harmonica"],
            "Studio": ["WA-47", "Neumann U87", "Sony C800G", "Shure SM7B", "Neve Console", "SSL Console", "Tube Preamp", "Tape Machine", "Cassette"]
        };

        const MOOD_GROUPS = {
            "Atmospheric": ["Ethereal", "Dreamy", "Winter Atmosphere", "Cosmic", "Floating", "Hypnotic", "Lush", "Spaced Out", "Hazy", "Cinematic", "Majestic", "Swirling", "Trippy"],
            "Emotional": ["Melancholic", "Bittersweet", "Nostalgic", "Sentimental", "Yearning", "Heartbreaking", "Introspective", "Lonely", "Passionate", "Romantic", "Sad", "Sorrowful", "Soulful"],
            "Dark": ["Gloomy", "Brooding", "Ominous", "Haunting", "Dark", "Gothic", "Noir", "Mysterious", "Spooky", "Suspenseful"],
            "Energy": ["High Energy", "Aggressive", "Driving", "Manic", "Punchy", "Explosive", "Industrial", "Intense", "Powerful", "Upbeat"],
            "Chill": ["Chill", "Mellow", "Laid-back", "Serene", "Pastoral", "Sleepy", "Calm", "Comforting", "Peaceful", "Relaxing", "Soothing", "Tranquil", "Warm"],
            "Happy/Quirky": ["Bouncy", "Confident", "Happy", "Hopeful", "Inspirational", "Joyful", "Joyous", "Jubilant", "Optimistic", "Playful", "Quirky", "Sexy", "Silly", "Sophisticated", "Sweet", "Whimsical", "Witty", "Glitchy"]
        };

        const PRODUCTION_GROUPS = {
            "Texture": ["Lo-Fi", "Lo-Fi Tape Saturation", "Granular Textures", "Grainy", "Warm", "Cold", "Crisp", "Fuzzy", "Distorted", "Vinyl Crackle", "Analog Warmth", "Brittle", "Crunchy", "Gritty", "Harsh", "Noise", "Old School", "Organic", "Raw", "Retro", "Saturated", "Tape Saturation", "8-bit"],
            "Space": ["Massive Reverb", "Wide Stereo Field", "Binaural", "Dry", "Wet", "Echoey", "Cavernous", "Intimate", "Bedroom", "Atmospheric", "Immersive Soundstage", "Live Room", "Room Reverb", "Room Tone", "Stereo", "Wide Stereo", "Wet Mix"],
            "Tech": ["Heavy Auto-Tune", "Vocoder", "Gated Reverb", "Sidechained", "Compressed", "Wall of Sound", "Minimalist", "Maximalist", "Breathy", "Glitched", "Hollow", "Monophonic", "Polyphonic", "Swirling Textures", "Synthetic", "Twangy", "Underwater"],
            "Clarity": ["Bright", "Clean", "Clear", "Crisp", "Dry Mix", "Flat", "Hi-Fi", "Modern Production", "Polished", "Studio"],
            "Mix": ["Deep", "Dense", "Heavy Bass", "Instrument-forward Balance", "Loud Master", "Minimal", "Muddy", "Muffled", "Punchy", "Sparse", "Thick", "Thin", "Tight"]
        };

        const VOICES = ["Male Vocals", "Female Vocals", "Androgynous", "Choir", "Whisper", "Screaming", "Rap Flow", "Autotune", "Operatic", "Baritone", "Falsetto", "Raspy", "Robot", "Vocoder", "Group Backing Vocals", "Children's Choir", "Gospel Choir", "Gang Vocals", "Growling", "Spoken Word", "Bass", "Alto", "Soprano", "Guttural", "Chant", "Crooner", "Scat Singing", "Yodeling", "Throat Singing", "Beatboxing", "Multi-layered Harmonies", "Introspective"];
        const TEMPO_FEEL = ["Slow", "Medium", "Fast", "Groovy", "Driving", "Syncopated", "Swing", "Straight", "60 BPM", "90 BPM", "120 BPM", "140 BPM", "170 BPM", "Slow (Adagio)", "Walking Pace (Andante)", "Fast (Allegro)", "Very Fast (Presto)", "Driving 4/4", "Half-time", "Shuffle", "Triplet Feel", "Rubato", "Free Tempo", "Blast Beat", "Breakbeat", "D-Beat", "Double Time", "Down-tempo", "Four-on-the-Floor", "Latin Groove", "Motorik", "Off-beat", "Polyrhythmic", "Pulsing", "Skank", "Slow Burn", "Slow Jam", "Staccato", "Steady Beat", "Up-tempo", "Waltz (3/4)"];
        
        const METATAGS = [ { label: "Intro", tag: "[Intro]" }, { label: "Verse", tag: "[Verse]" }, { label: "Chorus", tag: "[Chorus]" }, { label: "Bridge", tag: "[Bridge]" }, { label: "Outro", tag: "[Outro]" } ];
        const PERFORMANCE_TAGS = [ { label: "Whisper", tag: "[Whisper]" }, { label: "Scream", tag: "[Scream]" }, { label: "Drop", tag: "[Drop]" }, { label: "Solo", tag: "[Solo]" } ];
        
        const PRESETS = { "Dream Pop": { genre: "Indie/Alt", subs: ["Dream Pop"], inst: ["Electric Guitar","Synthesizer"], prod: ["Massive Reverb"] }, "Lo-Fi": { genre: "Electronic", subs: ["Lo-Fi"], inst: ["Piano"], prod: ["Lo-Fi","Warm"] } };

        const CONFLICTS = [
            { tags: ["Acoustic", "Synthesizer"], msg: "Mixing 'Acoustic' with 'Synthesizer' can be valid, but check if you want pure acoustic." },
            { tags: ["Instrumental", "Male Vocals"], msg: "Conflict: 'Instrumental' and 'Male Vocals'." },
            { tags: ["Instrumental", "Female Vocals"], msg: "Conflict: 'Instrumental' and 'Female Vocals'." },
            { tags: ["Lo-Fi", "Hi-Fi"], msg: "Conflict: 'Lo-Fi' and 'Hi-Fi' are opposites." },
            { tags: ["Slow", "Fast"], msg: "Conflict: Tempo contradiction." }
        ];

        // --- STATE ---
        let state = { genreCat:"", subgenres:[], instruments:[], voices:[], moods:[], production:[], tempo:"", singerDescription:"", exclusions:"" };
        
        // --- DB ---
        const DB_NAME = 'SunoStudioDB';
        const DB_VERSION = 4;
        let db, selectedArtistId, selectedAlbumId;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initDB();
            initUI();
            updatePrompt();
        });

        function initDB() {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains("artists")) db.createObjectStore("artists", { keyPath: "id" });
                if(!db.objectStoreNames.contains("albums")) { const s = db.createObjectStore("albums", { keyPath: "id" }); s.createIndex("artistId", "artistId"); }
                if(!db.objectStoreNames.contains("songs")) { const s = db.createObjectStore("songs", { keyPath: "id" }); s.createIndex("albumId", "albumId"); }
            };
            req.onsuccess = (e) => { db = e.target.result; renderArtists(); };
            req.onerror = (e) => console.error("DB Error", e);
        }

        // --- UI INIT ---
        function initUI() {
            // Genres
            initCatList('genre-cats', 'genre-container', GENRES, 'genreCat', true); // True for single select behavior on cat, multi on item
            
            // Dials Genres
            initCatList('dial-category-filters', null, GENRES, null, true, true);

            // Instruments
            initCatList('instrument-cats', 'instruments-container', INSTRUMENT_GROUPS, 'instruments');
            // Moods
            initCatList('mood-cats', 'moods-container', MOOD_GROUPS, 'moods');
            // Production
            initCatList('prod-cats', 'production-container', PRODUCTION_GROUPS, 'production');
            // Voices
            renderList('voices-container', VOICES, 'voices');
            // Tempo
            const ts = document.getElementById('tempo-select');
            TEMPO_FEEL.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; ts.appendChild(o); });
            // Presets
            const pc = document.getElementById('preset-container');
            Object.keys(PRESETS).forEach(k => {
                 const b = document.createElement('button'); b.className = "text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-100 hover:bg-indigo-100";
                 b.textContent = k; b.onclick = () => loadPreset(k);
                 pc.appendChild(b);
            });
            // Init text areas
            document.getElementById('lyrics-input').value = LYRICS_PREFIX;
        }

        // Generic Category UI
        function initCatList(catId, listId, data, key, isSingleGenre = false, isDial = false) {
             const cc = document.getElementById(catId); 
             if(!cc) return;
             cc.innerHTML = '';
             
             Object.keys(data).forEach(grp => {
                 const b = document.createElement('button'); b.className = "filter-chip"; b.textContent = grp;
                 b.onclick = () => {
                     Array.from(cc.children).forEach(x => x.classList.remove('active-filter'));
                     b.classList.add('active-filter');
                     
                     if (isDial) {
                         populateDialSelect(grp);
                     } else if (listId) {
                         // For Genres (isSingleGenre), clicking a category shows subgenres
                         // For Instruments/etc, clicking category shows items
                         if (isSingleGenre) {
                             // Special handling for Genre Foundation (render subgenres)
                             // Note: key here is passed as 'genreCat' but logic uses it to set main category
                             state.genreCat = grp; // Set foundation
                             renderList(listId, data[grp], 'subgenres'); // Render children
                             updatePrompt();
                         } else {
                             renderList(listId, data[grp], key);
                         }
                     }
                 };
                 cc.appendChild(b);
             });

             // Default selection for first load (except Dials which might default to ALL/None)
             if(!isDial && Object.keys(data).length > 0) {
                 // For Genre, maybe don't auto-select to keep it clean? 
                 // Or select first. Let's select first.
                 const first = Object.keys(data)[0];
                 cc.firstChild.classList.add('active-filter');
                 if(listId) {
                     if (isSingleGenre) {
                         state.genreCat = first;
                         renderList(listId, data[first], 'subgenres');
                     } else {
                         renderList(listId, data[first], key);
                     }
                 }
             } else if (isDial) {
                 populateDialSelect(null); // Init with all
             }
        }

        function renderList(id, items, key) {
            const c = document.getElementById(id); 
            if(!c) return;
            c.innerHTML = '';
            items.forEach(item => {
                const b = document.createElement('button');
                const isSel = state[key].includes(item);
                b.className = isSel ? "btn-selected px-3 py-1.5 rounded-full text-xs transition-colors border" : "btn-base px-3 py-1.5 rounded-full text-xs transition-colors";
                b.textContent = item;
                b.onclick = () => {
                    if(state[key].includes(item)) state[key] = state[key].filter(x => x !== item);
                    else state[key].push(item);
                    b.className = state[key].includes(item) ? "btn-selected px-3 py-1.5 rounded-full text-xs transition-colors border" : "btn-base px-3 py-1.5 rounded-full text-xs transition-colors";
                    updatePrompt();
                };
                c.appendChild(b);
            });
        }

        // DIAL SPECIFIC
        function populateDialSelect(filterCategory) {
            const select = document.getElementById('dial-genre-select');
            const currentValue = select.value; 
            select.innerHTML = ''; 

            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.textContent = filterCategory ? `[ ${filterCategory.toUpperCase()} ]` : "[ SELECT BASE GENRE ]";
            select.appendChild(defaultOpt);

            const categories = filterCategory ? [filterCategory] : Object.keys(GENRES);

            categories.forEach(cat => {
                if (filterCategory) {
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub; option.textContent = sub; option.dataset.category = cat;
                        select.appendChild(option);
                    });
                } else {
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = cat;
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub; option.textContent = sub; option.dataset.category = cat; 
                        optGroup.appendChild(option);
                    });
                    select.appendChild(optGroup);
                }
            });

             if (currentValue) {
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === currentValue) { exists = true; break; }
                }
                if (exists) select.value = currentValue;
            }
        }
        
        function updateDials() {
            // Simplified dial visual feedback logic
            // In full version, this would map slider values to tags
            // For now, it ensures the UI feels responsive
            const sub = document.getElementById('dial-genre-select').value;
            document.getElementById('preview-genre').textContent = sub || "Select Genre...";
            
            // Example mapping for one dial
            const wVal = document.getElementById('dial-weirdness').value;
            const wTag = wVal < 33 ? "Standard" : (wVal < 66 ? "Experimental" : "Avant-Garde");
            document.getElementById('val-weird').textContent = wTag;
            document.getElementById('preview-weirdness').textContent = wTag;

            // Trigger prompt update logic if needed, but usually Dials generates a fresh state object
        }

        function applyDialsToMain() {
            const baseGenre = document.getElementById('dial-genre-select').value;
            if (!baseGenre) return alert("Select a base genre first.");
            
            state.genreCat = ""; // Reset main cat or find it
            // Find category
            for(const cat in GENRES) {
                if(GENRES[cat].includes(baseGenre)) { state.genreCat = cat; break; }
            }
            state.subgenres = [baseGenre];
            
            // Mock Dial Application
            updateAllVisuals();
            switchTab('style');
        }

        function loadPreset(name) {
            const p = PRESETS[name];
            if(p) {
                state.genreCat = p.genre; // Set category
                state.subgenres = [...p.subs];
                state.instruments = [...p.inst];
                state.production = [...p.prod];
                updateAllVisuals();
            }
        }

        // --- PROMPT ENGINE ---
        function updatePrompt() {
            state.tempo = document.getElementById('tempo-select').value;
            state.singerDescription = document.getElementById('singer-desc').value;
            state.exclusions = document.getElementById('exclusion-input').value;

            let list = [];
            if(state.genreCat) list.push(state.genreCat);
            if(state.subgenres.length) list.push(...state.subgenres);
            if(state.singerDescription) list.push("Vocals: " + state.singerDescription);
            if(state.voices.length) list.push(...state.voices);
            if(state.instruments.length) list.push(...state.instruments);
            if(state.moods.length) list.push(...state.moods);
            if(state.production.length) list.push(...state.production);
            if(state.tempo) list.push(state.tempo);

            // Platform rules
            const platform = document.getElementById('platform-select').value;
            let text = list.join(", ");
            if(platform === 'suno') text = PROMPT_PREFIX + text;
            
            if(state.exclusions) {
                text += (platform === 'suno' ? "\nNo " : ", No ") + state.exclusions;
            }

            document.getElementById('style-output').value = text;
            document.getElementById('char-count').textContent = text.length + "/200";
            
            // Conflict Check
            const conflictBox = document.getElementById('conflict-box');
            const fullText = (text + " " + state.exclusions).toLowerCase();
            const conflict = CONFLICTS.find(c => c.tags.every(t => fullText.includes(t.toLowerCase())));
            
            if(conflict) {
                conflictBox.textContent = conflict.msg;
                conflictBox.classList.remove('hidden');
            } else {
                conflictBox.classList.add('hidden');
            }
        }
        
        function updateExclusions(val) { state.exclusions = val; updatePrompt(); }
        
        function copyToClipboard(id, btn) {
            const el = document.getElementById(id);
            el.select(); document.execCommand('copy');
            const span = btn.querySelector('.btn-text');
            if(span) { const t = span.textContent; span.textContent = "Copied!"; setTimeout(() => span.textContent=t, 1500); }
        }

        // --- DATABASE OPS ---
        function saveArtistToDB() {
            const name = document.getElementById('builder-artist-name').value;
            if(!name) return alert("Artist Name Required");
            const tx = db.transaction("artists", "readwrite");
            tx.objectStore("artists").add({
                id: Date.now(),
                name: name,
                bio: document.getElementById('builder-artist-bio').value,
                exclusions: document.getElementById('builder-artist-exclusions').value,
                profile: JSON.parse(JSON.stringify(state))
            });
            tx.oncomplete = () => { alert("Artist Created"); renderArtists(); renderRoster(); switchTab('studio'); };
        }

        function renderArtists() {
            if(!db) return;
            const tx = db.transaction("artists", "readonly");
            const list = document.getElementById('studio-artist-list'); list.innerHTML = '';
            tx.objectStore("artists").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const d = document.createElement('div');
                    d.className = `p-2 rounded cursor-pointer ${selectedArtistId === c.value.id ? 'bg-indigo-50 text-indigo-700 font-bold' : 'hover:bg-slate-50'}`;
                    d.textContent = c.value.name;
                    d.onclick = () => { selectedArtistId = c.value.id; renderArtists(); renderAlbums(c.value.id); };
                    list.appendChild(d);
                    c.continue();
                }
            };
            renderRoster(); 
        }
        
        function renderRoster() {
             const list = document.getElementById('roster-list');
             if(!list) return;
             list.innerHTML = '';
             const tx = db.transaction("artists", "readonly");
             tx.objectStore("artists").openCursor().onsuccess = (e) => {
                 const c = e.target.result;
                 if(c) {
                     const d = document.createElement('div');
                     d.className = "p-2 border rounded text-sm";
                     d.textContent = c.value.name;
                     list.appendChild(d);
                     c.continue();
                 }
             }
        }

        function promptCreateAlbum() {
            if(!selectedArtistId) return alert("Select Artist First");
            const t = prompt("Album Title:");
            if(t) {
                const tx = db.transaction("albums", "readwrite");
                tx.objectStore("albums").add({ id: Date.now(), artistId: selectedArtistId, title: t });
                tx.oncomplete = () => renderAlbums(selectedArtistId);
            }
        }
        
        function renderAlbums(aid) {
             const list = document.getElementById('studio-album-list'); list.innerHTML = '';
             const tx = db.transaction("albums", "readonly");
             tx.objectStore("albums").index("artistId").openCursor(IDBKeyRange.only(aid)).onsuccess = (e) => {
                 const c = e.target.result;
                 if(c) {
                     const d = document.createElement('div');
                     d.className = `p-2 rounded cursor-pointer ${selectedAlbumId === c.value.id ? 'bg-indigo-50 text-indigo-700 font-bold' : 'hover:bg-slate-50'}`;
                     d.textContent = c.value.title;
                     d.onclick = () => { selectedAlbumId = c.value.id; renderAlbums(aid); renderSongs(c.value.id); };
                     list.appendChild(d);
                     c.continue();
                 }
             }
        }

        function renderSongs(albid) {
            const list = document.getElementById('studio-song-list'); list.innerHTML = '';
             const tx = db.transaction("songs", "readonly");
             tx.objectStore("songs").index("albumId").openCursor(IDBKeyRange.only(albid)).onsuccess = (e) => {
                 const c = e.target.result;
                 if(c) {
                     const s = c.value;
                     const d = document.createElement('div');
                     d.className = "bg-white border rounded p-3 mb-2 shadow-sm";
                     
                     let versions = '';
                     if(s.versions) {
                         versions = s.versions.map(v => `<a href="${v.link}" target="_blank" class="text-xs text-indigo-500 hover:underline mr-2">${v.name}</a>`).join("");
                     }

                     d.innerHTML = `
                         <div class="flex justify-between">
                             <div class="font-bold">${s.title}</div>
                             <button onclick="openVersionModal(${s.id})" class="text-[10px] border px-1 rounded hover:bg-slate-50">+Ver</button>
                         </div>
                         <div class="text-xs text-slate-500 truncate mb-1">${s.prompt}</div>
                         <div class="flex items-center gap-2">
                             <button onclick="loadSongState(${s.id})" class="text-[10px] text-indigo-600 font-bold hover:underline">Load</button>
                             ${versions}
                         </div>
                     `;
                     list.appendChild(d);
                     c.continue();
                 }
             }
        }

        // --- SAVING ---
        function promptSaveSong() {
            document.getElementById('save-modal').classList.remove('hidden');
            const sel = document.getElementById('save-artist-select'); sel.innerHTML = "<option>Select Artist...</option>";
            const tx = db.transaction("artists", "readonly");
            tx.objectStore("artists").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const o = document.createElement('option'); o.value = c.value.id; o.textContent = c.value.name; sel.appendChild(o);
                    c.continue();
                }
            }
        }
        
        function populateSaveAlbums() {
             const aid = parseInt(document.getElementById('save-artist-select').value);
             const sel = document.getElementById('save-album-select'); sel.innerHTML = "<option>Select Album...</option>";
             const tx = db.transaction("albums", "readonly");
             tx.objectStore("albums").index("artistId").openCursor(IDBKeyRange.only(aid)).onsuccess = (e) => {
                 const c = e.target.result;
                 if(c) {
                    const o = document.createElement('option'); o.value = c.value.id; o.textContent = c.value.title; sel.appendChild(o);
                    c.continue();
                 }
             }
        }

        function commitSaveSong() {
             const aid = parseInt(document.getElementById('save-artist-select').value);
             const albid = parseInt(document.getElementById('save-album-select').value);
             const title = document.getElementById('save-song-title').value;
             const link = document.getElementById('save-song-link').value;
             if(!albid || !title) return alert("Missing fields");
             
             const v = link ? [{ name: "Initial", link }] : [];
             
             const tx = db.transaction("songs", "readwrite");
             tx.objectStore("songs").add({
                 id: Date.now(), albumId: albid, title: title,
                 prompt: document.getElementById('style-output').value,
                 state: JSON.parse(JSON.stringify(state)),
                 lyrics: document.getElementById('lyrics-input').value,
                 link: link,
                 versions: v,
                 notes: document.getElementById('save-song-notes').value,
                 timestamp: Date.now()
             });
             tx.oncomplete = () => { document.getElementById('save-modal').classList.add('hidden'); alert("Saved"); renderSongs(albid); switchTab('studio'); };
        }

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-btn-${id}`).classList.add('active');
            
            if(id === 'studio') renderArtists();
            // Refresh visuals if navigating to blueprint
            if(id === 'style') updateAllVisuals();
        }

        // --- UTILS ---
        function updateAllVisuals() {
            // Re-run init category UI logic to refresh highlights
            initCatList('genre-cats', 'genre-container', GENRES, 'genreCat', true);
            initCatList('instrument-cats', 'instruments-container', INSTRUMENT_GROUPS, 'instruments');
            initCatList('mood-cats', 'moods-container', MOOD_GROUPS, 'moods');
            initCatList('prod-cats', 'production-container', PRODUCTION_GROUPS, 'production');
            renderList('voices-container', VOICES, 'voices');
            
            document.getElementById('singer-desc').value = state.singerDescription;
            document.getElementById('exclusion-input').value = state.exclusions;
            updatePrompt();
        }

        function loadSongState(id) {
            const tx = db.transaction("songs", "readonly");
            tx.objectStore("songs").get(id).onsuccess = (e) => {
                const s = e.target.result;
                state = s.state;
                document.getElementById('lyrics-input').value = s.lyrics;
                updateAllVisuals();
                switchTab('style');
            }
        }

        function closeModal() { document.getElementById('save-modal').classList.add('hidden'); }
        function openVersionModal(id) { document.getElementById('version-song-id').value = id; document.getElementById('version-modal').classList.remove('hidden'); }
        function closeVersionModal() { document.getElementById('version-modal').classList.add('hidden'); }
        function commitAddVersion() {
            const id = parseInt(document.getElementById('version-song-id').value);
            const name = document.getElementById('version-label').value;
            const link = document.getElementById('version-link').value;
            const tx = db.transaction("songs", "readwrite");
            const store = tx.objectStore("songs");
            store.get(id).onsuccess = (e) => {
                const s = e.target.result;
                if(!s.versions) s.versions = [];
                s.versions.push({ name, link });
                store.put(s).onsuccess = () => { closeVersionModal(); renderStudioSongs(s.albumId); };
            }
        }
        
        function validateAndLoadModels() { alert("Simulated Model Load"); }
        function generateLyrics() { alert("Simulated AI Generation"); }
        function copyToClipboard(id) { navigator.clipboard.writeText(document.getElementById(id).value); }

    </script>
</body>
</html>
