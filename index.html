<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno Engineer's Companion v3.1</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)" rel="stylesheet">
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap)" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #334155; border-radius: 2px;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }
        
        .nav-item.active {
            background-color: rgba(99, 102, 241, 0.1);
            border-left: 3px solid #6366f1;
            color: #fff;
        }
        .nav-item {
            border-left: 3px solid transparent;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }

        /* Tooltip */
        #tooltip {
            position: absolute;
            z-index: 100;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            max-width: 250px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .has-meta {
            border-color: #818cf8 !important; /* Indigo-400 */
            position: relative;
        }
        .has-meta::after {
            content: '';
            position: absolute;
            top: -3px;
            right: -3px;
            width: 8px;
            height: 8px;
            background: #6366f1;
            border: 1px solid #0f172a;
            border-radius: 50%;
        }
        .tab-btn.active {
            border-bottom: 2px solid #6366f1;
            color: white;
        }
        .tab-btn {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen flex overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col flex-shrink-0 z-20">
        <div class="p-5 border-b border-slate-800">
            <h1 class="font-bold text-lg tracking-tight text-indigo-400 flex items-center gap-2">
                <i class="fa-solid fa-wave-square"></i> Sonic Shift <span class="text-[10px] bg-slate-800 text-slate-400 px-1.5 rounded ml-auto">v3.1</span>
            </h1>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="app.navigate('artists')" id="nav-artists" class="nav-item w-full text-left px-5 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-900 transition-all flex items-center gap-3">
                <i class="fa-solid fa-users w-5 text-center"></i> Artists
            </button>
            <button onclick="app.navigate('styles')" id="nav-styles" class="nav-item w-full text-left px-5 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-900 transition-all flex items-center gap-3">
                <i class="fa-solid fa-sliders w-5 text-center"></i> Style Manager
            </button>
        </nav>

        <!-- Context Summary (Active Session) -->
        <div id="sidebar-context" class="p-4 border-t border-slate-800 bg-slate-900/50 hidden">
            <div class="text-[10px] font-bold text-slate-500 uppercase mb-2">Active Session</div>
            <div id="ctx-artist" class="text-xs font-medium text-white truncate mb-1"></div>
            <div id="ctx-album" class="text-xs text-slate-400 truncate mb-1"></div>
            <div id="ctx-song" class="text-xs text-indigo-400 truncate"></div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative overflow-hidden" id="main-content">
        <!-- Views will be injected here -->
    </main>

    <!-- Global Tooltip -->
    <div id="tooltip"></div>

    <!-- Hidden Textarea for Copy -->
    <textarea id="fallback-clipboard" style="position: absolute; left: -9999px;"></textarea>

    <!-- Generic Modal -->
    <div id="generic-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-[500px] p-6 transform transition-all scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Title</h3>
            <div id="modal-content"></div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-800">
                <button onclick="app.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-bold bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg shadow-lg transition-colors">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Data & Utils ---
        const TAG_LIBRARY = {
            "Instruments": {
                "Guitar": ["Acoustic Guitar", "Electric Guitar", "Distorted Guitar", "Clean Electric", "Wah-Wah", "Slide Guitar", "Pedal Steel", "12-String Guitar", "Djent Guitar", "Fuzz Guitar", "Palm Muted", "Guitar Solo"],
                "Strings": ["Violin", "Cello", "Viola", "Double Bass", "Fiddle", "String Quartet", "Orchestral Strings", "Pizzicato", "Tremolo", "Harp"],
                "Keys & Synth": ["Piano", "Grand Piano", "Rhodes Piano", "Wurlitzer", "Hammond B3", "Harpsichord", "Analog Synth", "Modular Synth", "Sawtooth Lead", "Synth Pad", "Arpeggiator", "Moog Bass", "Mellotron"],
                "Drums": ["Drum Kit", "Electronic Drums", "808", "909", "Breakbeat", "Blast Beat", "Congas", "Bongos", "Trap Beats", "Lo-fi Beats", "Drum Machine"],
                "Vocals": ["Male Vocals", "Female Vocals", "Choir", "Gospel Choir", "Whisper", "Screaming", "Growling", "Rap", "Autotune", "Falsetto", "Ethereal Vocals", "Raspy"]
            },
            "Genre": {
                "Electronic": ["Techno", "House", "Deep House", "Trance", "Dubstep", "DnB", "Synthwave", "Vaporwave", "Ambient", "Industrial", "Hardstyle", "Glitch Hop"],
                "Rock/Metal": ["Rock", "Hard Rock", "Heavy Metal", "Black Metal", "Death Metal", "Punk", "Grunge", "Shoegaze", "Post-Rock", "Prog Rock", "Indie Rock"],
                "Urban/R&B": ["Hip Hop", "Trap", "Boom Bap", "Drill", "R&B", "Neo-Soul", "Funk", "Soul", "Disco", "Afrobeat", "Phonk"],
                "Pop": ["Pop", "K-Pop", "J-Pop", "Synth-Pop", "Dream Pop", "Hyperpop", "Bedroom Pop", "Art Pop"],
                "Roots": ["Folk", "Country", "Bluegrass", "Blues", "Jazz", "Bebop", "Swing", "Reggae", "Ska", "Bossa Nova"],
                "Cinematic": ["Classical", "Baroque", "Cinematic", "Epic", "Film Score", "Trailer Music", "Opera", "Avant-garde"]
            },
            "Vibe": {
                "Dark": ["Dark", "Eerie", "Gloomy", "Gothic", "Aggressive", "Chaotic", "Tense", "Haunting", "Ominous", "Industrial"],
                "Bright": ["Happy", "Joyful", "Uplifting", "Euphoric", "Optimistic", "Playful", "Funky", "Groovy", "Energetic"],
                "Chill": ["Chill", "Relaxed", "Mellow", "Soothing", "Peaceful", "Dreamy", "Ethereal", "Atmospheric", "Spacious"],
                "Emotional": ["Sad", "Melancholic", "Bittersweet", "Nostalgic", "Sentimental", "Romantic", "Yearning", "Raw"]
            },
            "Production": {
                "Texture": ["Lo-fi", "Hi-fi", "Clean", "Crisp", "Muddy", "Raw", "Gritty", "Polished", "Warm", "Cold", "Vinyl Crackle"],
                "Effects": ["Reverb", "Delay", "Distortion", "Fuzz", "Chorus", "Flanger", "Sidechain", "Compression", "Bitcrushed"],
                "Spatial": ["Wide Stereo", "Mono", "Surround", "Close Mic", "Stadium Sound", "Intimate", "Wall of Sound"]
            }
        };

        const generateID = () => {
             return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // --- 2. Database (IndexedDB) ---
        class DB {
            constructor() {
                this.dbName = 'SunoCompanionDB_v3';
                this.version = 2; // Upgraded for tag_metadata
                this.db = null;
            }
            async connect() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, this.version);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('artists')) db.createObjectStore('artists', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('albums')) {
                            const store = db.createObjectStore('albums', { keyPath: 'id' });
                            store.createIndex('artistId', 'artistId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('songs')) {
                            const store = db.createObjectStore('songs', { keyPath: 'id' });
                            store.createIndex('albumId', 'albumId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('styles')) db.createObjectStore('styles', { keyPath: 'id' });
                        // New in v3.1: Tag Intelligence
                        if (!db.objectStoreNames.contains('tag_metadata')) db.createObjectStore('tag_metadata', { keyPath: 'tagName' });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                    req.onerror = (e) => reject(e);
                });
            }
            // Generic CRUD helpers
            async getAll(storeName) { return this.tx(storeName, 'readonly', store => store.getAll()); }
            async get(storeName, id) { return this.tx(storeName, 'readonly', store => store.get(id)); }
            async put(storeName, item) { return this.tx(storeName, 'readwrite', store => store.put(item)); }
            async delete(storeName, id) { return this.tx(storeName, 'readwrite', store => store.delete(id)); }
            tx(storeName, mode, callback) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, mode);
                    const req = callback(tx.objectStore(storeName));
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }
        }

        // --- 3. App Logic ---
        class App {
            constructor() {
                this.db = new DB();
                this.state = {
                    view: 'artists', 
                    artistId: null, albumId: null, songId: null,
                    wsTab: 'lyrics' // lyrics, notes
                };
                this.cache = { artists: [], albums: [], songs: [], styles: [], tagMeta: {} };
                this.init();
            }

            async init() {
                await this.db.connect();
                await this.refreshCache();
                this.navigate('artists');
                this.setupTooltip();
            }

            async refreshCache() {
                this.cache.artists = await this.db.getAll('artists');
                this.cache.albums = await this.db.getAll('albums');
                this.cache.songs = await this.db.getAll('songs');
                this.cache.styles = await this.db.getAll('styles');
                const metas = await this.db.getAll('tag_metadata');
                // Convert array to map for easy lookup
                this.cache.tagMeta = {};
                metas.forEach(m => this.cache.tagMeta[m.tagName] = m);
            }

            // --- Navigation & Routing ---
            navigate(view, params = {}) {
                this.state.view = view;
                if (params.artistId) this.state.artistId = params.artistId;
                if (params.albumId) this.state.albumId = params.albumId;
                if (params.songId) this.state.songId = params.songId;
                
                this.updateSidebar();
                this.render();
            }

            updateSidebar() {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                if (this.state.view === 'artists' || this.state.view.includes('artist') || this.state.view.includes('album') || this.state.view === 'workstation') {
                    document.getElementById('nav-artists').classList.add('active');
                } else if (this.state.view === 'styles') {
                    document.getElementById('nav-styles').classList.add('active');
                }

                // Update Context Block
                const ctx = document.getElementById('sidebar-context');
                if (this.state.artistId) {
                    ctx.classList.remove('hidden');
                    const artist = this.cache.artists.find(a => a.id === this.state.artistId);
                    document.getElementById('ctx-artist').textContent = artist ? artist.name : '';
                    
                    const album = this.state.albumId ? this.cache.albums.find(a => a.id === this.state.albumId) : null;
                    document.getElementById('ctx-album').textContent = album ? album.title : '';
                    
                    const song = this.state.songId ? this.cache.songs.find(s => s.id === this.state.songId) : null;
                    document.getElementById('ctx-song').textContent = song ? song.title : '';
                } else {
                    ctx.classList.add('hidden');
                }
            }

            render() {
                const container = document.getElementById('main-content');
                container.innerHTML = '';
                
                switch (this.state.view) {
                    case 'artists': this.renderArtistsList(container); break;
                    case 'artist-detail': this.renderArtistDetail(container); break;
                    case 'album-detail': this.renderAlbumDetail(container); break;
                    case 'workstation': this.renderWorkstation(container); break;
                    case 'styles': this.renderStyleManager(container); break;
                }
            }

            // --- Views ---

            renderArtistsList(container) {
                const artists = this.cache.artists.sort((a,b) => b.createdAt - a.createdAt);
                
                let html = `
                    <div class="p-8 fade-in h-full overflow-y-auto">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h2 class="text-3xl font-bold text-white mb-2">Artists</h2>
                                <p class="text-slate-400 text-sm">Manage your roster, genres, and discographies.</p>
                            </div>
                            <button onclick="app.modalAddArtist()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> New Artist
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${artists.map(a => {
                                const styleName = this.getStyleName(a.defaultStyleId);
                                const albumCount = this.cache.albums.filter(al => al.artistId === a.id).length;
                                return `
                                <div onclick="app.navigate('artist-detail', {artistId: '${a.id}'})" class="group bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-indigo-500/50 hover:bg-slate-800/50 cursor-pointer transition-all">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl font-bold text-white">
                                            ${a.name.substring(0,2).toUpperCase()}
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-slate-600 group-hover:text-indigo-400 transition-colors"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-white mb-1">${a.name}</h3>
                                    <div class="text-sm text-slate-400 mb-4">${a.genre || 'No genre set'}</div>
                                    <div class="flex items-center justify-between text-xs text-slate-500 border-t border-slate-800 pt-4">
                                        <span><i class="fa-solid fa-compact-disc mr-1"></i> ${albumCount} Albums</span>
                                        <span>${styleName}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                        ${artists.length === 0 ? `<div class="text-center text-slate-500 mt-20">No artists yet. Create one to get started.</div>` : ''}
                    </div>
                `;
                container.innerHTML = html;
            }

            renderArtistDetail(container) {
                const artist = this.cache.artists.find(a => a.id === this.state.artistId);
                if (!artist) return this.navigate('artists');
                const albums = this.cache.albums.filter(a => a.artistId === artist.id).sort((a,b) => b.year - a.year);
                const styleName = this.getStyleName(artist.defaultStyleId);

                container.innerHTML = `
                    <div class="flex flex-col h-full fade-in">
                        <!-- Header -->
                        <div class="h-48 bg-gradient-to-r from-slate-900 to-indigo-950 border-b border-slate-800 p-8 flex flex-col justify-end relative">
                            <button onclick="app.navigate('artists')" class="absolute top-6 left-6 text-slate-400 hover:text-white mb-4 flex items-center gap-2 text-sm font-medium transition-colors">
                                <i class="fa-solid fa-arrow-left"></i> Back to Artists
                            </button>
                            <h1 class="text-4xl font-bold text-white mb-2">${artist.name}</h1>
                            <div class="flex items-center gap-6 text-sm text-slate-300">
                                <span class="bg-slate-800/50 px-2 py-1 rounded border border-slate-700">${artist.genre || 'No Genre'}</span>
                                <span class="flex items-center gap-2"><i class="fa-solid fa-sliders text-indigo-400"></i> Base Style: ${styleName}</span>
                            </div>
                        </div>

                        <!-- Albums Grid -->
                        <div class="flex-1 overflow-y-auto p-8 bg-slate-900">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-white">Discography</h3>
                                <button onclick="app.modalAddAlbum('${artist.id}')" class="text-sm bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded border border-slate-700 transition-colors">
                                    <i class="fa-solid fa-plus mr-1"></i> Add Album
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                ${albums.map(al => `
                                    <div onclick="app.navigate('album-detail', {albumId: '${al.id}'})" class="bg-slate-950 border border-slate-800 p-4 rounded-lg hover:border-indigo-500/50 cursor-pointer group transition-all">
                                        <div class="aspect-square bg-slate-900 rounded mb-3 flex items-center justify-center text-slate-700 group-hover:text-slate-600">
                                            <i class="fa-solid fa-music text-4xl"></i>
                                        </div>
                                        <div class="font-bold text-white truncate">${al.title}</div>
                                        <div class="text-xs text-slate-500">${al.year} • ${this.getSongCount(al.id)} Songs</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAlbumDetail(container) {
                const album = this.cache.albums.find(a => a.id === this.state.albumId);
                if (!album) return this.navigate('artists');
                const artist = this.cache.artists.find(a => a.id === album.artistId);
                const songs = this.cache.songs.filter(s => s.albumId === album.id).sort((a,b) => a.order - b.order);
                const styleName = this.getStyleName(album.defaultStyleId) || 'Inherit Artist';

                container.innerHTML = `
                    <div class="flex flex-col h-full fade-in">
                        <div class="bg-slate-900 border-b border-slate-800 p-6 flex items-center justify-between shrink-0">
                            <div class="flex items-center gap-4">
                                <button onclick="app.navigate('artist-detail', {artistId: '${artist.id}'})" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400 transition-colors">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </button>
                                <div>
                                    <div class="text-xs text-indigo-400 font-bold uppercase tracking-wider mb-1">${artist.name}</div>
                                    <h1 class="text-2xl font-bold text-white">${album.title} <span class="text-slate-500 font-normal ml-2 text-lg">(${album.year})</span></h1>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-500 bg-slate-950 px-3 py-1 rounded border border-slate-800">Style: ${styleName}</span>
                                <button onclick="app.modalAddSong('${album.id}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold text-sm shadow-lg transition-colors">
                                    <i class="fa-solid fa-plus mr-1"></i> New Song
                                </button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-2 bg-slate-900">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-950 text-xs font-bold text-slate-500 uppercase">
                                    <tr>
                                        <th class="p-3 w-16 text-center">#</th>
                                        <th class="p-3">Title</th>
                                        <th class="p-3">Style / BPM</th>
                                        <th class="p-3 w-24 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm text-slate-300 divide-y divide-slate-800">
                                    ${songs.map((s, idx) => `
                                        <tr class="hover:bg-slate-800/50 group transition-colors">
                                            <td class="p-3 text-center text-slate-500 font-mono">${idx + 1}</td>
                                            <td class="p-3">
                                                <a onclick="app.navigate('workstation', {songId: '${s.id}'})" class="font-bold text-white hover:text-indigo-400 cursor-pointer block">${s.title}</a>
                                            </td>
                                            <td class="p-3 text-slate-400">
                                                ${s.styleId ? '<i class="fa-solid fa-bookmark text-indigo-500 mr-1"></i> ' + this.getStyleName(s.styleId) : (s.customTags && s.customTags.length > 0 ? 'Custom' : 'Inherited')}
                                                <span class="ml-2 opacity-50 text-xs">${s.bpm ? s.bpm + ' BPM' : ''}</span>
                                            </td>
                                            <td class="p-3 text-right">
                                                <button onclick="app.moveSong('${s.id}', -1)" class="text-slate-600 hover:text-white px-1"><i class="fa-solid fa-arrow-up"></i></button>
                                                <button onclick="app.moveSong('${s.id}', 1)" class="text-slate-600 hover:text-white px-1"><i class="fa-solid fa-arrow-down"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                             ${songs.length === 0 ? `<div class="text-center text-slate-500 mt-10">No songs yet.</div>` : ''}
                        </div>
                    </div>
                `;
            }

            renderWorkstation(container) {
                const song = this.cache.songs.find(s => s.id === this.state.songId);
                if (!song) return this.navigate('artists');
                const album = this.cache.albums.find(a => a.id === song.albumId);
                
                let activeTags = song.customTags || [];
                let activeBpm = song.bpm || 120;
                
                // Tabs Logic
                const isLyrics = this.state.wsTab === 'lyrics';
                
                container.innerHTML = `
                    <div class="flex h-full fade-in">
                        <!-- Left Panel -->
                        <div class="flex-1 flex flex-col border-r border-slate-800 min-w-[50%]">
                            
                            <!-- Header / Tabs -->
                            <div class="h-12 border-b border-slate-800 bg-slate-950 flex items-center px-4 justify-between shrink-0">
                                <div class="flex items-center gap-4 text-sm">
                                    <button onclick="app.navigate('album-detail', {albumId: '${album.id}'})" class="text-slate-500 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                                    <div class="flex gap-4 ml-2">
                                        <button onclick="app.setWsTab('lyrics')" class="tab-btn pb-3 ${isLyrics ? 'active' : ''} text-xs font-bold uppercase tracking-wide transition-colors">Lyrics</button>
                                        <button onclick="app.setWsTab('notes')" class="tab-btn pb-3 ${!isLyrics ? 'active' : ''} text-xs font-bold uppercase tracking-wide transition-colors">Session Notes</button>
                                    </div>
                                </div>
                                <div class="flex gap-1 ${!isLyrics ? 'invisible' : ''}">
                                    ${['Intro','Verse','Chorus','Bridge','Outro'].map(t => 
                                        `<button onclick="app.insertLyricTag('[${t}]')" class="px-2 py-0.5 bg-slate-800 hover:bg-slate-700 text-[10px] rounded border border-slate-700 text-slate-300 transition-colors">[${t}]</button>`
                                    ).join('')}
                                </div>
                            </div>

                            <!-- Content Area -->
                            <div class="flex-1 bg-slate-900 relative">
                                <textarea id="lyrics-editor" class="absolute inset-0 w-full h-full bg-slate-900 p-6 text-slate-200 font-mono text-sm resize-none focus:outline-none focus:bg-slate-800/30 transition-colors ${!isLyrics ? 'hidden' : ''}" placeholder="Enter lyrics here...">${song.lyrics || ''}</textarea>
                                <textarea id="notes-editor" class="absolute inset-0 w-full h-full bg-slate-900 p-6 text-indigo-100 font-mono text-sm resize-none focus:outline-none focus:bg-slate-800/30 transition-colors ${isLyrics ? 'hidden' : ''}" placeholder="Log generation notes, mix issues, or prompt adjustments here...">${song.notes || ''}</textarea>
                            </div>

                            <div class="p-3 border-t border-slate-800 bg-slate-950 flex justify-between">
                                <button onclick="app.saveWorkstation()" id="save-btn" class="text-xs font-bold text-indigo-400 hover:text-white transition-colors">Save Changes</button>
                                <button onclick="app.copyLyrics()" class="text-xs text-slate-500 hover:text-white"><i class="fa-regular fa-copy"></i> Copy Lyrics</button>
                            </div>
                        </div>

                        <!-- Right: Style -->
                        <div class="w-[450px] flex flex-col bg-slate-900">
                            <!-- Style Preview / Prompt -->
                            <div class="p-4 bg-slate-950 border-b border-slate-800 shrink-0">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wide block">Active Prompt</label>
                                    <span class="text-[10px] text-slate-500 italic">Right-click tags to annotate</span>
                                </div>
                                <div id="active-prompt-display" class="bg-slate-900 border border-slate-800 rounded p-3 text-sm text-indigo-300 font-medium mb-3 min-h-[3rem]"></div>
                                <div class="flex gap-2">
                                    <button onclick="app.copyPrompt()" id="copy-prompt-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded text-xs font-bold shadow-lg transition-colors">
                                        <i class="fa-regular fa-copy mr-1"></i> Copy Prompt
                                    </button>
                                    <select id="style-preset-select" onchange="app.applyPresetStyle(this.value)" class="bg-slate-800 text-xs text-white border border-slate-700 rounded px-2 outline-none w-1/3">
                                        <option value="">-- Load Preset --</option>
                                        ${this.cache.styles.map(st => `<option value="${st.id}">${st.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Tag Builder Component -->
                            <div class="flex-1 overflow-hidden flex flex-col" id="style-builder-container">
                                <!-- Injected via JS -->
                            </div>
                        </div>
                    </div>
                `;

                // Initialize Tag Builder
                this.renderTagBuilder(document.getElementById('style-builder-container'), activeTags, activeBpm, (tags, bpm) => {
                    song.customTags = tags;
                    song.bpm = bpm;
                    this.updatePromptDisplay(tags, bpm);
                });
                
                // Add event listeners
                document.getElementById('lyrics-editor').addEventListener('input', (e) => { song.lyrics = e.target.value; });
                document.getElementById('notes-editor').addEventListener('input', (e) => { song.notes = e.target.value; });
                
                this.updatePromptDisplay(activeTags, activeBpm);
            }

            setWsTab(tab) {
                this.state.wsTab = tab;
                this.render(); // Re-render to toggle visibility
            }

            renderStyleManager(container) {
                container.innerHTML = `
                    <div class="flex h-full fade-in">
                        <!-- List -->
                        <div class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col">
                            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                                <h2 class="text-sm font-bold text-white uppercase">Saved Styles</h2>
                                <button onclick="app.createStyle()" class="text-xs bg-indigo-600 px-2 py-1 rounded text-white hover:bg-indigo-500"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                ${this.cache.styles.map(s => `
                                    <button onclick="app.editStyle('${s.id}')" class="w-full text-left px-3 py-2 rounded text-sm text-slate-300 hover:bg-slate-800 hover:text-white transition-colors truncate">
                                        <i class="fa-solid fa-tag text-slate-600 mr-2"></i>${s.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <!-- Editor Area -->
                        <div class="flex-1 bg-slate-900 flex flex-col" id="style-editor-area">
                            <div class="flex-1 flex items-center justify-center text-slate-500">Select a style to edit or create new.</div>
                        </div>
                    </div>
                `;
            }

            // --- Components ---

            renderTagBuilder(container, initialTags, initialBpm, onChange) {
                let activeCat = Object.keys(TAG_LIBRARY)[0];
                let tags = [...initialTags]; // Local copy
                let bpm = initialBpm;

                const render = () => {
                    const activeSubCats = TAG_LIBRARY[activeCat];
                    container.innerHTML = `
                        <div class="flex flex-1 min-h-0">
                            <!-- Categories -->
                            <div class="w-24 bg-slate-950 border-r border-slate-800 overflow-y-auto shrink-0">
                                ${Object.keys(TAG_LIBRARY).map(cat => `
                                    <button onclick="document.getElementById('cat-${cat}').click()" id="cat-${cat}" class="w-full text-left px-2 py-3 text-[10px] font-bold uppercase hover:bg-slate-800 ${activeCat === cat ? 'text-indigo-400 bg-slate-900 border-l-2 border-indigo-500' : 'text-slate-500 border-l-2 border-transparent'}">
                                        ${cat}
                                    </button>
                                `).join('')}
                            </div>
                            <!-- Subcats & Tags -->
                            <div class="flex-1 overflow-y-auto p-4 bg-slate-900">
                                ${Object.entries(activeSubCats).map(([sub, tagList]) => `
                                    <div class="mb-4">
                                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b border-slate-800 pb-1">${sub}</h4>
                                        <div class="flex flex-wrap gap-2">
                                            ${tagList.map(t => {
                                                const isActive = tags.includes(t);
                                                const meta = this.cache.tagMeta[t];
                                                const hasMeta = !!meta;
                                                return `<button class="tag-btn text-xs px-2 py-1 rounded border transition-all 
                                                    ${isActive ? 'bg-indigo-600 text-white border-indigo-500 shadow-md transform scale-105' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'} 
                                                    ${hasMeta ? 'has-meta' : ''}" 
                                                    data-tag="${t}">${t}</button>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <!-- BPM & Custom -->
                        <div class="h-auto border-t border-slate-800 bg-slate-950 p-4 shrink-0">
                            <div class="flex items-center gap-4 mb-3">
                                <label class="text-xs font-bold text-slate-500">BPM: <span id="bpm-val" class="text-indigo-400">${bpm}</span></label>
                                <input type="range" min="60" max="200" value="${bpm}" class="flex-1" id="bpm-input">
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="custom-tag" placeholder="Add custom tag..." class="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-1 text-xs text-white focus:border-indigo-500 outline-none">
                                <button id="add-custom-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1 rounded text-xs border border-slate-700"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    `;

                    // Listeners
                    container.querySelectorAll('[id^="cat-"]').forEach(btn => {
                        btn.addEventListener('click', () => { activeCat = btn.id.replace('cat-', ''); render(); });
                    });
                    
                    container.querySelectorAll('.tag-btn').forEach(btn => {
                        const t = btn.dataset.tag;
                        
                        // Click to toggle
                        btn.addEventListener('click', () => {
                            if (tags.includes(t)) tags = tags.filter(x => x !== t);
                            else tags.push(t);
                            onChange(tags, bpm);
                            render();
                        });

                        // Right-Click to Annotate
                        btn.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            app.modalAnnotateTag(t);
                        });

                        // Tooltip
                        btn.addEventListener('mouseenter', (e) => app.showTooltip(e, t));
                        btn.addEventListener('mouseleave', () => app.hideTooltip());
                    });
                    
                    const bpmIn = container.querySelector('#bpm-input');
                    bpmIn.addEventListener('input', (e) => {
                        bpm = parseInt(e.target.value);
                        container.querySelector('#bpm-val').textContent = bpm;
                        onChange(tags, bpm);
                    });
                    
                    const addCustom = () => {
                        const val = container.querySelector('#custom-tag').value.trim();
                        if (val && !tags.includes(val)) {
                            tags.push(val);
                            onChange(tags, bpm);
                            render();
                        }
                    };
                    container.querySelector('#add-custom-btn').addEventListener('click', addCustom);
                };
                render();
            }

            // --- Tooltip & Modals ---
            showTooltip(e, tagName) {
                const meta = this.cache.tagMeta[tagName];
                if (!meta) return;
                
                const tt = document.getElementById('tooltip');
                const stars = '★'.repeat(meta.rating || 0);
                tt.innerHTML = `<div class="font-bold text-indigo-400 mb-1">${tagName} <span class="text-yellow-500 text-[10px] ml-1">${stars}</span></div><div class="opacity-90 leading-snug">${meta.notes}</div>`;
                tt.style.display = 'block';
                tt.style.left = e.pageX + 10 + 'px';
                tt.style.top = e.pageY + 10 + 'px';
            }
            
            hideTooltip() {
                document.getElementById('tooltip').style.display = 'none';
            }

            modalAnnotateTag(tagName) {
                const modal = document.getElementById('generic-modal');
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').textContent = `Tag Intelligence: ${tagName}`;
                
                const meta = this.cache.tagMeta[tagName] || { rating: 3, notes: '' };

                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Effectiveness Rating</label>
                            <input type="range" id="m-rating" min="1" max="5" value="${meta.rating}" class="w-full">
                            <div class="flex justify-between text-[10px] text-slate-500 px-1"><span>1</span><span>5</span></div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Engineer's Notes</label>
                            <textarea id="m-notes" rows="4" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-indigo-500 outline-none placeholder-slate-600 text-sm">${meta.notes}</textarea>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-confirm-btn').onclick = async () => {
                    const rating = parseInt(document.getElementById('m-rating').value);
                    const notes = document.getElementById('m-notes').value;
                    await this.db.put('tag_metadata', { tagName, rating, notes, updatedAt: Date.now() });
                    await this.refreshCache();
                    this.closeModal();
                    this.render(); // Re-render to show indicators
                };
                modal.classList.remove('hidden');
            }

            // --- Logic Actions ---

            getStyleName(id) {
                if (!id) return '';
                const s = this.cache.styles.find(x => x.id === id);
                return s ? s.name : 'Unknown Style';
            }

            getSongCount(albumId) {
                return this.cache.songs.filter(s => s.albumId === albumId).length;
            }

            updatePromptDisplay(tags, bpm) {
                const el = document.getElementById('active-prompt-display');
                if (!el) return;
                const bpmText = bpm ? `${bpm} bpm` : '';
                const all = [...tags];
                if(bpmText) all.push(bpmText);
                el.textContent = all.join(', ');
            }

            // Modal Actions (Artist, Album, Song) reused from v3
            modalAddArtist() {
                const modal = document.getElementById('generic-modal');
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').textContent = "New Artist";
                content.innerHTML = `
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label><input type="text" id="m-name" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-indigo-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Genre</label><input type="text" id="m-genre" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-indigo-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Default Style</label><select id="m-style" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white outline-none"><option value="">None</option>${this.cache.styles.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                    </div>`;
                document.getElementById('modal-confirm-btn').onclick = async () => {
                    const name = document.getElementById('m-name').value;
                    const genre = document.getElementById('m-genre').value;
                    const style = document.getElementById('m-style').value;
                    if(name) { await this.db.put('artists', { id: generateID(), name, genre, defaultStyleId: style, createdAt: Date.now() }); await this.refreshCache(); this.closeModal(); this.render(); }
                };
                modal.classList.remove('hidden');
            }
            modalAddAlbum(artistId) {
                const modal = document.getElementById('generic-modal');
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').textContent = "New Album";
                content.innerHTML = `
                    <div class="space-y-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label><input type="text" id="m-title" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-indigo-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Year</label><input type="text" id="m-year" value="${new Date().getFullYear()}" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-indigo-500 outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Default Style (Optional)</label><select id="m-style" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white outline-none"><option value="">Use Artist Default</option>${this.cache.styles.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                    </div>`;
                document.getElementById('modal-confirm-btn').onclick = async () => {
                    const title = document.getElementById('m-title').value;
                    const year = document.getElementById('m-year').value;
                    const style = document.getElementById('m-style').value;
                    if(title) { await this.db.put('albums', { id: generateID(), artistId, title, year, defaultStyleId: style, createdAt: Date.now() }); await this.refreshCache(); this.closeModal(); this.render(); }
                };
                modal.classList.remove('hidden');
            }
            modalAddSong(albumId) {
                const album = this.cache.albums.find(a => a.id === albumId);
                const artist = this.cache.artists.find(a => a.id === album.artistId);
                const inheritedStyleId = album.defaultStyleId || artist.defaultStyleId;
                let inheritedTags = [], inheritedBpm = 120;
                if (inheritedStyleId) { const st = this.cache.styles.find(s => s.id === inheritedStyleId); if(st) { inheritedTags = st.tags; inheritedBpm = st.bpm; } }
                const modal = document.getElementById('generic-modal');
                const content = document.getElementById('modal-content');
                document.getElementById('modal-title').textContent = "New Song";
                content.innerHTML = `<div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Song Title</label><input type="text" id="m-title" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-indigo-500 outline-none"></div></div>`;
                document.getElementById('modal-confirm-btn').onclick = async () => {
                    const title = document.getElementById('m-title').value;
                    if(title) {
                        const existingSongs = this.cache.songs.filter(s => s.albumId === albumId);
                        await this.db.put('songs', { id: generateID(), albumId, title, order: existingSongs.length + 1, lyrics: '', notes: '', customTags: inheritedTags, bpm: inheritedBpm, createdAt: Date.now() });
                        await this.refreshCache(); this.closeModal(); this.render();
                    }
                };
                modal.classList.remove('hidden');
            }

            closeModal() { document.getElementById('generic-modal').classList.add('hidden'); }

            async moveSong(songId, dir) {
                const song = this.cache.songs.find(s => s.id === songId);
                const siblings = this.cache.songs.filter(s => s.albumId === song.albumId).sort((a,b) => a.order - b.order);
                const idx = siblings.findIndex(s => s.id === songId);
                if (idx + dir >= 0 && idx + dir < siblings.length) {
                    const swapSong = siblings[idx + dir];
                    const temp = song.order; song.order = swapSong.order; swapSong.order = temp;
                    await this.db.put('songs', song); await this.db.put('songs', swapSong);
                    await this.refreshCache(); this.render();
                }
            }

            async saveWorkstation() {
                const s = this.cache.songs.find(x => x.id === this.state.songId);
                if(s) {
                    await this.db.put('songs', s);
                    const btn = document.getElementById('save-btn');
                    btn.textContent = 'Saved!';
                    setTimeout(() => btn.textContent = 'Save Changes', 2000);
                }
            }

            applyPresetStyle(styleId) {
                const song = this.cache.songs.find(s => s.id === this.state.songId);
                const style = this.cache.styles.find(s => s.id === styleId);
                if (song && style) { song.customTags = [...style.tags]; song.bpm = style.bpm; this.render(); }
            }

            insertLyricTag(tag) {
                const ta = document.getElementById('lyrics-editor');
                const start = ta.selectionStart; const end = ta.selectionEnd; const txt = ta.value;
                ta.value = txt.substring(0, start) + (start > 0 && txt[start-1] !== '\n' ? '\n' : '') + tag + '\n' + txt.substring(end);
                ta.focus();
                const song = this.cache.songs.find(s => s.id === this.state.songId);
                if(song) song.lyrics = ta.value;
            }

            // Style Manager Logic
            editStyle(id) { const style = this.cache.styles.find(s => s.id === id); this.renderStyleEditor(style); }
            createStyle() { this.renderStyleEditor(null); }
            renderStyleEditor(style) {
                const container = document.getElementById('style-editor-area');
                const tempData = style ? { ...style } : { id: generateID(), name: 'New Style', tags: [], bpm: 120 };
                container.innerHTML = `
                    <div class="h-16 border-b border-slate-800 flex items-center px-6 justify-between bg-slate-950">
                        <input type="text" id="se-name" value="${tempData.name}" class="bg-transparent text-lg font-bold text-white border-b border-slate-700 focus:border-indigo-500 outline-none w-1/2">
                        <button onclick="app.saveStyleFromEditor('${tempData.id}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded font-bold text-sm shadow-lg">Save Style</button>
                    </div>
                    <div class="flex-1 overflow-hidden flex flex-col p-4" id="se-builder"></div>
                `;
                this.tempStyle = tempData;
                this.renderTagBuilder(document.getElementById('se-builder'), tempData.tags, tempData.bpm, (tags, bpm) => { this.tempStyle.tags = tags; this.tempStyle.bpm = bpm; });
                document.getElementById('se-name').addEventListener('input', (e) => this.tempStyle.name = e.target.value);
            }
            async saveStyleFromEditor(id) { await this.db.put('styles', this.tempStyle); await this.refreshCache(); this.render(); }

            // Clipboard
            safeCopy(text) { const el = document.getElementById('fallback-clipboard'); el.value = text; el.select(); document.execCommand('copy'); }
            copyPrompt() {
                const song = this.cache.songs.find(s => s.id === this.state.songId);
                const tags = song.customTags || []; const bpm = song.bpm ? `${song.bpm} bpm` : '';
                this.safeCopy([...tags, bpm].join(', '));
                const btn = document.getElementById('copy-prompt-btn');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!'; setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy mr-1"></i> Copy Prompt', 2000);
            }
            copyLyrics() { const song = this.cache.songs.find(s => s.id === this.state.songId); this.safeCopy(song.lyrics); }
        }

        const app = new App();
    </script>
</body>
</html>
