<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno Engineer's Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar for "Pro App" feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #374151;
            border-radius: 2px;
        }

        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- Sidebar: Song List -->
    <aside class="w-64 bg-gray-950 border-r border-gray-800 flex flex-col flex-shrink-0 z-20">
        <div class="p-4 border-b border-gray-800 flex items-center justify-between">
            <h1 class="font-bold text-lg tracking-tight text-indigo-400"><i class="fa-solid fa-wave-square mr-2"></i>Sonic Shift</h1>
        </div>
        
        <div class="p-2">
            <button onclick="app.createNewSong()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded text-sm font-medium transition-colors flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> New Song
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 pb-2 space-y-1" id="song-list">
            <!-- Song items will be injected here -->
        </div>
        
        <div class="p-3 border-t border-gray-800 text-xs text-gray-500 text-center">
            Suno Engineer's Companion v1.1
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-gray-900 relative">
        
        <!-- Top Bar: Metadata -->
        <header class="h-16 bg-gray-900 border-b border-gray-800 flex items-center px-6 gap-4 shrink-0 z-10 shadow-sm">
            <div class="flex-1 grid grid-cols-12 gap-4">
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Song Title</label>
                    <input type="text" id="meta-title" placeholder="Untitled Song" 
                           class="w-full bg-transparent border-b border-gray-700 focus:border-indigo-500 text-lg font-semibold text-white placeholder-gray-600 outline-none transition-colors pb-1">
                </div>
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Artist</label>
                    <input type="text" id="meta-artist" placeholder="Artist Name" 
                           class="w-full bg-transparent border-b border-gray-700 focus:border-indigo-500 text-sm text-gray-300 placeholder-gray-600 outline-none transition-colors pb-1">
                </div>
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Album</label>
                    <input type="text" id="meta-album" placeholder="Album Name" 
                           class="w-full bg-transparent border-b border-gray-700 focus:border-indigo-500 text-sm text-gray-300 placeholder-gray-600 outline-none transition-colors pb-1">
                </div>
            </div>
            <div class="flex items-center gap-2 border-l border-gray-800 pl-4">
                <button onclick="app.deleteCurrentSong()" class="text-gray-500 hover:text-red-400 transition-colors p-2" title="Delete Song">
                    <i class="fa-solid fa-trash"></i>
                </button>
                <div id="save-status" class="text-xs text-green-500 font-medium opacity-0 transition-opacity">Saved</div>
            </div>
        </header>

        <!-- Work Area -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- Left Panel: Lyrics Editor -->
            <section class="flex-1 flex flex-col border-r border-gray-800 min-w-[350px]">
                <!-- Toolbar -->
                <div class="h-12 border-b border-gray-800 bg-gray-900 flex items-center px-4 gap-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <span class="text-xs font-bold text-gray-500 mr-2">STRUCT:</span>
                    <button onclick="app.insertTag('[Intro]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Intro]</button>
                    <button onclick="app.insertTag('[Verse]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Verse]</button>
                    <button onclick="app.insertTag('[Chorus]')" class="px-2 py-1 bg-indigo-900/50 hover:bg-indigo-900/80 text-xs rounded text-indigo-200 border border-indigo-800 transition-colors">[Chorus]</button>
                    <button onclick="app.insertTag('[Bridge]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Bridge]</button>
                    <button onclick="app.insertTag('[Pre-Chorus]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Pre-Chorus]</button>
                    <button onclick="app.insertTag('[Outro]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Outro]</button>
                    <button onclick="app.insertTag('[Instrumental]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Instr]</button>
                    <button onclick="app.insertTag('[Break]')" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 text-xs rounded text-gray-300 border border-gray-700 transition-colors">[Break]</button>
                </div>
                
                <!-- Editor -->
                <div class="flex-1 relative bg-gray-900">
                    <textarea id="lyrics-editor" class="w-full h-full bg-gray-900 p-6 text-gray-200 font-mono text-sm leading-relaxed outline-none resize-none focus:bg-gray-800/30 transition-colors" placeholder="Enter lyrics here... Use the toolbar to add structure tags."></textarea>
                    
                    <!-- Floating Copy Button for Lyrics -->
                    <button onclick="app.copyLyrics()" id="copy-lyrics-btn" class="absolute bottom-4 right-4 bg-gray-800 hover:bg-gray-700 text-gray-300 p-2 rounded-full shadow-lg border border-gray-700 transition-all opacity-50 hover:opacity-100" title="Copy Lyrics">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>
            </section>

            <!-- Right Panel: Style Manager -->
            <section class="w-96 flex flex-col bg-gray-950/50 flex-shrink-0 border-l border-gray-800">
                
                <!-- Active Style Prompt Area -->
                <div class="flex-shrink-0 p-4 border-b border-gray-800 bg-gray-900 z-10">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Style Prompt</h2>
                        <span id="char-count" class="text-xs text-gray-600">0 chars</span>
                    </div>
                    
                    <!-- Chips Container -->
                    <div id="active-tags-list" class="flex flex-wrap gap-2 mb-3 min-h-[40px]">
                        <span class="text-sm text-gray-600 italic py-2">Select tags below to build your prompt...</span>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="custom-tag-input" placeholder="Add custom tag..." class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-xs text-white focus:border-indigo-500 outline-none">
                        <button onclick="app.addCustomTag()" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 text-gray-300 px-3 py-1.5 rounded text-xs"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <button onclick="app.copyPrompt()" id="copy-prompt-btn" class="w-full mt-3 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white py-2 rounded shadow-lg text-sm font-semibold flex items-center justify-center gap-2 transition-all transform active:scale-95">
                        <i class="fa-regular fa-copy"></i> Copy Prompt to Clipboard
                    </button>
                </div>

                <!-- Tag Library Selector -->
                <div class="flex-1 flex flex-col min-h-0">
                    <!-- Library Tabs/Search -->
                    <div class="p-3 bg-gray-900 border-b border-gray-800">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-500 text-xs"></i>
                            <input type="text" id="tag-search" placeholder="Search genres, moods, instruments..." 
                                   class="w-full bg-gray-800 text-gray-200 text-xs rounded-full pl-8 pr-4 py-2 border border-gray-700 focus:border-indigo-500 outline-none">
                        </div>
                    </div>

                    <!-- Accordion Content -->
                    <div class="flex-1 overflow-y-auto p-2 space-y-2" id="tag-library">
                        <!-- Categories injected here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Tag Editor Modal (Popover) -->
    <div id="tag-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-2xl w-80 p-5 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-tag-name" class="text-lg font-bold text-white">Tag Name</h3>
                <button onclick="app.closeModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs text-gray-400 mb-2 uppercase">Rating (Effectiveness)</label>
                <div class="flex items-center gap-2">
                    <div class="flex text-yellow-500 text-lg" id="modal-stars">
                        <!-- Stars injected -->
                    </div>
                    <input type="range" id="modal-rating" min="0" max="5" step="1" class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    <span id="modal-rating-val" class="text-sm font-bold w-4 text-center">0</span>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs text-gray-400 mb-2 uppercase">Notes</label>
                <textarea id="modal-note" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-gray-200 outline-none focus:border-indigo-500 placeholder-gray-600" placeholder="E.g., Worked well with the bass drop..."></textarea>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="app.removeTagFromSong()" class="px-3 py-1.5 text-xs text-red-400 hover:text-red-300 border border-red-900/30 hover:bg-red-900/20 rounded">Remove Tag</button>
                <button onclick="app.saveTagEdits()" class="px-4 py-1.5 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded font-medium">Save</button>
            </div>
        </div>
    </div>

    <!-- Hidden Textarea for Fallback Copy -->
    <textarea id="fallback-clipboard" style="position: absolute; left: -9999px;"></textarea>

    <script>
        // --- 1. Tag Library Data ---
        const TAG_LIBRARY = {
            "Genres": [
                "Rock", "Hard Rock", "Metal", "Punk", "Indie Rock", "Alternative", "Grunge", "Shoegaze",
                "Pop", "Synth-Pop", "K-Pop", "J-Pop", "Dream Pop", "Hyperpop",
                "Electronic", "Techno", "House", "Deep House", "Drum and Bass", "Dubstep", "Trance", "Ambient", "IDM", "Synthwave", "Lo-Fi",
                "Hip Hop", "Rap", "Trap", "Boom Bap", "Drill", "Grime",
                "R&B", "Soul", "Funk", "Neo-Soul", "Disco", "Gospel",
                "Jazz", "Bebop", "Fusion", "Smooth Jazz", "Blues",
                "Folk", "Country", "Bluegrass", "Americana",
                "Classical", "Orchestral", "Baroque", "Opera", "Cinematic",
                "World", "Reggae", "Latin", "Salsa", "Afrobeat", "Bollywood", "Celtic"
            ],
            "Sub-Genres & Styles": [
                "Glitch Pop", "Chinese Opera", "Gregorian Chant", "Sea Shanty", "Vaporwave", "Cyberpunk",
                "Gothic", "Industrial", "Experimental", "Avant-garde", "Math Rock", "Post-Rock",
                "Chiptune", "8-bit", "Downtempo", "Chillout"
            ],
            "Mood & Atmosphere": [
                "Aggressive", "Angry", "Anxious", "Bittersweet", "Calm", "Chaotic", "Chill", 
                "Dark", "Dreamy", "Eerie", "Emotional", "Energetic", "Epic", "Ethereal", "Euphoric", 
                "Funky", "Gloomy", "Groovy", "Happy", "Haunting", "Hopeful", "Hypnotic", "Intense", 
                "Joyful", "Laid-back", "Melancholic", "Mellow", "Mysterious", "Nostalgic", "Optimistic", 
                "Peaceful", "Playful", "Powerful", "Psychedelic", "Relaxing", "Romantic", "Sad", 
                "Scary", "Sentimental", "Serene", "Sexy", "Soothing", "Spooky", "Suspenseful", 
                "Tense", "Uplifting", "Warm", "Weird", "Whimsical"
            ],
            "Instruments": [
                "Acoustic Guitar", "Electric Guitar", "Distorted Guitar", "Bass", "Slap Bass", "Synth Bass", "808",
                "Drums", "Drum Machine", "Breakbeat", "Percussion",
                "Piano", "Grand Piano", "Rhodes", "Synth", "Pad", "Arpeggiator",
                "Strings", "Violin", "Cello", "Orchestra",
                "Brass", "Trumpet", "Saxophone", "Flute",
                "Male Vocals", "Female Vocals", "Choir", "Autotune", "Whisper", "Raspy"
            ],
            "Production & Texture": [
                "Lo-fi", "High-fidelity", "Studio Quality", "Bedroom Pop", "Analog", "Digital",
                "Reverb", "Echo", "Delay", "Distortion", "Clean", "Crisp", "Muddy", "Raw",
                "Minimalist", "Maximalist", "Wall of Sound", "Surround", "Stereo", "Mono"
            ],
            "Tempo & Rhythm": [
                "Slow", "Medium", "Fast", "Upbeat", "Driving", "Steady", "Syncopated", "Swing", "Groove",
                "4/4", "3/4", "6/8", "Polyrhythm", "BPM: 90", "BPM: 120", "BPM: 140", "BPM: 174"
            ],
            "Era": [
                "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s", "2020s",
                "Vintage", "Retro", "Modern", "Futuristic", "Old School", "Medieval", "Ancient"
            ]
        };

        // --- 2. IndexedDB Wrapper ---
        class DB {
            constructor() {
                this.dbName = 'SunoCompanionDB';
                this.version = 1;
                this.storeName = 'songs';
                this.db = null;
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('updatedAt', 'updatedAt', { unique: false });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onerror = (event) => {
                        console.error("DB Error:", event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            async getAllSongs() {
                if (!this.db) await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const index = store.index('updatedAt');
                    const request = index.openCursor(null, 'prev'); // Sort by newest
                    const results = [];
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            results.push(cursor.value);
                            cursor.continue();
                        } else {
                            resolve(results);
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async saveSong(song) {
                if (!this.db) await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    song.updatedAt = Date.now();
                    const request = store.put(song);
                    request.onsuccess = () => resolve(song);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteSong(id) {
                if (!this.db) await this.connect();
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // --- 3. Application Logic ---
        class App {
            constructor() {
                this.db = new DB();
                this.songs = [];
                this.currentSong = null;
                this.editingTagIndex = -1;
                this.saveTimeout = null;

                // Bind UI Elements
                this.ui = {
                    songList: document.getElementById('song-list'),
                    title: document.getElementById('meta-title'),
                    artist: document.getElementById('meta-artist'),
                    album: document.getElementById('meta-album'),
                    lyrics: document.getElementById('lyrics-editor'),
                    activeTagsList: document.getElementById('active-tags-list'),
                    tagLibrary: document.getElementById('tag-library'),
                    tagSearch: document.getElementById('tag-search'),
                    charCount: document.getElementById('char-count'),
                    saveStatus: document.getElementById('save-status'),
                    customTagInput: document.getElementById('custom-tag-input'),
                    // Modal
                    modal: document.getElementById('tag-modal'),
                    modalName: document.getElementById('modal-tag-name'),
                    modalRating: document.getElementById('modal-rating'),
                    modalRatingVal: document.getElementById('modal-rating-val'),
                    modalNote: document.getElementById('modal-note'),
                    modalStars: document.getElementById('modal-stars'),
                    // Buttons for feedback
                    copyPromptBtn: document.getElementById('copy-prompt-btn'),
                    copyLyricsBtn: document.getElementById('copy-lyrics-btn')
                };

                this.init();
            }

            async init() {
                try {
                    await this.db.connect();
                    await this.refreshSongList();
                    this.renderTagLibrary();
                    
                    // If songs exist, load the first one (most recent), else create new
                    if (this.songs.length > 0) {
                        this.loadSong(this.songs[0]);
                    } else {
                        this.createNewSong();
                    }

                    this.setupEventListeners();
                } catch (e) {
                    console.error("Initialization Failed:", e);
                    alert("App failed to initialize. Please check console or try reloading.");
                }
            }

            // Helper for generating IDs safely in non-secure contexts (iframe preview)
            generateID() {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    try {
                        return crypto.randomUUID();
                    } catch (e) {
                        // Fallback below
                    }
                }
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Robust copy to clipboard (execCommand for iframes)
            safeCopy(text, btnElement) {
                const fallback = document.getElementById('fallback-clipboard');
                fallback.value = text;
                fallback.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if(successful) {
                        this.showCopyFeedback(btnElement);
                    } else {
                        console.error('Copy failed');
                    }
                } catch (err) {
                    console.error('Unable to copy', err);
                }
                
                // Clear selection
                window.getSelection().removeAllRanges();
            }

            showCopyFeedback(btn) {
                if(!btn) return;
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            }

            setupEventListeners() {
                // Metadata & Lyrics Input Listeners for Auto-Save
                const inputs = [this.ui.title, this.ui.artist, this.ui.album, this.ui.lyrics];
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.handleInput());
                });

                // Tag Search
                this.ui.tagSearch.addEventListener('input', (e) => this.filterLibrary(e.target.value));

                // Modal Rating Slider
                this.ui.modalRating.addEventListener('input', (e) => {
                    this.ui.modalRatingVal.textContent = e.target.value;
                    this.renderModalStars(e.target.value);
                });

                // Custom tag enter key
                this.ui.customTagInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomTag();
                });
            }

            async refreshSongList() {
                this.songs = await this.db.getAllSongs();
                this.renderSongList();
            }

            createNewSong() {
                const newSong = {
                    id: this.generateID(), // Updated to use safe generator
                    title: '',
                    artist: '',
                    album: '',
                    lyrics: '',
                    styleTags: [], // { text: string, rating: number, note: string }
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                this.loadSong(newSong);
                this.saveCurrentSong(true); // Force save immediately
            }

            loadSong(song) {
                this.currentSong = song;
                
                // Update Inputs
                this.ui.title.value = song.title || '';
                this.ui.artist.value = song.artist || '';
                this.ui.album.value = song.album || '';
                this.ui.lyrics.value = song.lyrics || '';

                // Update UI state
                this.renderActiveTags();
                this.renderSongList(); // To highlight active
                this.updateCharCount();
            }

            handleInput() {
                if (!this.currentSong) return;
                
                // Update local state
                this.currentSong.title = this.ui.title.value;
                this.currentSong.artist = this.ui.artist.value;
                this.currentSong.album = this.ui.album.value;
                this.currentSong.lyrics = this.ui.lyrics.value;

                // Debounced Save
                this.triggerAutoSave();
            }

            triggerAutoSave() {
                this.ui.saveStatus.classList.remove('opacity-100');
                this.ui.saveStatus.classList.add('opacity-0');
                
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                
                this.saveTimeout = setTimeout(async () => {
                    await this.saveCurrentSong();
                }, 1000);
            }

            async saveCurrentSong(refreshList = true) {
                if (!this.currentSong) return;
                await this.db.saveSong(this.currentSong);
                
                // UI Feedback
                this.ui.saveStatus.textContent = "Saved";
                this.ui.saveStatus.classList.remove('opacity-0');
                this.ui.saveStatus.classList.add('opacity-100');
                
                if (refreshList) await this.refreshSongList();
            }

            async deleteCurrentSong() {
                if (!this.currentSong) return;
                if (confirm('Are you sure you want to delete this song?')) {
                    await this.db.deleteSong(this.currentSong.id);
                    await this.refreshSongList();
                    if (this.songs.length > 0) {
                        this.loadSong(this.songs[0]);
                    } else {
                        this.createNewSong();
                    }
                }
            }

            // --- UI Rendering ---

            renderSongList() {
                this.ui.songList.innerHTML = '';
                this.songs.forEach(song => {
                    const isActive = this.currentSong && this.currentSong.id === song.id;
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-lg cursor-pointer transition-all border border-transparent ${isActive ? 'bg-indigo-900/40 border-indigo-500/50' : 'hover:bg-gray-800 border-gray-800'}`;
                    el.onclick = () => this.loadSong(song);
                    
                    const title = song.title || 'Untitled Song';
                    const artist = song.artist || 'Unknown Artist';
                    
                    el.innerHTML = `
                        <div class="text-sm font-medium text-gray-200 truncate">${title}</div>
                        <div class="text-xs text-gray-500 truncate flex justify-between">
                            <span>${artist}</span>
                            <span>${new Date(song.updatedAt).toLocaleDateString()}</span>
                        </div>
                    `;
                    this.ui.songList.appendChild(el);
                });
            }

            renderTagLibrary() {
                this.ui.tagLibrary.innerHTML = '';
                
                Object.keys(TAG_LIBRARY).forEach(category => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mb-1';
                    
                    // Header
                    const header = document.createElement('button');
                    header.className = 'w-full text-left px-3 py-2 text-xs font-bold text-gray-400 uppercase tracking-wide bg-gray-900 hover:bg-gray-800 rounded flex justify-between items-center';
                    header.innerHTML = `<span>${category}</span> <i class="fa-solid fa-chevron-down text-gray-600"></i>`;
                    
                    // List
                    const list = document.createElement('div');
                    list.className = 'flex flex-wrap gap-1.5 p-2 pl-3';
                    
                    TAG_LIBRARY[category].forEach(tag => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2.5 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 rounded border border-gray-700 transition-colors tag-item';
                        btn.textContent = tag;
                        btn.dataset.tag = tag; // For search
                        btn.onclick = () => this.addTagToSong(tag);
                        list.appendChild(btn);
                    });

                    // Toggle functionality
                    header.onclick = () => {
                        list.classList.toggle('hidden');
                        header.querySelector('i').classList.toggle('rotate-180');
                    };

                    wrapper.appendChild(header);
                    wrapper.appendChild(list);
                    this.ui.tagLibrary.appendChild(wrapper);
                });
            }

            filterLibrary(query) {
                const q = query.toLowerCase();
                const headers = this.ui.tagLibrary.querySelectorAll('div > button'); // Category headers
                const items = this.ui.tagLibrary.querySelectorAll('.tag-item');
                
                items.forEach(item => {
                    const match = item.textContent.toLowerCase().includes(q);
                    item.style.display = match ? 'block' : 'none';
                });
            }

            renderActiveTags() {
                this.ui.activeTagsList.innerHTML = '';
                if (!this.currentSong.styleTags || this.currentSong.styleTags.length === 0) {
                    this.ui.activeTagsList.innerHTML = '<span class="text-sm text-gray-600 italic py-2">Select tags below to build your prompt...</span>';
                    this.updateCharCount();
                    return;
                }

                this.currentSong.styleTags.forEach((tagObj, index) => {
                    const chip = document.createElement('div');
                    
                    // Determine style based on rating
                    let bgClass = 'bg-gray-700 text-gray-200';
                    let borderClass = 'border-gray-600';
                    if (tagObj.rating >= 4) { bgClass = 'bg-indigo-900 text-indigo-100'; borderClass = 'border-indigo-700'; }
                    if (tagObj.rating <= 2 && tagObj.rating > 0) { bgClass = 'bg-red-900/30 text-red-200'; borderClass = 'border-red-900/50'; }

                    chip.className = `flex items-center gap-2 pl-3 pr-2 py-1.5 rounded-full text-xs border cursor-pointer hover:opacity-90 transition-all shadow-sm group ${bgClass} ${borderClass}`;
                    
                    const stars = this.getStarString(tagObj.rating);
                    const noteIcon = tagObj.note ? '<i class="fa-solid fa-sticky-note text-[10px] ml-1 opacity-70"></i>' : '';

                    chip.innerHTML = `
                        <span class="font-medium">${tagObj.text}</span>
                        ${noteIcon}
                        <span class="text-[10px] tracking-tighter opacity-70">${stars}</span>
                        <div class="w-px h-3 bg-white/20 mx-1"></div>
                        <i class="fa-solid fa-pen text-[10px] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    `;
                    
                    chip.onclick = () => this.openEditModal(index);
                    this.ui.activeTagsList.appendChild(chip);
                });

                this.updateCharCount();
            }

            updateCharCount() {
                const prompt = this.currentSong.styleTags.map(t => t.text).join(', ');
                this.ui.charCount.textContent = `${prompt.length} chars`;
                if (prompt.length > 120) {
                    this.ui.charCount.classList.add('text-red-500');
                    this.ui.charCount.classList.remove('text-gray-600');
                } else {
                    this.ui.charCount.classList.remove('text-red-500');
                    this.ui.charCount.classList.add('text-gray-600');
                }
            }

            getStarString(rating) {
                if (!rating) return '';
                return 'â˜…'.repeat(rating);
            }

            // --- Logic Actions ---

            addTagToSong(text) {
                if (!this.currentSong.styleTags.find(t => t.text === text)) {
                    this.currentSong.styleTags.push({ text: text, rating: 0, note: '' });
                    this.saveCurrentSong(false);
                    this.renderActiveTags();
                }
            }

            addCustomTag() {
                const val = this.ui.customTagInput.value.trim();
                if (val) {
                    this.addTagToSong(val);
                    this.ui.customTagInput.value = '';
                }
            }

            insertTag(tag) {
                const textarea = this.ui.lyrics;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                
                // Add newlines if needed
                const prefix = (start > 0 && text[start - 1] !== '\n') ? '\n\n' : '';
                const suffix = '\n';
                
                textarea.value = before + prefix + tag + suffix + after;
                
                // Reset cursor
                textarea.selectionStart = textarea.selectionEnd = start + prefix.length + tag.length + suffix.length;
                textarea.focus();
                
                this.handleInput();
            }

            copyPrompt() {
                const prompt = this.currentSong.styleTags.map(t => t.text).join(', ');
                this.safeCopy(prompt, this.ui.copyPromptBtn);
            }

            copyLyrics() {
                this.safeCopy(this.ui.lyrics.value, this.ui.copyLyricsBtn);
            }

            // --- Modal Logic ---

            openEditModal(index) {
                this.editingTagIndex = index;
                const tag = this.currentSong.styleTags[index];
                
                this.ui.modalName.textContent = tag.text;
                this.ui.modalRating.value = tag.rating || 0;
                this.ui.modalRatingVal.textContent = tag.rating || 0;
                this.renderModalStars(tag.rating || 0);
                this.ui.modalNote.value = tag.note || '';
                
                this.ui.modal.classList.remove('hidden');
            }

            closeModal() {
                this.ui.modal.classList.add('hidden');
                this.editingTagIndex = -1;
            }

            renderModalStars(rating) {
                let html = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) html += '<i class="fa-solid fa-star"></i>';
                    else html += '<i class="fa-regular fa-star text-gray-600"></i>';
                }
                this.ui.modalStars.innerHTML = html;
            }

            saveTagEdits() {
                if (this.editingTagIndex > -1) {
                    this.currentSong.styleTags[this.editingTagIndex].rating = parseInt(this.ui.modalRating.value);
                    this.currentSong.styleTags[this.editingTagIndex].note = this.ui.modalNote.value;
                    this.saveCurrentSong(false);
                    this.renderActiveTags();
                    this.closeModal();
                }
            }

            removeTagFromSong() {
                if (this.editingTagIndex > -1) {
                    this.currentSong.styleTags.splice(this.editingTagIndex, 1);
                    this.saveCurrentSong(false);
                    this.renderActiveTags();
                    this.closeModal();
                }
            }
        }

        // Initialize App
        const app = new App();

    </script>
</body>
</html>
