renderTagBuilder(container, initialTags, initialBpm, onChange) {
    let activeCat = Object.keys(TAG_LIBRARY)[0];
    let tags = [...initialTags];
    let bpm = initialBpm;

    // HELPER: Create safe IDs (removes spaces, &, etc)
    const safeId = (str) => 'cat-' + str.replace(/[^a-zA-Z0-9]/g, '');

    const render = () => {
        const activeSubCats = TAG_LIBRARY[activeCat];
        
        // Tag Chips
        const activeTagsHtml = tags.map(t => 
            `<span class="inline-flex items-center gap-1 bg-cyan-900/40 text-cyan-200 border border-cyan-500/30 px-2 py-1 rounded text-[10px] font-mono shadow-sm animate-[fadeIn_0.1s]">
                ${t} <button onclick="app.removeTag('${t}')" class="hover:text-white"><i class="fa-solid fa-times"></i></button>
            </span>`
        ).join('');

        container.innerHTML = `
            <div class="flex flex-1 min-h-0">
                <div class="w-20 bg-daw-panel border-r border-daw-border overflow-y-auto shrink-0 flex flex-col">
                    ${Object.keys(TAG_LIBRARY).map(cat => 
                        // USE safeId HERE
                        `<button id="${safeId(cat)}" class="w-full text-center py-4 text-[9px] font-bold uppercase hover:bg-daw-surface transition-colors flex flex-col items-center gap-1 ${activeCat === cat ? 'text-cyan-400 bg-daw-bg border-l-2 border-cyan-500' : 'text-daw-muted border-l-2 border-transparent'}">
                            <i class="fa-solid fa-${cat.includes('Instruments') ? 'guitar' : cat.includes('Vibe') ? 'cloud' : cat.includes('Genre') ? 'music' : 'microphone'} text-lg mb-1"></i>
                            ${cat.split(' ')[0]}
                        </button>`
                    ).join('')}
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-daw-bg">
                    <div class="mb-4 flex flex-wrap gap-2 min-h-[40px] p-2 bg-daw-surface/50 rounded border border-daw-border border-dashed">
                        ${activeTagsHtml || '<span class="text-[10px] text-daw-muted italic self-center">No modules active...</span>'}
                    </div>

                    ${Object.entries(activeSubCats).map(([sub, tagList]) => `
                        <div class="mb-5">
                            <h4 class="text-[10px] font-bold text-daw-muted uppercase mb-2 border-b border-daw-border pb-1">${sub}</h4>
                            <div class="grid grid-cols-2 gap-2">
                                ${tagList.map(t => {
                                    const isActive = tags.includes(t);
                                    return `<button class="tag-btn text-[10px] text-left px-2 py-1.5 rounded border transition-all truncate ${isActive ? 'bg-cyan-600 text-white border-cyan-500' : 'bg-daw-surface text-daw-muted border-daw-border hover:border-daw-muted'}" data-tag="${t}">${t}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="h-auto border-t border-daw-border bg-daw-panel p-4 shrink-0">
                <div class="flex items-center gap-3 mb-3 bg-daw-surface p-2 rounded border border-daw-border">
                    <div class="w-10 h-10 rounded-full border-2 border-cyan-500 flex items-center justify-center text-[10px] font-bold text-white bg-daw-bg shadow-[0_0_10px_rgba(6,182,212,0.3)]">${bpm}</div>
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-daw-muted uppercase block mb-1">Tempo (BPM)</label>
                        <input type="range" min="60" max="200" value="${bpm}" class="w-full" id="bpm-input">
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="custom-tag" placeholder="Custom module..." class="flex-1 bg-daw-bg border border-daw-border rounded px-3 py-1 text-xs text-white outline-none focus:border-cyan-500 font-mono">
                    <button id="add-custom-btn" class="bg-daw-surface hover:bg-daw-border text-white px-3 py-1 rounded text-xs border border-daw-border"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        `;

        // Re-attach listeners using safeId
        Object.keys(TAG_LIBRARY).forEach(cat => {
            const btn = container.querySelector(`#${safeId(cat)}`);
            if(btn) btn.addEventListener('click', () => { activeCat = cat; render(); });
        });

        // Other listeners
        container.querySelectorAll('.tag-btn').forEach(btn => btn.addEventListener('click', () => { 
            const t = btn.dataset.tag; 
            if (tags.includes(t)) tags = tags.filter(x => x !== t); else tags.push(t); 
            onChange(tags, bpm); render(); 
        }));
        container.querySelector('#bpm-input').addEventListener('input', (e) => { 
            bpm = parseInt(e.target.value); 
            onChange(tags, bpm);
            container.querySelector('.rounded-full').textContent = bpm;
        });
        container.querySelector('#add-custom-btn').addEventListener('click', () => { 
            const val = container.querySelector('#custom-tag').value.trim(); 
            if (val && !tags.includes(val)) { tags.push(val); onChange(tags, bpm); render(); } 
        });
    };
    render();
}
