<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suno Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        
        body {
            overscroll-behavior: none; /* Prevent bounce effects on mobile */
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.2s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-selected {
            background-color: rgba(147, 51, 234, 0.2); /* purple-500/20 */
            border-color: rgb(168, 85, 247); /* purple-500 */
            color: rgb(233, 213, 255); /* purple-200 */
        }
        
        /* Confirmation state for clear button */
        .confirm-delete {
            background-color: rgba(220, 38, 38, 0.2) !important;
            color: #fca5a5 !important;
            border: 1px solid #ef4444 !important;
        }

        /* --- MIDI CONTROLLER STYLING --- */
        
        .midi-panel {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            box-shadow: 
                inset 0 1px 1px rgba(255,255,255,0.1),
                0 10px 20px rgba(0,0,0,0.5);
            border-radius: 12px;
            border: 1px solid #334155;
            position: relative;
        }

        /* Screws for the panel look */
        .screw {
            width: 10px;
            height: 10px;
            background: #334155;
            border-radius: 50%;
            position: absolute;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.8), 1px 1px 0 rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .screw::after {
            content: '';
            width: 60%;
            height: 2px;
            background: #1e293b;
            transform: rotate(45deg);
        }
        .screw-tl { top: 10px; left: 10px; }
        .screw-tr { top: 10px; right: 10px; }
        .screw-bl { bottom: 10px; left: 10px; }
        .screw-br { bottom: 10px; right: 10px; }

        /* Fader Track */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
            touch-action: none; /* CRITICAL FOR MOBILE: Prevents scrolling while dragging */
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #020617; /* Very dark slate */
            border-radius: 4px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Fader Cap */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 14px;
            border-radius: 2px;
            background: linear-gradient(to bottom, #475569, #1e293b);
            cursor: pointer;
            margin-top: -9px; /* Center on track */
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.3);
            border: 1px solid #0f172a;
            position: relative;
        }

        /* Pad Button Styling */
        .pad-btn {
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 #1e293b, 0 5px 5px rgba(0,0,0,0.3);
            transform: translateY(0);
        }
        .pad-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1e293b, inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .pad-btn.active-pad {
            background-color: rgba(168, 85, 247, 0.2);
            border-color: #a855f7;
            color: #d8b4fe;
            box-shadow: 
                0 0 10px #a855f7, 
                0 4px 0 #581c87, 
                inset 0 0 10px rgba(168, 85, 247, 0.2);
        }
        .pad-btn.active-pad:active {
            box-shadow: 0 0 15px #a855f7, inset 0 0 10px rgba(168, 85, 247, 0.5);
        }
        
        /* Filter Chips */
        .filter-chip {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #334155;
            color: #94a3b8;
            border: 1px solid #475569;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover {
            background: #475569;
            color: #e2e8f0;
        }
        .filter-chip.active-filter {
            background: #7e22ce; /* purple-700 */
            color: white;
            border-color: #a855f7;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.4);
        }

    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans selection:bg-purple-500 selection:text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-20 shadow-xl">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center space-x-3">
                <div class="bg-gradient-to-br from-purple-600 to-indigo-600 p-2 rounded shadow-lg shadow-purple-900/40 ring-1 ring-white/10">
                    <i data-lucide="music" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-100 tracking-tight">
                        Suno Architect
                    </h1>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <p class="text-[10px] uppercase tracking-widest text-slate-500 font-semibold">System Online</p>
                    </div>
                </div>
            </div>
            <div class="flex space-x-1 bg-slate-800/50 rounded-lg p-1 overflow-x-auto border border-slate-700/50">
                <button onclick="switchTab('artist')" id="tab-btn-artist" class="px-4 py-2 rounded text-sm font-medium transition-all bg-slate-700 text-white shadow-sm whitespace-nowrap">
                    <i data-lucide="users" class="w-4 h-4 inline mr-1 mb-0.5"></i> Artist
                </button>
                <button onclick="switchTab('dials')" id="tab-btn-dials" class="px-4 py-2 rounded text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                    <i data-lucide="sliders-horizontal" class="w-4 h-4 inline mr-1 mb-0.5"></i> Style Tuner
                </button>
                <button onclick="switchTab('style')" id="tab-btn-style" class="px-4 py-2 rounded text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                    <i data-lucide="layout-grid" class="w-4 h-4 inline mr-1 mb-0.5"></i> Blueprint
                </button>
                <button onclick="switchTab('lyrics')" id="tab-btn-lyrics" class="px-4 py-2 rounded text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                    <i data-lucide="mic-2" class="w-4 h-4 inline mr-1 mb-0.5"></i> Lyrics
                </button>
                <button onclick="switchTab('library')" id="tab-btn-library" class="px-4 py-2 rounded text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                    <i data-lucide="save" class="w-4 h-4 inline mr-1 mb-0.5"></i> Library
                </button>
                <button onclick="switchTab('json')" id="tab-btn-json" class="px-4 py-2 rounded text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                    <i data-lucide="code" class="w-4 h-4 inline mr-1 mb-0.5"></i> JSON
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 w-full flex-grow">
        
        <!-- TAB: ARTIST BUILDER -->
        <div id="tab-artist" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Artist Creator Panel -->
                <div class="lg:col-span-6 space-y-6">
                    <div class="midi-panel p-6">
                        <div class="screw screw-tl"></div>
                        <div class="screw screw-tr"></div>
                        <div class="screw screw-bl"></div>
                        <div class="screw screw-br"></div>

                        <div class="flex items-center space-x-2 mb-6 border-b border-slate-700/50 pb-2">
                             <div class="w-3 h-3 bg-pink-500 rounded-full shadow-[0_0_10px_#ec4899]"></div>
                             <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400">Artist Builder</h2>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Band / Artist Name</label>
                                <input type="text" id="artist-name" placeholder="e.g., Neon Horizon" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-pink-500 font-bold tracking-wide">
                            </div>
                            
                            <div>
                                <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Bio / Notes (Optional)</label>
                                <textarea id="artist-bio" placeholder="Signature sound notes..." class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-slate-400 text-xs h-20 resize-none focus:outline-none focus:border-pink-500"></textarea>
                            </div>

                            <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-800">
                                <h4 class="text-xs font-bold text-slate-300 uppercase mb-3 flex items-center">
                                    <i data-lucide="music-2" class="w-3 h-3 mr-2"></i> Current Sound Profile
                                </h4>
                                <div class="space-y-2 text-xs font-mono text-slate-400" id="artist-preview-stats">
                                    <!-- JS populated -->
                                    <p class="italic text-slate-600">Configure settings in "Style Tuner" or "Blueprint" first...</p>
                                </div>
                            </div>

                            <button onclick="saveArtist()" class="pad-btn w-full py-3 rounded bg-pink-600 border border-pink-500 text-white font-bold uppercase tracking-wider text-xs hover:bg-pink-500 transition-colors shadow-lg shadow-pink-900/20">
                                Capture Current Sound as Artist
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Artist Roster -->
                <div class="lg:col-span-6">
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 h-full">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-pink-400"></i>
                            Artist Roster
                        </h3>
                        <div id="artist-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                            <!-- JS Populated -->
                            <div class="text-center py-10 text-slate-500 italic">
                                No artists created yet. Use the Builder to save a sound profile.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: STYLE TUNER (DIALS) -->
        <div id="tab-dials" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Controls -->
                <div class="lg:col-span-7 space-y-6 pb-10">
                    
                    <!-- Base Foundation Panel -->
                    <div class="midi-panel p-6">
                        <div class="screw screw-tl"></div>
                        <div class="screw screw-tr"></div>
                        <div class="screw screw-bl"></div>
                        <div class="screw screw-br"></div>

                        <div class="flex items-center space-x-2 mb-4 border-b border-slate-700/50 pb-2">
                             <div class="w-3 h-3 bg-purple-500 rounded-full shadow-[0_0_10px_#a855f7]"></div>
                             <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400">Master Control</h2>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-slate-500 uppercase font-bold">Category Filter</label>
                                <span class="text-[10px] text-slate-600">Select a tag to filter genres</span>
                            </div>
                            
                            <!-- Genre Filter Chips -->
                            <div id="dial-category-filters" class="flex flex-wrap gap-2 max-h-28 overflow-y-auto custom-scrollbar p-1">
                                <!-- JS Injected -->
                            </div>

                            <select id="dial-genre-select" onchange="updateDials()" class="w-full bg-slate-950 border border-slate-700 rounded text-slate-300 text-sm px-3 py-3 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500/50 font-mono mt-2 shadow-inner">
                                <option value="">[ SELECT BASE GENRE ]</option>
                                <!-- JS Populated -->
                            </select>
                        </div>
                    </div>

                    <!-- Faders Panel -->
                    <div class="midi-panel p-6 pt-8">
                        <div class="screw screw-tl"></div>
                        <div class="screw screw-tr"></div>
                        <div class="screw screw-bl"></div>
                        <div class="screw screw-br"></div>

                        <div class="grid gap-8">
                            <!-- Weirdness Fader -->
                            <div class="relative">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-xs font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Innovation
                                    </label>
                                    <span id="tags-weirdness" class="text-[10px] font-mono text-purple-300 bg-purple-900/30 px-2 py-1 rounded border border-purple-500/20">Standard</span>
                                </div>
                                <input type="range" id="dial-weirdness" min="0" max="100" value="0" oninput="updateDials()">
                                <div class="flex justify-between text-[9px] text-slate-600 font-mono mt-1 uppercase">
                                    <span>Safe</span>
                                    <span>Weird</span>
                                </div>
                            </div>

                            <!-- Era Fader -->
                            <div class="relative">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="history" class="w-3 h-3"></i> Texture
                                    </label>
                                    <span id="tags-era" class="text-[10px] font-mono text-emerald-300 bg-emerald-900/30 px-2 py-1 rounded border border-emerald-500/20">Clean</span>
                                </div>
                                <input type="range" id="dial-era" min="0" max="100" value="50" oninput="updateDials()">
                                <div class="flex justify-between text-[9px] text-slate-600 font-mono mt-1 uppercase">
                                    <span>Vintage</span>
                                    <span>Future</span>
                                </div>
                            </div>

                            <!-- Intensity Fader -->
                            <div class="relative">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-xs font-bold text-yellow-400 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="zap" class="w-3 h-3"></i> Energy
                                    </label>
                                    <span id="tags-intensity" class="text-[10px] font-mono text-yellow-300 bg-yellow-900/30 px-2 py-1 rounded border border-yellow-500/20">Balanced</span>
                                </div>
                                <input type="range" id="dial-intensity" min="0" max="100" value="50" oninput="updateDials()">
                                <div class="flex justify-between text-[9px] text-slate-600 font-mono mt-1 uppercase">
                                    <span>Chill</span>
                                    <span>Hype</span>
                                </div>
                            </div>

                            <!-- Tempo Fader -->
                            <div class="relative">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-xs font-bold text-red-400 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="gauge" class="w-3 h-3"></i> BPM
                                    </label>
                                    <span id="tags-tempo" class="text-[10px] font-mono text-red-300 bg-red-900/30 px-2 py-1 rounded border border-red-500/20">Mid</span>
                                </div>
                                <input type="range" id="dial-tempo" min="0" max="100" value="50" oninput="updateDials()">
                                <div class="flex justify-between text-[9px] text-slate-600 font-mono mt-1 uppercase">
                                    <span>Slow</span>
                                    <span>Fast</span>
                                </div>
                            </div>
                            
                            <!-- Vocals Fader -->
                            <div class="relative">
                                <div class="flex justify-between items-end mb-2">
                                    <label class="text-xs font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                                        <i data-lucide="mic" class="w-3 h-3"></i> Voice
                                    </label>
                                    <span id="tags-vocals" class="text-[10px] font-mono text-blue-300 bg-blue-900/30 px-2 py-1 rounded border border-blue-500/20">Vocals</span>
                                </div>
                                <input type="range" id="dial-vocals" min="0" max="100" value="75" oninput="updateDials()">
                                <div class="flex justify-between text-[9px] text-slate-600 font-mono mt-1 uppercase">
                                    <span>Inst</span>
                                    <span>Full</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="lg:col-span-5">
                    <div class="sticky top-24 midi-panel p-6 shadow-2xl">
                        <div class="screw screw-tl"></div>
                        <div class="screw screw-tr"></div>
                        <div class="screw screw-bl"></div>
                        <div class="screw screw-br"></div>

                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-sm font-bold uppercase tracking-widest text-slate-300 flex items-center">
                                <span class="w-2 h-2 rounded-full bg-red-500 mr-2 shadow-[0_0_8px_red]"></span>
                                Output Monitor
                            </h3>
                        </div>
                        
                        <div class="bg-black/40 rounded-lg p-4 border border-slate-800 font-mono text-xs space-y-3 shadow-inner">
                            <!-- Genre Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-slate-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-slate-500 font-bold mb-0.5">Base</div>
                                    <div id="preview-genre" class="text-slate-300">Select Genre...</div>
                                </div>
                            </div>

                            <!-- Weirdness Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-purple-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-purple-600 font-bold mb-0.5">Innovation</div>
                                    <div id="preview-weirdness" class="text-purple-300">...</div>
                                </div>
                            </div>

                            <!-- Era Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-emerald-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-emerald-600 font-bold mb-0.5">Texture</div>
                                    <div id="preview-era" class="text-emerald-300">...</div>
                                </div>
                            </div>

                            <!-- Intensity Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-yellow-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-yellow-600 font-bold mb-0.5">Energy</div>
                                    <div id="preview-intensity" class="text-yellow-300">...</div>
                                </div>
                            </div>

                            <!-- Tempo Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-red-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-red-600 font-bold mb-0.5">Speed</div>
                                    <div id="preview-tempo" class="text-red-300">...</div>
                                </div>
                            </div>

                            <!-- Vocals Block -->
                            <div class="flex items-start gap-3">
                                <div class="w-1 self-stretch bg-blue-600 rounded-full"></div>
                                <div>
                                    <div class="text-[9px] uppercase text-blue-600 font-bold mb-0.5">Vocals</div>
                                    <div id="preview-vocals" class="text-blue-300">...</div>
                                </div>
                            </div>
                        </div>

                        <button onclick="applyDialsToMain()" class="pad-btn mt-6 w-full py-4 rounded bg-slate-800 border border-slate-700 text-slate-300 font-bold uppercase tracking-wider text-xs hover:bg-slate-700 hover:text-white transition-colors relative overflow-hidden group">
                            <span class="relative z-10">Send to Blueprint</span>
                            <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SONIC BLUEPRINT -->
        <div id="tab-style" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left Column: Controls -->
                <div class="lg:col-span-7 space-y-8 pb-20">
                    
                    <!-- Genre Section -->
                    <section class="bg-slate-800/50 rounded-xl p-5 border border-slate-700">
                        <div class="flex items-center space-x-2 mb-4">
                            <i data-lucide="list-music" class="w-5 h-5 text-purple-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">1. The Foundation (Genre)</h2>
                        </div>
                        <div id="genre-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                            <!-- JS will inject genres here -->
                        </div>
                        <div id="subgenre-wrapper" class="hidden bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Subgenres (Select Multiple)</p>
                            <div id="subgenre-container" class="flex flex-wrap gap-2">
                                <!-- JS will inject subgenres here -->
                            </div>
                        </div>
                    </section>

                    <!-- Instruments & Voice -->
                    <section class="bg-slate-800/50 rounded-xl p-5 border border-slate-700">
                        <div class="flex items-center space-x-2 mb-4">
                            <i data-lucide="mic-vocal" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">2. The Players (Instruments & Voice)</h2>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Vocals</p>
                            <input type="text" id="singer-desc" placeholder="Specific Singer Definition (e.g. 'Raspy Male Baritone with Southern Accent')" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 mb-2 focus:outline-none focus:border-blue-500" oninput="updatePrompt()">
                            <div id="voices-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div>
                            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Instrumentation</p>
                            <div class="relative">
                                <input type="text" id="instrument-search" placeholder="Filter instruments..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 mb-3 focus:outline-none focus:border-blue-500">
                                <div id="instruments-container" class="flex flex-wrap gap-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Mood & Tempo -->
                    <section class="bg-slate-800/50 rounded-xl p-5 border border-slate-700">
                        <div class="flex items-center space-x-2 mb-4">
                            <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">3. Vibe & Grid (Mood & Tempo)</h2>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Mood / Atmosphere</p>
                            <div id="moods-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div>
                            <p class="text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Tempo & Feel</p>
                            <select id="tempo-select" onchange="updatePrompt()" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-500 text-slate-200">
                                <option value="">Select Tempo...</option>
                                <!-- JS Populated -->
                            </select>
                        </div>
                    </section>

                    <!-- Production -->
                    <section class="bg-slate-800/50 rounded-xl p-5 border border-slate-700">
                        <div class="flex items-center space-x-2 mb-4">
                            <i data-lucide="sliders-horizontal" class="w-5 h-5 text-emerald-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">4. The Engineer (Mix & Texture)</h2>
                        </div>
                        <div id="production-container" class="flex flex-wrap gap-2"></div>
                    </section>
                </div>

                <!-- Right Column: Sticky Output -->
                <div class="lg:col-span-5">
                    <div class="sticky top-24 bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white">Style Prompt</h3>
                            <div class="flex space-x-2">
                                <button onclick="saveCurrentPrompt()" class="p-2 text-slate-400 hover:text-green-400 transition-colors rounded" title="Save to Library">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-clear-all" onclick="clearAll()" class="p-2 text-slate-400 hover:text-red-400 transition-colors rounded" title="Clear All">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <div class="relative mb-4">
                            <textarea id="style-output" readonly class="w-full h-40 bg-slate-950 border border-slate-600 rounded-lg p-4 text-slate-200 font-mono text-sm leading-relaxed resize-none focus:outline-none focus:border-purple-500" placeholder="Use the Style Tuner tab or select options here..."></textarea>
                            <div id="char-count" class="absolute bottom-3 right-3 text-xs text-slate-500 bg-slate-950/80 px-2 py-1 rounded">
                                0/120 chars
                            </div>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button onclick="copyToClipboard('style-output', this)" class="w-full py-3 rounded-lg font-bold flex items-center justify-center space-x-2 transition-all bg-purple-600 hover:bg-purple-500 text-white group">
                                <i data-lucide="copy" class="w-5 h-5 group-hover:hidden"></i>
                                <i data-lucide="check" class="w-5 h-5 hidden group-[.copied]:block"></i>
                                <span class="btn-text">Copy Style Prompt</span>
                            </button>
                            
                            <div id="length-warning" class="hidden flex items-start space-x-2 text-amber-400 bg-amber-900/20 p-3 rounded-lg text-xs">
                                <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                <p>Your prompt is long (>120 chars). Suno works best with concise prompts.</p>
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-slate-700">
                            <h4 class="text-sm font-semibold text-slate-300 mb-2">Structure Preview</h4>
                            <p class="text-xs text-slate-400 mb-3">
                                Switch to the "Lyrics" tab to write your song content using metatags.
                            </p>
                            <button onclick="switchTab('lyrics')" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm rounded-lg transition-colors flex items-center justify-center space-x-2">
                                <span>Go to Lyrics Editor</span>
                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: LYRICS -->
        <div id="tab-lyrics" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-[calc(100vh-140px)] min-h-[600px]">
                <!-- Main Editor -->
               <div class="lg:col-span-8 h-full flex flex-col">
                 <div class="bg-slate-800 border border-slate-700 rounded-t-xl p-4 flex items-center justify-between">
                   <h2 class="font-semibold text-slate-200 flex items-center">
                     <i data-lucide="mic" class="w-4 h-4 mr-2 text-purple-400"></i>
                     Lyrics & Structure Editor
                   </h2>
                   
                   <!-- SAVE BUTTON ADDED HERE -->
                   <div class="flex items-center gap-2">
                        <button onclick="saveCurrentPrompt()" class="p-2 text-slate-400 hover:text-green-400 transition-colors rounded hover:bg-slate-700" title="Save to Library">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                        <div class="text-xs text-slate-400 hidden sm:block border-l border-slate-700 pl-2">
                            Use metatags to control flow
                        </div>
                   </div>
                 </div>
                 
                 <div class="flex-grow relative bg-slate-900 border-x border-slate-700">
                    <textarea id="lyrics-input" class="w-full h-full p-6 bg-transparent text-slate-200 font-mono text-sm leading-relaxed focus:outline-none resize-none" placeholder="[Intro]
[Instrumental Hook]

[Verse 1]
Write your lyrics here...
Use commas for short pauses,
And periods for longer stops.

[Chorus]
Make it catchy!

[Outro]"></textarea>
                 </div>
   
                 <div class="bg-slate-800 border border-slate-700 rounded-b-xl p-4 flex justify-between items-center">
                   <div class="text-xs text-slate-500 hidden sm:block">
                     Pro Tip: Use <span class="font-mono bg-slate-700 px-1 rounded text-slate-300">Da-a-shes</span> for melismas.
                   </div>
                   <button onclick="copyToClipboard('lyrics-input', this)" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm rounded-lg font-medium transition-colors flex items-center space-x-2">
                     <span class="btn-text">Copy Lyrics</span>
                   </button>
                 </div>
               </div>
   
               <!-- Toolbox -->
               <div class="lg:col-span-4 space-y-6 h-full overflow-y-auto pb-10">
                 
                 <!-- Magic Lyrics Generator -->
                 <div class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 rounded-xl p-5 shadow-lg">
                    <div class="flex items-center space-x-2 mb-4">
                        <i data-lucide="wand-2" class="w-5 h-5 text-indigo-400"></i>
                        <h3 class="font-semibold text-indigo-200">AI Lyric Generator</h3>
                    </div>
                    <div class="space-y-3">
                         <!-- Input Group -->
                         <div class="flex space-x-2">
                             <input type="password" id="api-key" placeholder="API Key" class="flex-grow bg-slate-900/80 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-indigo-500">
                             <button onclick="validateAndLoadModels()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300 transition-colors" title="Link Key & Load Valid Models">
                                 <i data-lucide="link" class="w-4 h-4"></i>
                             </button>
                         </div>
                         
                         <!-- Model Selector -->
                         <select id="ai-model" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 mb-2 focus:outline-none focus:border-indigo-500">
                             <option value="gemini-1.5-flash">Gemini 1.5 Flash (Default)</option>
                             <option value="gemini-pro">Gemini 1.0 Pro</option>
                         </select>

                         <input type="text" id="lyric-topic" placeholder="What is the song about? (e.g. Space Travel)" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 mb-2 focus:outline-none focus:border-indigo-500">
                         
                         <div class="grid grid-cols-1 gap-2">
                             <button onclick="generateLyrics('structure', event)" class="px-3 py-2 bg-indigo-600/50 hover:bg-indigo-600 border border-indigo-500/50 rounded-lg text-xs text-white transition-colors flex items-center justify-center gap-2">
                                 <i data-lucide="sparkles" class="w-3 h-3"></i> Generate Lyrics with Cues
                             </button>
                         </div>
                         <p class="text-[10px] text-indigo-300/60 mt-2 italic text-center">
                            Click ðŸ”— to load models valid for your key.
                         </p>
                    </div>
                 </div>

                 <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                   <div class="flex items-center space-x-2 mb-4">
                     <i data-lucide="layers" class="w-5 h-5 text-purple-400"></i>
                     <h3 class="font-semibold text-slate-200">Structure Tags</h3>
                   </div>
                   <div id="structure-tags-container" class="grid grid-cols-2 gap-2">
                       <!-- JS Injected -->
                   </div>
                 </div>
   
                 <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                   <div class="flex items-center space-x-2 mb-4">
                     <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                     <h3 class="font-semibold text-slate-200">Performance Cues</h3>
                   </div>
                   <div id="performance-tags-container" class="grid grid-cols-2 gap-2">
                        <!-- JS Injected -->
                   </div>
                 </div>
               </div>
             </div>
        </div>
        
        <!-- TAB: LIBRARY (IndexedDB) -->
        <div id="tab-library" class="tab-content">
             <div class="max-w-4xl mx-auto space-y-6 pb-20">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                        <i data-lucide="library" class="w-6 h-6 mr-2 text-blue-400"></i>
                        Saved Prompts
                    </h2>
                    <p class="text-sm text-slate-400 mb-6">
                        Prompts are saved locally in your browser. Click to load a prompt.
                    </p>
                    
                    <div id="library-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- JS populated -->
                        <div class="text-center py-10 text-slate-500 col-span-2 italic">
                            No saved prompts yet. Create a style and click the Save icon!
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- TAB: JSON OUTPUT -->
        <div id="tab-json" class="tab-content">
            <div class="max-w-4xl mx-auto space-y-8 pb-20">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                         <h2 class="text-xl font-bold text-white flex items-center">
                            <i data-lucide="code" class="w-6 h-6 mr-2 text-green-400"></i>
                            Prompt JSON
                        </h2>
                        <button onclick="copyToClipboard('json-output', this)" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg font-medium transition-colors flex items-center space-x-2">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="btn-text">Copy JSON</span>
                        </button>
                    </div>
                   
                    <p class="text-sm text-slate-400 mb-4">
                        This format includes structured metadata for archiving your prompt settings.
                    </p>

                    <div class="relative">
                        <textarea id="json-output" readonly class="w-full h-96 bg-slate-950 border border-slate-600 rounded-lg p-4 text-emerald-400 font-mono text-sm leading-relaxed resize-none focus:outline-none focus:border-green-500"></textarea>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA CONSTANTS ---
        const PROMPT_PREFIX = "[Is_MAX_MODE: MAX](MAX)\n[QUALITY: MAX](MAX)\n[REALISM: MAX](MAX)\n[REAL_INSTRUMENTS: MAX](MAX)\n";
        const LYRICS_PREFIX = "///*****///\n\n";

        const GENRES = {
            "Rock": [
                "Alternative Rock", "Art Rock", "Blues Rock", "Classic Rock", "Garage Rock", "Glam Rock", "Gothic Rock", "Grunge", "Hard Rock", "Indie Rock", 
                "Industrial Rock", "Math Rock", "Post-Rock", "Progressive Rock", "Psychedelic Rock", "Punk", "Rockabilly", "Shoegaze", "Soft Rock", "Southern Rock", 
                "Stoner Rock", "Surf Rock", "Yacht Rock", "Arena Rock", "Krautrock", "Noise Rock", "Slowcore", "Space Rock", "J-Rock", "Visual Kei"
            ],
            "Metal": [
                "Alternative Metal", "Black Metal", "Death Metal", "Deathcore", "Djent", "Doom Metal", "Drone Metal", "Folk Metal", "Glam Metal", "Gothic Metal", 
                "Grindcore", "Groove Metal", "Heavy Metal", "Industrial Metal", "Latin Metal", "Metalcore", "Nu Metal", "Power Metal", "Progressive Metal", 
                "Sludge Metal", "Speed Metal", "Symphonic Metal", "Thrash Metal", "Viking Metal", "Kawaii Metal", "Post-Metal", "Stoner Metal"
            ],
            "Electronic": [
                "Acid House", "Acid Techno", "Ambient", "Big Beat", "Breakbeat", "Chillstep", "Chillwave", "Chiptune", "Deep House", "Downtempo", "Drum and Bass", 
                "Dubstep", "Electro", "Electro-Swing", "Eurodance", "Future Bass", "Gabber", "Garage", "Glitch", "Glitch Hop", "Hardcore", "Hardstyle", "House", 
                "IDM", "Industrial", "Interstellar Synth", "Jungle", "Lo-Fi", "Melodic Techno", "Minimal", "Phonk", "Progressive House", "Psytrance", "Synth-Pop", 
                "Synthwave", "Tech House", "Techno", "Trance", "Trap", "Trip-Hop", "UK Garage", "Vaporwave", "Witch House"
            ],
            "Pop": [
                "Art Pop", "Baroque Pop", "Bedroom Pop", "Britpop", "Bubblegum Pop", "Chamber Pop", "City Pop", "Country-Pop", "Dance-Pop", "Dream Pop", "Electropop", 
                "Europop", "Hyperpop", "Indie Pop", "J-Pop", "K-Pop", "Latin Pop", "Power Pop", "Progressive Pop", "Psychedelic Pop", "Somber Pop", "Sophisti-Pop", 
                "Sunshine Pop", "Synth-Pop", "Teen Pop", "Wonky Pop"
            ],
            "Hip Hop": [
                "Abstract Hip Hop", "Alternative Hip Hop", "Boom Bap", "Cloud Rap", "Conscious Hip Hop", "Crunk", "Drill", "East Coast Hip Hop", "Experimental Hip Hop", 
                "G-Funk", "Gangsta Rap", "Grime", "Hardcore Hip Hop", "Horrorcore", "Jazz Rap", "Lyrical Hip Hop", "Mumble Rap", "Old School", "Pop Rap", "Trap", 
                "Trip Hop", "Turntablism", "UK Drill", "Underground Hip Hop", "West Coast Hip Hop"
            ],
            "R&B/Soul": [
                "Alternative R&B", "Blue-Eyed Soul", "Contemporary R&B", "Disco", "Doo-Wop", "Funk", "Gospel", "Modern Soul", "Motown", "Neo-Soul", "New Jack Swing", 
                "Northern Soul", "Psychedelic Soul", "Quiet Storm", "Soul", "Southern Soul", "P-Funk"
            ],
            "Jazz": [
                "Acid Jazz", "Afro-Cuban Jazz", "Atmospheric Jazz", "Avant-Garde Jazz", "Bebop", "Big Band", "Bossa Nova", "Cool Jazz", "Dixieland", "Free Jazz", 
                "Fusion", "Gypsy Jazz", "Hard Bop", "Jazz-Funk", "Latin Jazz", "Modal Jazz", "Orchestral Jazz", "Smooth Jazz", "Soul Jazz", "Swing", "Third Stream"
            ],
            "Folk/Country": [
                "Alt-Country", "Americana", "Anti-Folk", "Appalachian Folk", "Bakersfield Sound", "Bluegrass", "Celtic Folk", "Contemporary Folk", "Country & Western", 
                "Country Pop", "Country Rock", "Countrypolitan", "Dark Folk", "Experimental Folk", "Folk Punk", "Folk Rock", "Freak Folk", "Honky Tonk", "Indie Folk", 
                "Neofolk", "Outlaw Country", "Progressive Country", "Progressive Folk", "Psychedelic Folk", "Traditional Country", "Traditional Folk", "Western Swing"
            ],
            "Classical/Score": [
                "Ambient", "Avant-Garde", "Baroque", "Chamber Music", "Choral", "Cinematic", "Classical Period", "Contemporary Classical", "Drone", 
                "Early Music", "Epic Trailer", "Experimental", "Impressionist", "Medieval", "Minimalism", "Modern Classical", "Modern Creative", "Musique ConcrÃ¨te", 
                "Neoclassical", "Noise", "Opera", "Orchestral", "Renaissance", "Romantic Period", "Score", "Sound Art", "Soundtrack", "String Quartet", "Symphonic"
            ],
            "Latin/World": [
                "Afrobeat", "Afro-Cuban", "Bachata", "Baile Funk", "Bhangra", "Bollywood", "Bolero", "Bossa Nova", "Calypso", "Celtic", "Cumbia", "Dancehall", "Dub", 
                "Fado", "Flamenco", "Highlife", "JÃ¹jÃº", "Kizomba", "Klezmer", "Latin Groove", "Latin Jazz", "Latin Pop", "Latin Rock", "Mariachi", "Mbalax", 
                "Merengue", "Polka", "Raggamuffin", "Reggae", "Reggaeton", "Roots Reggae", "Rumba", "Salsa", "Samba", "Ska", "Soca", "Tango", "Tejano", "Tropicalia", "Zouk"
            ],
             "Blues/Roots": [
                "Acoustic Blues", "Chicago Blues", "Country Blues", "Delta Blues", "Electric Blues", "Gospel", "Jump Blues", "Piedmont Blues", "Rhythm and Blues", 
                "Roots Rock", "Spirituals", "Swamp Blues", "Texas Blues", "Zydeco"
             ],
             "Experimental/Odd": [
                 "Avant-Garde", "Breakcore", "Dark Ambient", "Dungeon Synth", "Glitch", "Hauntology", "Japanoise", "Lowercase", "Musique ConcrÃ¨te", "No Wave", 
                 "Noise", "Outsider Music", "Plunderphonics", "Sound Collage", "Vaporwave", "Witch House", "Extratone", "Flashcore", "Danger Music", "Black MIDI"
             ],
             "Other": [
                 "Acapella", "Barbershop Quartet", "Cabaret", "Children's Music", "Comedy Rock", "Dungeon Synth", "Exotica", "Lounge", "Marching Band", "New Age", 
                 "Sea Shanty", "Spoken Word", "Vaudeville"
             ]
        };

        const INSTRUMENTS = [
            "808 Drums", "808 Sub Bass", "909 Kit", "303 Acid Bassline", "Accordion", "Acoustic Drums", "Acoustic Guitar", "Alto Saxophone", "Analog Synth", 
            "Bagpipes", "Banjo", "Baritone Saxophone", "Bass Drum", "Bass Guitar", "Bassoon", "Bongos", "Brass Section", "Breakbeat", "Brown Noise", "Celesta", 
            "Cello", "Chimes", "Clarinet", "Clavinet", "Congas", "Contrabass", "Cowbell", "Didgeridoo", "Distorted Bass", "Distorted Guitar", "Double Bass", 
            "Drone", "Drum Machine", "Duduk", "Electric Guitar", "Electric Piano", "Erhu", "Fiddle", "Flute", "French Horn", "Fretless Bass", "Gamelan", 
            "Gated Reverb Drums", "Glass Harmonica", "Glitch Drums", "Glockenspiel", "Gong", "Granular Synthesis", "Guiro", "Hammond Organ", "Handclaps", 
            "Handpan", "Harmonica", "Harp", "Harpsichord", "Hurdy-Gurdy", "Kalimba", "Koto", "Lute", "Lyre", "Mandolin", "Marimba", "Mellotron", "Minimal Synth", 
            "Modular Synth", "Moog Bass", "Nyckelharpa", "Oboe", "Ondes Martenot", "Organ", "Oud", "Pan Flute", "Piano", "Pink Noise", "Pipa", "Portamento Synth", 
            "Prepared Piano", "Recorder", "Rhodes Piano", "Sampler", "Sarangi", "Saxophone", "Shaker", "Shamisen", "Shehnai", "Sitar", "Slide Guitar", "Snare Drum", 
            "Steel Drums", "String Quartet", "Strings", "Sub Bass", "Synth Arpeggio", "Synth Bass", "Synth Lead", "Synth Pad", "Tabla", "Taiko Drums", "Tambourine", 
            "Tape Loops", "Tenor Saxophone", "Theremin", "Timbales", "Timpani", "Toy Piano", "Triangle", "Trombone", "Trumpet", "Tuba", "Turntables", "Ukulele", 
            "Upright Bass", "Vibraphone", "Viola", "Violin", "Vocoder", "Wah-Wah Guitar", "Waterphone", "White Noise", "Wind Chimes", "Wurlitzer Piano", 
            "Xylophone", "Zither"
        ];

        const VOICES = [
            "Male Vocals", "Female Vocals", "Androgynous Vocals", "Choir", "Group Backing Vocals", "Children's Choir", "Gospel Choir", "Gang Vocals",
            "Whisper", "Screaming", "Growling", "Spoken Word", "Rap Flow", "Autotune", "Operatic", "Ethereal",
            "Baritone", "Bass", "Alto", "Soprano", "Falsetto", "Raspy", "Breathy", "Guttural", "Robot", "Vocoder", 
            "Chant", "Crooner", "Scat Singing", "Yodeling", "Throat Singing", "Beatboxing"
        ];

        const MOODS = [
            "Aggressive", "Angular", "Anxious", "Bittersweet", "Bouncy", "Brooding", "Calm", "Chaotic", "Chill", "Cinematic", "Cold", "Comforting", "Confident", 
            "Cosmic", "Dark", "Detached", "Dissociative", "Dramatic", "Dreamy", "Driving", "Eerie", "Elegant", "Emotional", "Energetic", "Enigmatic", "Epic", 
            "Ethereal", "Euphoric", "Festive", "Floating", "Funky", "Gloomy", "Groovy", "Happy", "Haunting", "Heartbreaking", "Heavy", "Hopeful", "Hypnotic", 
            "Industrial", "Inspirational", "Intense", "Intimate", "Isolated", "Joyful", "Joyous", "Jubilant", "Laid-back", "Lazy", "Light", "Lonely", "Lush", 
            "Majestic", "Melancholy", "Mellow", "Mournful", "Mysterious", "Nostalgic", "Ominous", "Optimistic", "Passionate", "Peaceful", "Playful", "Powerful", 
            "Psychedelic", "Pulsing", "Quirky", "Reflective", "Relaxing", "Retro", "Romantic", "Sad", "Sentimental", "Serene", "Serious", "Sexy", "Silly", 
            "Somber", "Soothing", "Sophisticated", "Sorrowful", "Soulful", "Spacey", "Spiritual", "Spooky", "Suspenseful", "Sweet", "Swirling", "Tense", 
            "Tranquil", "Trippy", "Upbeat", "Uplifting", "Warm", "Whimsical", "Witty", "Yearning"
        ];

        const TEMPO_FEEL = [
            "Slow (Adagio)", "Walking Pace (Andante)", "Fast (Allegro)", "Very Fast (Presto)",
            "Driving 4/4", "Groove", "Half-time", "Shuffle", "Syncopated", "Swing", "Triplet Feel",
            "Rubato", "Free Tempo", "60 BPM", "70 BPM", "80 BPM", "88 BPM", "90 BPM", "100 BPM", "110 BPM", "120 BPM", "125 BPM", "128 BPM", "130 BPM", "140 BPM", "150 BPM", "160 BPM", "170 BPM", "180 BPM",
            "Blast Beat", "Breakbeat", "D-Beat", "Double Time", "Down-tempo", "Four-on-the-Floor", "Latin Groove", 
            "Motorik", "Off-beat", "Polyrhythmic", "Pulsing", "Skank", "Slow Burn", "Slow Jam", "Staccato", "Steady Beat", "Straight", "Up-tempo", "Waltz (3/4)"
        ];

        const PRODUCTION = [
            "8-bit", "Analog Warmth", "Atmospheric", "Binaural", "Breathy", "Bright", "Brittle", "Cinematic Production", "Clean", "Close Mic", "Compressed", 
            "Crisp", "Crunchy", "Dark Mix", "Dense", "Digital", "Distorted", "Dry Mix", "Dull", "Echoey", "Flat", "Fuzzy", "Gated Reverb", "Glassy", 
            "Glitched", "Glossy", "Grainy", "Gritty", "Harsh", "Heavy Bass", "Heavy Reverb", "Hi-Fi", "Hollow", "Immersive Soundstage", "Instrument-forward Balance", 
            "Live Room", "Lo-Fi", "Loud Master", "Minimal", "Modern Production", "Monophonic", "Muddy", "Muffled", "Noisy", "Old School", "Organic", "Polished", 
            "Polyphonic", "Punchy", "Raw", "Retro", "Rich", "Room Reverb", "Room Tone", "Saturated", "Sharp", "Sidechained", "Sloppy", "Smooth", "Soft", 
            "Sparse", "Stereo", "Swirling Textures", "Synthetic", "Tape Saturation", "Thick", "Thin", "Tight", "Twangy", "Underwater", "Vintage", 
            "Vinyl Crackle", "Wall of Sound", "Warm", "Wet Mix", "Wide Stereo", "Wide Stereo Field"
        ];

        const METATAGS = [
            { label: "Intro", tag: "[Intro]" },
            { label: "Verse", tag: "[Verse]" },
            { label: "Chorus", tag: "[Chorus]" },
            { label: "Pre-Chorus", tag: "[Pre-Chorus]" },
            { label: "Bridge", tag: "[Bridge]" },
            { label: "Hook", tag: "[Hook]" },
            { label: "Break", tag: "[Instrumental Break]" },
            { label: "Solo", tag: "[Guitar Solo]" },
            { label: "Outro", tag: "[Outro]" },
            { label: "End", tag: "[End]" },
            { label: "Drop", tag: "[Drop]" },
            { label: "Instrumental", tag: "[Instrumental]" },
            { label: "Interlude", tag: "[Interlude]" },
            { label: "Big Finish", tag: "[Big Finish]" },
            { label: "Silence", tag: "[Silence]" }
        ];

        const PERFORMANCE_TAGS = [
            { label: "Whisper", tag: "[Whisper]" },
            { label: "Shout", tag: "[Shout]" },
            { label: "Spoken", tag: "[Spoken Word]" },
            { label: "Crescendo", tag: "[Crescendo]" },
            { label: "Decrescendo", tag: "[Decrescendo]" },
            { label: "Stop", tag: "[Sudden Stop]" },
            { label: "Fade", tag: "[Fade Out]" },
            { label: "Pause", tag: "[Pause]" },
            { label: "Giggle", tag: "[Giggle]" },
            { label: "Sigh", tag: "[Sigh]" },
            { label: "Applause", tag: "[Applause]" },
            { label: "Cheer", tag: "[Cheer]" }
        ];

        // --- STATE ---
        let state = {
            genreCat: "",
            subgenres: [], 
            instruments: [],
            voices: [],
            moods: [],
            tempo: "",
            production: [],
            singerDescription: "" // NEW
        };
        
        let dialState = {
            previewGenre: "",
            previewInstruments: [],
            previewVoices: [],
            previewMoods: [],
            previewProduction: [],
            previewTempo: ""
        };

        let deleteConfirm = false;

        // Dial Tag Mappings - DIRECT VISIBLE TAGS
        const TAGS_WEIRDNESS = [
            ["Conventional", "Standard Structure"],
            ["Experimental", "Unconventional"],
            ["Avant-Garde", "Abstract"],
            ["Chaotic", "Non-linear"]
        ];
        
        const TAGS_ERA = [
            ["Vintage", "Lo-Fi", "Analog Warmth"],
            ["Retro", "Old School"],
            ["Modern", "Clean Mix"],
            ["Futuristic", "Hi-Fi", "Digital"]
        ];

        const TAGS_INTENSITY = [
            ["Ambient", "Serene"],
            ["Chill", "Mellow"],
            ["Balanced", "Groovy"],
            ["Energetic", "Driving"],
            ["Aggressive", "Intense"]
        ];

        const TAGS_TEMPO = [
            ["Downtempo", "Slow"],
            ["Mid-Tempo", "Groove"],
            ["Up-Tempo", "Fast"],
            ["Speed", "Rapid"]
        ];
        
        const TAGS_VOCALS = [
            ["Instrumental"],
            ["Minimal Vocals", "Backing Vocals"],
            ["Male Vocals", "Female Vocals"],
            ["Lyrical", "Rap Flow"]
        ];


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initGenreUI();
            initDialsGenreUI(); 
            initMultiSelectUI("instruments-container", INSTRUMENTS, "instruments", "btn-selected-blue", "text-blue-200", "bg-blue-500/20", "border-blue-500");
            initMultiSelectUI("voices-container", VOICES, "voices", "btn-selected-blue", "text-blue-200", "bg-blue-500/20", "border-blue-500");
            initMultiSelectUI("moods-container", MOODS, "moods", "btn-selected-yellow", "text-yellow-200", "bg-yellow-500/20", "border-yellow-500");
            initMultiSelectUI("production-container", PRODUCTION, "production", "btn-selected-emerald", "text-emerald-200", "bg-emerald-500/20", "border-emerald-500");
            initTempoUI();
            initLyricsTags();
            initDB();
            
            // Search Listener
            document.getElementById('instrument-search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const container = document.getElementById('instruments-container');
                Array.from(container.children).forEach(btn => {
                    const txt = btn.textContent.toLowerCase();
                    if(txt.includes(term)) btn.style.display = 'block';
                    else btn.style.display = 'none';
                });
            });

            // Initialize default visuals for dials
            updateDials();
            updatePrompt();
            updateArtistPreviewStats(); // New Init
            
            // Set default text for Lyrics input
            document.getElementById('lyrics-input').value = LYRICS_PREFIX;
        });

        // --- UI BUILDERS ---

        function initGenreUI() {
            const container = document.getElementById('genre-container');
            container.innerHTML = '';
            Object.keys(GENRES).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `p-2 rounded-lg text-sm border transition-all text-left bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500`;
                btn.textContent = cat;
                // Pass false initially, but the click handler handles the toggle logic
                btn.onclick = () => selectGenreCat(cat, btn);
                btn.dataset.val = cat;
                container.appendChild(btn);
            });
        }

        function initDialsGenreUI() {
            const container = document.getElementById('dial-category-filters');
            container.innerHTML = '';

            // Add "ALL" button
            const allBtn = document.createElement('button');
            allBtn.className = "filter-chip active-filter";
            allBtn.textContent = "ALL";
            allBtn.onclick = () => filterDialsGenre('ALL', allBtn);
            container.appendChild(allBtn);

            // Add Category buttons
            Object.keys(GENRES).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = "filter-chip";
                btn.textContent = cat;
                btn.onclick = () => filterDialsGenre(cat, btn);
                container.appendChild(btn);
            });

            // Populate initial Select with ALL
            populateDialSelect(null);
        }

        function filterDialsGenre(category, btnElement) {
            // Update Active State
            const container = document.getElementById('dial-category-filters');
            Array.from(container.children).forEach(b => b.classList.remove('active-filter'));
            btnElement.classList.add('active-filter');

            // Populate Select
            populateDialSelect(category === 'ALL' ? null : category);
        }

        function populateDialSelect(filterCategory) {
            const select = document.getElementById('dial-genre-select');
            const currentValue = select.value; // Attempt to preserve selection if possible
            select.innerHTML = ''; // Clear

            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.textContent = filterCategory ? `[ SELECT ${filterCategory.toUpperCase()} GENRE ]` : "[ SELECT BASE GENRE ]";
            select.appendChild(defaultOpt);

            const categories = filterCategory ? [filterCategory] : Object.keys(GENRES);

            categories.forEach(cat => {
                if (filterCategory) {
                    // Flat list for single category
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        option.dataset.category = cat;
                        select.appendChild(option);
                    });
                } else {
                    // Optgroups for ALL
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = cat;
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        option.dataset.category = cat; 
                        optGroup.appendChild(option);
                    });
                    select.appendChild(optGroup);
                }
            });

            // Restore value if it exists in new list
            // If not, it defaults to empty/first option
            // This is actually okay behavior for a filter action
             if (currentValue) {
                // Check if value exists in new options
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === currentValue) {
                        exists = true;
                        break;
                    }
                }
                if (exists) select.value = currentValue;
            }
        }

        function initMultiSelectUI(containerId, dataList, stateKey, activeClass, activeText, activeBg, activeBorder) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            dataList.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-slate-800 border-slate-700 hover:border-slate-500 text-slate-300";
                
                if(state[stateKey].includes(item)) {
                    btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-300');
                    btn.classList.add(...activeClass.split(' '), activeText, activeBorder, 'bg-opacity-20');
                    if(activeClass.includes('purple')) btn.style.backgroundColor = "rgba(147, 51, 234, 0.2)";
                    if(activeClass.includes('blue')) btn.style.backgroundColor = "rgba(59, 130, 246, 0.2)";
                    if(activeClass.includes('yellow')) btn.style.backgroundColor = "rgba(234, 179, 8, 0.2)";
                    if(activeClass.includes('emerald')) btn.style.backgroundColor = "rgba(16, 185, 129, 0.2)";
                }

                btn.textContent = item;
                btn.dataset.value = item;
                
                btn.onclick = () => {
                    toggleSelection(item, stateKey);
                    updateBtnVisual(btn, state[stateKey].includes(item), activeClass);
                };
                container.appendChild(btn);
            });
        }

        function updateBtnVisual(btn, isSelected, activeClass) {
             if (isSelected) {
                btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-300');
                btn.classList.add(...activeClass.split(' '));
             } else {
                btn.classList.remove(...activeClass.split(' '));
                btn.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-300');
                btn.style.backgroundColor = ""; 
             }
        }

        function initTempoUI() {
            const select = document.getElementById('tempo-select');
            TEMPO_FEEL.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                select.appendChild(opt);
            });
        }

        function initLyricsTags() {
            const structureContainer = document.getElementById('structure-tags-container');
            METATAGS.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-lg text-xs font-mono text-left text-purple-200 transition-colors";
                btn.textContent = t.label;
                btn.onclick = () => insertTag(t.tag);
                structureContainer.appendChild(btn);
            });

            const perfContainer = document.getElementById('performance-tags-container');
            PERFORMANCE_TAGS.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-lg text-xs font-mono text-left text-yellow-200 transition-colors";
                btn.textContent = t.label;
                btn.onclick = () => insertTag(t.tag);
                perfContainer.appendChild(btn);
            });
        }

        // --- LOGIC ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('header button').forEach(btn => {
                btn.classList.remove('bg-slate-700', 'text-white', 'shadow-sm');
                btn.classList.add('text-slate-400', 'hover:text-white');
            });

            document.getElementById(`tab-${tabName}`).classList.add('active');
            const activeBtn = document.getElementById(`tab-btn-${tabName}`);
            activeBtn.classList.remove('text-slate-400', 'hover:text-white');
            activeBtn.classList.add('bg-slate-700', 'text-white', 'shadow-sm');
            
            if (tabName === 'json') {
                generateJsonOutput();
            }
            if (tabName === 'library') {
                renderLibrary();
            }
            if (tabName === 'artist') {
                updateArtistPreviewStats();
                renderArtistList();
            }
        }

        // MODIFIED: Added preserveSelection flag
        function selectGenreCat(cat, btnElement, preserveSelection = false) {
            state.genreCat = cat;
            if (!preserveSelection) {
                state.subgenres = []; 
            }

            const allBtns = document.getElementById('genre-container').children;
            Array.from(allBtns).forEach(b => {
                b.className = `p-2 rounded-lg text-sm border transition-all text-left bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500`;
            });
            // If btnElement is null (programmatic), find it
            if (!btnElement) {
                btnElement = Array.from(allBtns).find(b => b.textContent === cat);
            }
            if (btnElement) {
                btnElement.className = `p-2 rounded-lg text-sm border transition-all text-left bg-purple-600 border-purple-500 text-white`;
            }

            const subWrapper = document.getElementById('subgenre-wrapper');
            const subContainer = document.getElementById('subgenre-container');
            subContainer.innerHTML = '';
            
            if (GENRES[cat]) {
                subWrapper.classList.remove('hidden');
                GENRES[cat].forEach(sub => {
                    const sBtn = document.createElement('button');
                    sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-slate-800 border-slate-700 hover:border-slate-500 text-slate-300";
                    
                    // Check selection state during render
                    if (state.subgenres.includes(sub)) {
                        sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-purple-500/20 border-purple-500 text-purple-200";
                    }

                    sBtn.textContent = sub;
                    sBtn.dataset.value = sub;
                    sBtn.onclick = () => {
                        if (state.subgenres.includes(sub)) {
                            state.subgenres = state.subgenres.filter(s => s !== sub);
                            sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-slate-800 border-slate-700 hover:border-slate-500 text-slate-300";
                        } else {
                            state.subgenres.push(sub);
                            sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-purple-500/20 border-purple-500 text-purple-200";
                        }
                        updatePrompt();
                    };
                    subContainer.appendChild(sBtn);
                });
            } else {
                subWrapper.classList.add('hidden');
            }
            updatePrompt();
        }

        function toggleSelection(item, listKey) {
            const list = state[listKey];
            if (list.includes(item)) {
                state[listKey] = list.filter(i => i !== item);
            } else {
                state[listKey].push(item);
            }
            updatePrompt();
        }

        function updatePrompt() {
            const select = document.getElementById('tempo-select');
            state.tempo = select.value;
            // Update state with text input
            state.singerDescription = document.getElementById('singer-desc').value;

            const parts = [];
            
            if (state.subgenres.length > 0) {
                 parts.push(...state.subgenres);
            } else if (state.genreCat) {
                 parts.push(state.genreCat);
            }

            if (state.tempo) parts.push(state.tempo);
            if (state.moods.length > 0) parts.push(state.moods.join(", "));
            if (state.instruments.length > 0) parts.push(state.instruments.join(", "));
            
            // Add Singer Description to Prompt
            if (state.singerDescription) parts.push(state.singerDescription);
            if (state.voices.length > 0) parts.push(state.voices.join(", "));
            
            if (state.production.length > 0) parts.push(state.production.join(", "));

            const text = PROMPT_PREFIX + parts.join(", ");
            document.getElementById('style-output').value = text;
            
            const countDiv = document.getElementById('char-count');
            countDiv.textContent = `${text.length}/120 chars`;
            
            const warning = document.getElementById('length-warning');
            if (text.length > 120) warning.classList.remove('hidden');
            else warning.classList.add('hidden');
            
            if (document.getElementById('tab-json').classList.contains('active')) {
                generateJsonOutput();
            }
            // Update Artist Preview if active
            if(document.getElementById('tab-artist').classList.contains('active')){
                updateArtistPreviewStats();
            }
        }

        function insertTag(tag) {
            const textarea = document.getElementById('lyrics-input');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end);

            const isStructureTag = tag.startsWith("[") && !tag.includes("Whisper") && !tag.includes("Crescendo"); 
            const prefix = (isStructureTag && before.length > 0 && !before.endsWith("\n")) ? "\n\n" : "";
            const suffix = isStructureTag ? "\n" : "";

            const newText = before + prefix + tag + suffix + after;
            textarea.value = newText;
            
            textarea.focus();
            const newCursorPos = start + prefix.length + tag.length + suffix.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }

        // --- NEW: GENERATE LYRICS WITH GEMINI ---
        async function generateLyrics(type, event) {
            const apiKey = document.getElementById('api-key').value.trim();
            let selectedModel = document.getElementById('ai-model').value; 
            
            if (!apiKey) {
                alert("Please enter a valid Google Gemini API Key first.");
                return;
            }
            
            // UI Loading state
            const btn = event.target; 
            const originalText = btn.innerHTML;
            btn.textContent = "Generating...";
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const topic = document.getElementById('lyric-topic').value.trim() || "anything";
            const genre = state.genreCat + (state.subgenres.length ? " (" + state.subgenres.join(", ") + ")" : "");
            const mood = state.moods.length > 0 ? state.moods.join(", ") : "general";

            const promptText = `
            Act as a professional songwriter and music producer.
            Write a complete song structure including lyrics for a track with these characteristics:
            Genre Style: ${genre}
            Mood/Vibe: ${mood}
            Topic/Theme: ${topic}
            
            CRITICAL INSTRUCTIONS:
            1. You MUST include song structure tags like [Verse], [Chorus], [Bridge], [Outro].
            2. You MUST include performance cues and dynamic instructions within brackets based on the genre style. 
               Examples: [Soft Piano Intro], [Build up intensity], [Heavy Bass Drop], [Whisper vocals], [Scream], [Instrumental Break].
            3. Ensure the cues are stylistically appropriate (e.g. use [Breakdown] for Metal, [Drop] for EDM, [Solo] for Rock).
            4. Output ONLY the lyrics and tags. Do not add conversational text.
            `;

            // Helper function to make the call
            const callApi = async (model) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    return { ok: false, status: response.status, data: errorData };
                }
                const data = await response.json();
                return { ok: true, data: data };
            };

            try {
                // Attempt 1: Selected Model
                let result = await callApi(selectedModel);

                // Auto-fallback logic for 404 (Not Found) or 429 (Quota)
                if (!result.ok && (result.status === 404 || result.status === 429)) {
                    console.warn(`Model ${selectedModel} failed (${result.status}). Retrying with gemini-1.5-flash...`);
                    btn.textContent = "Retrying with Flash...";
                    result = await callApi("gemini-1.5-flash");
                }

                if (!result.ok) {
                    let errorMsg = `API Error (${result.status})`;
                    if (result.data && result.data.error) {
                        errorMsg += `\nMessage: ${result.data.error.message}`;
                        if(result.data.error.status === 'PERMISSION_DENIED') {
                            errorMsg += "\n\nTIP: Ensure 'Generative Language API' is enabled in Google Cloud Console.";
                        }
                    }
                    throw new Error(errorMsg);
                }

                if (!result.data.candidates || !result.data.candidates[0].content) {
                     throw new Error("No content generated. Check API key quotas or safety filters.");
                }

                const lyrics = result.data.candidates[0].content.parts[0].text.trim();
                
                // Insert into Textarea
                const textarea = document.getElementById('lyrics-input');
                
                if (textarea.value === LYRICS_PREFIX || textarea.value === "") {
                    textarea.value = LYRICS_PREFIX + lyrics;
                } else {
                    textarea.value = textarea.value + "\n\n" + lyrics;
                }
                
                textarea.scrollTop = textarea.scrollHeight;

            } catch (e) {
                if (e.message.includes("Failed to fetch")) {
                     alert("Network Error: Could not reach Google API. Check ad blockers or connection.");
                } else {
                     alert(e.message);
                }
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }


        function clearAll() {
            const btn = document.getElementById('btn-clear-all');
            
            if (!deleteConfirm) {
                deleteConfirm = true;
                btn.classList.add('confirm-delete');
                setTimeout(() => {
                    deleteConfirm = false;
                    btn.classList.remove('confirm-delete');
                }, 3000); 
            } else {
                state = {
                    genreCat: "",
                    subgenres: [],
                    instruments: [],
                    voices: [],
                    moods: [],
                    tempo: "",
                    production: [],
                    singerDescription: ""
                };
                
                document.getElementById('tempo-select').value = "";
                document.getElementById('singer-desc').value = ""; // Clear input
                
                document.querySelectorAll('#instruments-container button, #voices-container button, #moods-container button, #production-container button').forEach(b => {
                     b.classList.remove('btn-selected-blue', 'btn-selected-yellow', 'btn-selected-emerald', 'bg-purple-500/20', 'border-purple-500', 'text-purple-200');
                     b.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-300');
                     b.style.backgroundColor = "";
                });

                document.querySelectorAll('#genre-container button').forEach(b => {
                    b.className = `p-2 rounded-lg text-sm border transition-all text-left bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500`;
                });
                document.getElementById('subgenre-wrapper').classList.add('hidden');

                updatePrompt();
                
                deleteConfirm = false;
                btn.classList.remove('confirm-delete');
            }
        }
        
        function generateJsonOutput() {
            const genreList = [];
            if (state.subgenres.length > 0) {
                genreList.push(...state.subgenres);
            } else if (state.genreCat) {
                genreList.push(state.genreCat);
            }
            const genreString = genreList.join(", ");
            
            const instrumentsString = state.instruments.join(", ");
            
            // Combine Singer Desc and Voices for Persona
            const personaList = [];
            if (state.singerDescription) personaList.push(state.singerDescription);
            if (state.voices.length > 0) personaList.push(...state.voices);
            const personaString = personaList.join(", ");

            const styleTagsList = [...state.moods];
            if (state.tempo) styleTagsList.push(state.tempo);
            const styleTagsString = styleTagsList.join(", ");
            const recordingString = state.production.join(", ");

            const jsonObj = {
                "genre": genreString,
                "instruments": instrumentsString,
                "persona": personaString,
                "style_tags": styleTagsString,
                "recording": recordingString
            };
            
            document.getElementById('json-output').value = JSON.stringify(jsonObj, null, 4);
        }

        function copyToClipboard(elementId, btnElement) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            try {
                document.execCommand('copy');
                const textSpan = btnElement.querySelector('.btn-text');
                const originalText = textSpan.textContent;
                if(btnElement.classList.contains('group')) btnElement.classList.add('copied');
                
                textSpan.textContent = "Copied!";
                setTimeout(() => {
                    textSpan.textContent = originalText;
                    if(btnElement.classList.contains('group')) btnElement.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
        }

        // --- DIALS LOGIC ---
        
        function updateDials() {
            const subGenre = document.getElementById('dial-genre-select').value;
            
            const wVal = parseInt(document.getElementById('dial-weirdness').value);
            const eVal = parseInt(document.getElementById('dial-era').value);
            const iVal = parseInt(document.getElementById('dial-intensity').value);
            const tVal = parseInt(document.getElementById('dial-tempo').value);
            const vVal = parseInt(document.getElementById('dial-vocals').value);

            const pick = (arr, val) => {
                const step = 100 / arr.length;
                const index = Math.min(Math.floor(val / step), arr.length - 1);
                return arr[index];
            };

            const weirdTags = pick(TAGS_WEIRDNESS, wVal);
            const eraTags = pick(TAGS_ERA, eVal);
            const intensityTags = pick(TAGS_INTENSITY, iVal);
            const tempoTags = pick(TAGS_TEMPO, tVal);
            const vocalTags = pick(TAGS_VOCALS, vVal);

            document.getElementById('tags-weirdness').textContent = weirdTags.join(", ");
            document.getElementById('tags-era').textContent = eraTags.join(", ");
            document.getElementById('tags-intensity').textContent = intensityTags.join(", ");
            document.getElementById('tags-tempo').textContent = tempoTags.join(", ");
            document.getElementById('tags-vocals').textContent = vocalTags.join(", ");

            dialState.previewGenre = subGenre;
            dialState.previewInstruments = [...weirdTags]; 
            dialState.previewProduction = [...eraTags];
            dialState.previewMoods = [...intensityTags];
            dialState.previewTempo = tempoTags[0];
            dialState.previewVoices = [...vocalTags];

            document.getElementById('preview-genre').textContent = subGenre || "Select a base genre first...";
            document.getElementById('preview-weirdness').textContent = weirdTags.join(", ");
            document.getElementById('preview-era').textContent = eraTags.join(", ");
            document.getElementById('preview-intensity').textContent = intensityTags.join(", ");
            document.getElementById('preview-tempo').textContent = tempoTags.join(", ");
            document.getElementById('preview-vocals').textContent = vocalTags.join(", ");
        }

        function applyDialsToMain() {
            const baseGenre = document.getElementById('dial-genre-select').value;
            if (!baseGenre) {
                alert("Please select a base genre first.");
                return;
            }

            state.subgenres = baseGenre ? baseGenre.split(", ").map(s => s.trim()) : [];
            state.production = [...dialState.previewProduction]; 
            state.moods = [...dialState.previewMoods]; 
            state.voices = [...dialState.previewVoices]; 
            state.tempo = dialState.previewTempo; 
            state.subgenres.push(...dialState.previewInstruments); 

            // Update foundation category if possible
            const selectedOption = document.querySelector(`#dial-genre-select option[value="${baseGenre.split(",")[0]}"]`);
            if (selectedOption) {
                const cat = selectedOption.dataset.category || selectedOption.parentElement.label;
                if(cat) state.genreCat = cat;
            }

            updateAllVisuals();
            switchTab('style');
        }

        function updateAllVisuals() {
            if (state.genreCat) {
                const catBtns = document.getElementById('genre-container').children;
                Array.from(catBtns).forEach(b => {
                    if (b.dataset.val === state.genreCat) {
                        selectGenreCat(state.genreCat, b, true); 
                    }
                });
            }

            // Sync MultiSelects
            syncButtonList('instruments-container', state.instruments, "btn-selected-blue");
            syncButtonList('voices-container', state.voices, "btn-selected-blue");
            syncButtonList('moods-container', state.moods, "btn-selected-yellow");
            syncButtonList('production-container', state.production, "btn-selected-emerald");

            document.getElementById('tempo-select').value = state.tempo;
            document.getElementById('singer-desc').value = state.singerDescription || ""; // Restore singer desc
            updatePrompt();
        }

        function syncButtonList(containerId, stateList, activeClass) {
            const container = document.getElementById(containerId);
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                if (stateList.some(item => item === btn.textContent)) {
                    updateBtnVisual(btn, true, activeClass);
                } else {
                    updateBtnVisual(btn, false, activeClass);
                }
            });
        }

        // --- INDEXEDDB LOGIC ---
        const DB_NAME = 'SunoArchitectDB';
        const DB_VERSION = 2; // Incremented for Artists
        let db;

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => console.error("DB Error", event);
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains("prompts")) {
                    const store = db.createObjectStore("prompts", { keyPath: "id" });
                    store.createIndex("timestamp", "timestamp", { unique: false });
                }
                if (!db.objectStoreNames.contains("artists")) {
                    const artistStore = db.createObjectStore("artists", { keyPath: "id" });
                    artistStore.createIndex("name", "name", { unique: false });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                renderLibrary();
                // If artist tab loaded first, render artists
                if(document.getElementById('tab-artist').classList.contains('active')) {
                    renderArtistList();
                }
            };
        }

        function saveCurrentPrompt() {
            const promptText = document.getElementById('style-output').value;
            const lyricsText = document.getElementById('lyrics-input').value; // Save lyrics too

            if (!promptText) {
                alert("Nothing to save!");
                return;
            }
            
            // Generate a simple name
            let name = state.subgenres[0] || state.genreCat || "Untitled";
            name += ` - ${new Date().toLocaleTimeString()}`;

            const note = prompt("Name this prompt:", name);
            if (note === null) return; // Cancelled

            // Ask for song link
            const link = prompt("Optional: Paste the Suno Song Link here:", "");

            const transaction = db.transaction(["prompts"], "readwrite");
            const store = transaction.objectStore("prompts");
            
            const item = {
                id: Date.now(),
                name: note || name,
                state: JSON.parse(JSON.stringify(state)), 
                text: promptText,
                lyrics: lyricsText, // Saved!
                songLink: link,     // Saved!
                timestamp: new Date()
            };

            const request = store.add(item);
            request.onsuccess = () => {
                alert("Saved to Library!");
                renderLibrary();
            };
            request.onerror = () => alert("Error saving prompt.");
        }

        function deletePrompt(id) {
            if (!confirm("Delete this prompt?")) return;
            const transaction = db.transaction(["prompts"], "readwrite");
            const store = transaction.objectStore("prompts");
            store.delete(id);
            transaction.oncomplete = () => renderLibrary();
        }

        function loadPrompt(id) {
            const transaction = db.transaction(["prompts"], "readonly");
            const store = transaction.objectStore("prompts");
            const request = store.get(id);
            
            request.onsuccess = () => {
                const item = request.result;
                if(item) {
                    state = item.state;
                    // Restore lyrics if present
                    if (item.lyrics) {
                        document.getElementById('lyrics-input').value = item.lyrics;
                    }
                    
                    // --- Smart Loading Logic for Filters ---
                    // Detect category of loaded state to set Dials filter
                    if (state.genreCat) {
                        // Switch filter to match loaded genre category
                        const container = document.getElementById('dial-category-filters');
                        // Find button matching loaded category
                        const catBtn = Array.from(container.children).find(b => b.textContent === state.genreCat);
                        if (catBtn) {
                            filterDialsGenre(state.genreCat, catBtn);
                        } else {
                            // Reset to ALL if category not found or weird state
                            const allBtn = container.firstElementChild; 
                            filterDialsGenre('ALL', allBtn);
                        }
                    }

                    updateAllVisuals(); 
                    switchTab('style');
                }
            };
        }

        function renderLibrary() {
            if (!db) return;
            // Check if prompts store exists first (upgrade safety)
            if(!db.objectStoreNames.contains("prompts")) return;

            const transaction = db.transaction(["prompts"], "readonly");
            const store = transaction.objectStore("prompts");
            const index = store.index("timestamp");
            const request = index.openCursor(null, 'prev'); // Newest first
            
            const list = document.getElementById('library-list');
            list.innerHTML = '';
            let hasItems = false;

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    hasItems = true;
                    const item = cursor.value;
                    
                    // Create Link Button if link exists
                    let linkHtml = '';
                    if (item.songLink && item.songLink.trim() !== "") {
                        linkHtml = `
                        <a href="${item.songLink}" target="_blank" onclick="event.stopPropagation()" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded-full flex items-center transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3 mr-1"></i> Listen
                        </a>`;
                    }

                    const el = document.createElement('div');
                    el.className = "bg-slate-900 border border-slate-600 rounded-lg p-4 flex flex-col justify-between group hover:border-purple-500 transition-colors";
                    el.innerHTML = `
                        <div class="mb-3">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-slate-200 text-lg group-hover:text-purple-400 transition-colors truncate pr-2">${item.name}</h3>
                                ${linkHtml}
                            </div>
                            <p class="text-xs text-slate-500 font-mono mb-2">${new Date(item.timestamp).toLocaleString()}</p>
                            
                            <!-- Style Preview -->
                            <div class="mt-2 text-xs text-slate-400 line-clamp-2 bg-slate-950 p-2 rounded border border-slate-800 font-mono">
                                <span class="text-purple-500 font-bold">Style:</span> ${item.text}
                            </div>
                            
                            <!-- Lyrics Preview -->
                            <div class="mt-1 text-xs text-slate-500 line-clamp-2 bg-slate-950 p-2 rounded border border-slate-800 font-mono">
                                <span class="text-blue-500 font-bold">Lyrics:</span> ${item.lyrics ? item.lyrics.substring(0, 100).replace(/\n/g, ' ') + '...' : 'No lyrics saved'}
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="loadPrompt(${item.id})" class="flex-1 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded text-sm font-bold transition-colors">Load</button>
                            <button onclick="deletePrompt(${item.id})" class="px-3 py-2 bg-slate-800 hover:bg-red-900/50 text-slate-400 hover:text-red-400 rounded border border-slate-700 hover:border-red-800 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(el);
                    cursor.continue();
                } else if (!hasItems) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-500 col-span-2 italic">
                        No saved prompts yet. Create a style and click the Save icon!
                    </div>`;
                }
                lucide.createIcons();
            };
        }

        // --- ARTIST BUILDER LOGIC ---

        function updateArtistPreviewStats() {
            // Helper to see what current state looks like in the Artist tab
            const stats = document.getElementById('artist-preview-stats');
            if (!stats) return;

            const hasData = state.genreCat || state.subgenres.length > 0;
            
            if (!hasData) {
                stats.innerHTML = `<p class="italic text-slate-600">Configure settings in "Style Tuner" or "Blueprint" first to define your artist's sound...</p>`;
                return;
            }

            const html = `
                <div class="flex justify-between border-b border-slate-800 pb-1 mb-1">
                    <span class="text-slate-500">Foundation</span>
                    <span class="text-purple-400 font-bold">${state.genreCat || '-'}</span>
                </div>
                <div class="flex justify-between border-b border-slate-800 pb-1 mb-1">
                    <span class="text-slate-500">Subgenres</span>
                    <span class="text-slate-300 text-right truncate pl-4">${state.subgenres.length ? state.subgenres.join(", ") : '-'}</span>
                </div>
                <!-- New Singer Def Row -->
                <div class="flex justify-between border-b border-slate-800 pb-1 mb-1">
                    <span class="text-slate-500">Singer Def</span>
                    <span class="text-blue-400 text-right truncate pl-4 font-mono text-[10px]" title="${state.singerDescription}">${state.singerDescription || '-'}</span>
                </div>
                <div class="flex justify-between border-b border-slate-800 pb-1 mb-1">
                    <span class="text-slate-500">Vocals (Tags)</span>
                    <span class="text-blue-400 text-right truncate pl-4">${state.voices.length ? state.voices.join(", ") : '-'}</span>
                </div>
                <div class="flex justify-between border-b border-slate-800 pb-1 mb-1">
                    <span class="text-slate-500">Instruments</span>
                    <span class="text-blue-300 text-right truncate pl-4">${state.instruments.length ? state.instruments.slice(0,3).join(", ") + (state.instruments.length > 3 ? '...' : '') : '-'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-500">Production</span>
                    <span class="text-emerald-400 text-right truncate pl-4">${state.production.length ? state.production.join(", ") : '-'}</span>
                </div>
            `;
            stats.innerHTML = html;
        }

        function saveArtist() {
            const name = document.getElementById('artist-name').value.trim();
            const bio = document.getElementById('artist-bio').value.trim();

            if (!name) {
                alert("Please give your Artist a name!");
                return;
            }
            if (!state.genreCat && state.subgenres.length === 0) {
                alert("This artist has no sound profile yet! Go to the 'Style Tuner' or 'Blueprint' tab to select Genres, Instruments, etc. first.");
                return;
            }

            const artistData = {
                id: Date.now(), // simple unique ID
                name: name,
                bio: bio,
                // We capture the "Core Identity" parts of state
                profile: {
                    genreCat: state.genreCat,
                    subgenres: [...state.subgenres],
                    instruments: [...state.instruments],
                    voices: [...state.voices],
                    production: [...state.production],
                    singerDescription: state.singerDescription // Capture description
                    // Note: We deliberately exclude Moods/Tempo so those can vary per song
                }
            };

            const transaction = db.transaction(["artists"], "readwrite");
            const store = transaction.objectStore("artists");
            const request = store.add(artistData);

            request.onsuccess = () => {
                alert(`Artist "${name}" signed to the roster!`);
                document.getElementById('artist-name').value = '';
                document.getElementById('artist-bio').value = '';
                renderArtistList();
            };
            
            request.onerror = (e) => {
                console.error("Error saving artist", e);
                alert("Could not save artist. DB Error.");
            };
        }

        function loadArtist(id) {
            const transaction = db.transaction(["artists"], "readonly");
            const store = transaction.objectStore("artists");
            const request = store.get(id);

            request.onsuccess = () => {
                const artist = request.result;
                if (artist && artist.profile) {
                    // Update global state with Artist Identity
                    state.genreCat = artist.profile.genreCat;
                    state.subgenres = [...artist.profile.subgenres];
                    state.instruments = [...artist.profile.instruments];
                    state.voices = [...artist.profile.voices];
                    state.production = [...artist.profile.production];
                    state.singerDescription = artist.profile.singerDescription || ""; // Load description
                    
                    // Reset variable fields so user can define them for the specific song
                    // Or keep them if we want a "Default Mood"? 
                    // Let's reset moods to allow fresh creativity on the base sound
                    state.moods = []; 
                    state.tempo = ""; // User sets tempo per song usually

                    updateAllVisuals(); // Refreshes UI
                    
                    // Go to Blueprint to see the loaded setup
                    switchTab('style');
                    
                    // Optional: Toast notification
                    // alert(`Loaded Artist: ${artist.name}`);
                }
            };
        }

        function deleteArtist(id) {
            if(!confirm("Drop this artist from your label? (Delete permanently)")) return;
            const transaction = db.transaction(["artists"], "readwrite");
            const store = transaction.objectStore("artists");
            store.delete(id);
            transaction.oncomplete = () => renderArtistList();
        }

        function renderArtistList() {
            if (!db || !db.objectStoreNames.contains("artists")) return;

            const transaction = db.transaction(["artists"], "readonly");
            const store = transaction.objectStore("artists");
            const request = store.openCursor();
            
            const list = document.getElementById('artist-list');
            list.innerHTML = '';
            let hasItems = false;

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    hasItems = true;
                    const artist = cursor.value;
                    const p = artist.profile;

                    const el = document.createElement('div');
                    el.className = "bg-slate-900 border border-slate-600 rounded-lg p-4 flex flex-col group hover:border-pink-500 transition-colors cursor-pointer relative";
                    // Click card to load
                    el.onclick = (e) => {
                        if(e.target.closest('button')) return; // ignore button clicks
                        loadArtist(artist.id);
                    };

                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-100 text-lg group-hover:text-pink-400 transition-colors">${artist.name}</h4>
                            <button onclick="deleteArtist(${artist.id})" class="text-slate-600 hover:text-red-400 transition-colors p-1">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="text-xs text-slate-500 mb-3 italic font-mono line-clamp-2">${artist.bio || "No description"}</div>
                        
                        <div class="flex flex-wrap gap-1 mb-3">
                            <span class="bg-slate-950 text-slate-400 px-2 py-1 rounded text-[10px] border border-slate-800">${p.genreCat}</span>
                            ${p.singerDescription ? `<span class="bg-pink-900/20 text-pink-400 px-2 py-1 rounded text-[10px] border border-pink-900/30 truncate max-w-[150px] block">${p.singerDescription}</span>` : ''}
                            ${p.voices[0] ? `<span class="bg-blue-900/20 text-blue-400 px-2 py-1 rounded text-[10px] border border-blue-900/30">${p.voices[0]}</span>` : ''}
                        </div>

                        <div class="mt-auto pt-2 border-t border-slate-800 flex justify-end">
                            <span class="text-[10px] text-pink-500 font-bold uppercase tracking-wider group-hover:underline">Load Profile &rarr;</span>
                        </div>
                    `;
                    list.appendChild(el);
                    cursor.continue();
                } else if (!hasItems) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-500 italic">
                        No artists created yet. Use the Builder to save a sound profile.
                    </div>`;
                }
                lucide.createIcons();
            };
        }

    </script>
</body>
</html>
