<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno Engineer's Companion v7.0 (DAW Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.firebaseModules = { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        daw: {
                            bg: '#09090b',       // Zinc 950
                            panel: '#18181b',    // Zinc 900
                            border: '#27272a',   // Zinc 800
                            surface: '#27272a',  // Zinc 800
                            accent: '#06b6d4',   // Cyan 500
                            accentHover: '#0891b2',
                            text: '#e4e4e7',     // Zinc 200
                            muted: '#a1a1aa',    // Zinc 400
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #e4e4e7; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #06b6d4; cursor: pointer; margin-top: -5px; border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #3f3f46; border-radius: 2px;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }

        /* Utility classes */
        .glass-panel { background: rgba(24, 24, 27, 0.95); border: 1px solid #27272a; }
        .nav-item.active { background-color: #27272a; border-left: 3px solid #06b6d4; color: #fff; }
        .nav-item { border-left: 3px solid transparent; }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #18181b; border: 1px solid #27272a; border-left: 4px solid #06b6d4; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); font-size: 0.875rem; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Audio Player Customization */
        audio { height: 36px; width: 100%; filter: invert(0.9) hue-rotate(180deg); }
    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-cyan-900 selection:text-white">

    <div id="app-container" class="flex h-screen w-full hidden">
        <aside class="w-64 bg-daw-panel border-r border-daw-border flex flex-col flex-shrink-0 z-20">
            <div class="p-5 border-b border-daw-border bg-daw-bg">
                <h1 class="font-mono font-bold text-lg tracking-tight text-cyan-400 flex items-center gap-2">
                    <i class="fa-solid fa-sliders"></i> PROMPT<span class="text-white">ENG</span>
                    <span class="text-[9px] bg-daw-border text-daw-muted px-1.5 py-0.5 rounded ml-auto">v7.0</span>
                </h1>
            </div>

            <nav class="flex-1 overflow-y-auto py-4 space-y-1" id="main-nav">
                <div class="px-4 pb-2 text-[10px] font-bold text-daw-muted uppercase tracking-widest">Library</div>
                <button onclick="app.navigate('artists')" id="nav-artists" class="nav-item w-full text-left px-5 py-2.5 text-sm font-medium text-daw-muted hover:text-white hover:bg-daw-surface transition-all flex items-center gap-3">
                    <i class="fa-solid fa-users w-5 text-center text-xs"></i> Artists / Bands
                </button>
                <button onclick="app.navigate('library')" id="nav-library" class="nav-item w-full text-left px-5 py-2.5 text-sm font-medium text-daw-muted hover:text-white hover:bg-daw-surface transition-all flex items-center gap-3">
                    <i class="fa-solid fa-layer-group w-5 text-center text-xs"></i> Master Library
                </button>
                
                <div class="mt-6 px-4 pb-2 text-[10px] font-bold text-daw-muted uppercase tracking-widest">Tools</div>
                <button onclick="app.navigate('styles')" id="nav-styles" class="nav-item w-full text-left px-5 py-2.5 text-sm font-medium text-daw-muted hover:text-white hover:bg-daw-surface transition-all flex items-center gap-3">
                    <i class="fa-solid fa-wand-magic-sparkles w-5 text-center text-xs"></i> Style Rack
                </button>
                
                <div class="mt-6 px-4 pb-2 text-[10px] font-bold text-daw-muted uppercase tracking-widest">System</div>
                <button onclick="app.navigate('settings')" id="nav-settings" class="nav-item w-full text-left px-5 py-2.5 text-sm font-medium text-daw-muted hover:text-white hover:bg-daw-surface transition-all flex items-center gap-3">
                    <i class="fa-solid fa-database w-5 text-center text-xs"></i> Data & Backup
                </button>
            </nav>

            <div id="user-profile" class="p-4 border-t border-daw-border bg-daw-bg flex justify-between items-center">
                <div class="flex items-center gap-2 truncate">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>
                    <span class="text-xs font-mono text-daw-muted truncate w-24" id="user-email">User</span>
                </div>
                <button onclick="app.signOut()" class="text-xs text-daw-muted hover:text-red-400 transition-colors" title="Sign Out"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-daw-bg relative overflow-hidden" id="main-content"></main>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-daw-bg z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-daw-panel border border-daw-border rounded-xl shadow-2xl p-8 text-center fade-in">
            <div class="mb-8">
                <div class="w-16 h-16 bg-daw-surface rounded-full flex items-center justify-center mx-auto mb-4 border border-daw-border shadow-inner">
                    <i class="fa-solid fa-sliders text-3xl text-cyan-500"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2 font-mono">PROMPT<span class="text-cyan-500">ENG</span></h1>
                <p class="text-daw-muted text-sm">AI Audio Engineering Workspace</p>
            </div>
            <div id="step-login">
                <button onclick="app.signIn()" class="w-full bg-white hover:bg-gray-200 text-slate-900 font-bold py-3 px-4 rounded transition-colors flex items-center justify-center gap-3 mb-4 shadow-lg">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> 
                    Authenticate Session
                </button>
                <div id="auth-error-msg" class="text-red-500 text-xs mt-2 hidden font-mono"></div>
            </div>
            <div id="step-loading" class="hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500 mx-auto mb-4"></div>
                <p class="text-daw-muted text-xs font-mono">Initializing Database...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <textarea id="fallback-clipboard" style="position: absolute; left: -9999px;"></textarea>
    <input type="file" id="global-file-input" class="hidden">

    <div id="generic-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-daw-panel border border-daw-border rounded-xl shadow-2xl w-[500px] p-6 fade-in">
            <div class="flex justify-between items-center mb-6 border-b border-daw-border pb-4">
                <h3 id="modal-title" class="text-lg font-bold text-white font-mono">Title</h3>
                <button onclick="app.closeModal()" class="text-daw-muted hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="modal-content"></div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-daw-border">
                <button onclick="app.closeModal()" class="px-4 py-2 text-xs font-bold text-daw-muted hover:text-white uppercase tracking-wider">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 text-xs font-bold bg-cyan-600 hover:bg-cyan-500 text-white rounded uppercase tracking-wider shadow-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        window.addEventListener('load', () => {
            const { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, query } = window.firebaseModules;

            // --- 1. Tag Library (Organized for Engineers) ---
            const TAG_LIBRARY = {
                "Instruments": {
                    "Rhythm": ["808 Drums", "Breakbeat", "Live Drums", "Drum Machine", "Percussion"],
                    "Bass": ["Synth Bass", "Upright Bass", "Fuzz Bass", "Sub Bass", "Reese Bass"],
                    "Keys": ["Piano", "Rhodes", "Wurlitzer", "Synthesizer", "Pad", "Arpeggiator"],
                    "Strings": ["Violin", "Cello", "Orchestral Strings", "Guitar (Acoustic)", "Guitar (Electric)"]
                },
                "Vibe & Tone": {
                    "Mood": ["Melancholic", "Euphoric", "Aggressive", "Chill", "Dark", "Ethereal", "Cinematic"],
                    "Texture": ["Lo-Fi", "Distorted", "Clean", "Reverb-heavy", "Dry", "Atmospheric"]
                },
                "Genre & Style": {
                    "Electronic": ["Techno", "House", "Ambient", "IDM", "Synthwave", "Dubstep"],
                    "Rock/Pop": ["Indie", "Shoegaze", "Post-Punk", "Dream Pop", "Hyperpop"],
                    "Urban": ["Hip Hop", "Trap", "RnB", "Neo-Soul"]
                },
                "Vocal Chain": {
                    "Type": ["Female Vocals", "Male Vocals", "Androgynous", "Choir", "Spoken Word"],
                    "Processing": ["Autotune", "Vocoder", "Reverb", "Whisper", "Belting", "Rap"]
                }
            };

            const MIX_TAGS = ["Muddy Low-End", "Harsh Highs", "Vocals Buried", "Stereo Too Wide", "Mono Phase Issues", "Over-compressed", "Click/Pop Artifacts", "Hallucination"];
            const generateID = () => crypto.randomUUID();

            // --- 2. Database Wrapper ---
            class DB {
                constructor(appInstance) {
                    this.app = appInstance;
                    this.db = null;
                    this.auth = null;
                    this.user = null;
                    this.idb = null;
                    this.config = {
                        apiKey: "AIzaSyDKXd3b1ypsAz0Pwsi9rr8DknYg3PzCSOo",
                        authDomain: "ai-audio-engineer.firebaseapp.com",
                        projectId: "ai-audio-engineer",
                        storageBucket: "ai-audio-engineer.firebasestorage.app",
                        messagingSenderId: "150234414348",
                        appId: "1:150234414348:web:6d38c836eae470cb559d29"
                    };
                    this.appId = 'default-app';
                    this.initIndexedDB();
                }

                init() {
                    try {
                        const app = initializeApp(this.config);
                        this.auth = getAuth(app);
                        this.db = getFirestore(app);
                        onAuthStateChanged(this.auth, (user) => {
                            this.user = user;
                            if (user) this.app.onLoginSuccess(user);
                            else this.app.showAuthStep('login');
                        });
                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                    }
                }

                async loginGoogle() {
                    const provider = new GoogleAuthProvider();
                    try { await signInWithPopup(this.auth, provider); } 
                    catch (error) { this.app.showAuthStep('login'); alert("Login failed: " + error.message); }
                }

                async logout() { await signOut(this.auth); window.location.reload(); }

                initIndexedDB() {
                    const req = indexedDB.open('SunoCompanionBlobs', 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs', { keyPath: 'id' });
                    };
                    req.onsuccess = (e) => { this.idb = e.target.result; };
                }

                async getCollection(name) {
                    if (!this.user) throw new Error("Not authenticated");
                    return collection(this.db, 'artifacts', this.appId, 'users', this.user.uid, name);
                }

                async getAll(storeName) {
                    if (!this.user) return [];
                    try {
                        const col = await this.getCollection(storeName);
                        const snap = await getDocs(col);
                        const items = snap.docs.map(d => d.data());
                        if (storeName === 'songs' || storeName === 'albums') {
                            return await Promise.all(items.map(async (item) => {
                                const blob = await this.getBlob(item.id);
                                return blob ? { ...item, ...blob } : item;
                            }));
                        }
                        return items;
                    } catch (e) { return []; }
                }

                async put(storeName, item) {
                    if (!this.user) return;
                    const meta = { ...item };
                    const blobs = {};
                    let hasBlobs = false;
                    if (meta.audioBlob) { blobs.audioBlob = meta.audioBlob; delete meta.audioBlob; hasBlobs = true; }
                    if (meta.artworkBlob) { blobs.artworkBlob = meta.artworkBlob; delete meta.artworkBlob; hasBlobs = true; }

                    const ref = doc(this.db, 'artifacts', this.appId, 'users', this.user.uid, storeName, item.id);
                    await setDoc(ref, meta);

                    if (hasBlobs && this.idb) {
                        const tx = this.idb.transaction('blobs', 'readwrite');
                        tx.objectStore('blobs').put({ id: item.id, ...blobs });
                    }
                }

                async delete(storeName, id) {
                    if (!this.user) return;
                    const ref = doc(this.db, 'artifacts', this.appId, 'users', this.user.uid, storeName, id);
                    await deleteDoc(ref);
                    if (this.idb) {
                        const tx = this.idb.transaction('blobs', 'readwrite');
                        tx.objectStore('blobs').delete(id);
                    }
                }

                async getBlob(id) {
                    if (!this.idb) return null;
                    return new Promise(resolve => {
                        const tx = this.idb.transaction('blobs', 'readonly');
                        const req = tx.objectStore('blobs').get(id);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => resolve(null);
                    });
                }

                async exportAll() {
                    const data = {
                        artists: await this.getAll('artists'),
                        albums: await this.getAll('albums'),
                        songs: await this.getAll('songs'),
                        styles: await this.getAll('styles'),
                        version: '7.0', timestamp: Date.now()
                    };
                    const strip = (obj) => { const c = { ...obj }; delete c.audioBlob; delete c.artworkBlob; return c; };
                    data.albums = data.albums.map(strip); data.songs = data.songs.map(strip);
                    return JSON.stringify(data, null, 2);
                }

                async importData(jsonString) {
                    try {
                        const data = JSON.parse(jsonString);
                        if (data.artists) for (const i of data.artists) await this.put('artists', i);
                        if (data.albums) for (const i of data.albums) await this.put('albums', i);
                        if (data.songs) for (const i of data.songs) await this.put('songs', i);
                        if (data.styles) for (const i of data.styles) await this.put('styles', i);
                        return true;
                    } catch (e) { console.error(e); return false; }
                }
            }

            // --- 3. Main App ---
            class App {
                constructor() {
                    window.app = this;
                    this.db = new DB(this);
                    this.state = { view: 'artists', artistId: null, albumId: null, songId: null, wsTab: 'lyrics' };
                    this.cache = { artists: [], albums: [], songs: [], styles: [] };
                    this.tempStyle = {};
                    this.db.init();
                }

                showAuthStep(step) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('step-loading').classList.add('hidden');
                    document.getElementById('step-login').classList.add('hidden');
                    if (step === 'login') document.getElementById('step-login').classList.remove('hidden');
                    if (step === 'loading') document.getElementById('step-loading').classList.remove('hidden');
                }

                async onLoginSuccess(user) {
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('user-email').textContent = user.email;
                    await this.refreshCache();
                    this.navigate('artists');
                }

                signIn() { this.showAuthStep('loading'); this.db.loginGoogle(); }
                signOut() { this.db.logout(); }

                async refreshCache() {
                    if (!this.db.user) return;
                    this.cache.artists = await this.db.getAll('artists');
                    this.cache.albums = await this.db.getAll('albums');
                    this.cache.songs = await this.db.getAll('songs');
                    this.cache.styles = await this.db.getAll('styles');
                }

                navigate(view, params = {}) {
                    this.state.view = view;
                    if (params.artistId) this.state.artistId = params.artistId;
                    if (params.albumId) this.state.albumId = params.albumId;
                    if (params.songId) this.state.songId = params.songId;
                    if (view === 'workstation' && params.tab) this.state.wsTab = params.tab;
                    this.updateSidebar();
                    this.render();
                }

                updateSidebar() {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    if (['artist-detail', 'album-detail', 'workstation', 'artists'].includes(this.state.view)) document.getElementById('nav-artists').classList.add('active');
                    else if (this.state.view === 'library') document.getElementById('nav-library').classList.add('active');
                    else if (this.state.view === 'styles') document.getElementById('nav-styles').classList.add('active');
                    else if (this.state.view === 'settings') document.getElementById('nav-settings').classList.add('active');
                }

                showToast(msg, type = 'success') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = 'toast';
                    if(type === 'error') el.style.borderLeftColor = '#ef4444';
                    el.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-info-circle'}"></i> ${msg}`;
                    container.appendChild(el);
                    setTimeout(() => {
                        el.style.opacity = '0';
                        setTimeout(() => el.remove(), 300);
                    }, 3000);
                }

                // --- VIEWS ---

                render() {
                    const container = document.getElementById('main-content');
                    container.innerHTML = '';
                    switch (this.state.view) {
                        case 'artists': this.renderArtistsList(container); break;
                        case 'artist-detail': this.renderArtistDetail(container); break;
                        case 'album-detail': this.renderAlbumDetail(container); break;
                        case 'workstation': this.renderWorkstation(container); break;
                        case 'library': this.renderLibrary(container); break;
                        case 'styles': this.renderStyleManager(container); break;
                        case 'settings': this.renderSettings(container); break;
                    }
                }

                renderArtistsList(container) {
                    const artists = this.cache.artists.sort((a, b) => b.createdAt - a.createdAt);
                    container.innerHTML = `
                        <div class="p-8 fade-in h-full overflow-y-auto">
                            <div class="flex justify-between items-center mb-8">
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-1 font-mono tracking-tight">ARTIST ROSTER</h2>
                                    <p class="text-daw-muted text-sm">Manage virtual bands and solo projects.</p>
                                </div>
                                <button onclick="app.modalAddArtist()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-5 py-2 rounded-md font-bold shadow-lg transition-colors flex items-center gap-2 uppercase text-xs tracking-wider">
                                    <i class="fa-solid fa-plus"></i> New Artist
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                ${artists.map(a => {
                                    const albumCount = this.cache.albums.filter(al => al.artistId === a.id).length;
                                    return `
                                    <div class="group bg-daw-panel border border-daw-border rounded-lg p-5 hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(6,182,212,0.1)] transition-all relative">
                                        <div onclick="app.navigate('artist-detail', {artistId: '${a.id}'})" class="cursor-pointer">
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="w-12 h-12 rounded bg-gradient-to-br from-daw-surface to-daw-border border border-daw-border flex items-center justify-center text-xl font-bold font-mono text-cyan-500">
                                                    ${a.name.substring(0, 2).toUpperCase()}
                                                </div>
                                                <div class="text-[10px] text-daw-muted uppercase tracking-widest bg-daw-bg px-2 py-1 rounded border border-daw-border group-hover:text-cyan-400 group-hover:border-cyan-500/30 transition-colors">Active</div>
                                            </div>
                                            <h3 class="text-lg font-bold text-white mb-1 truncate">${a.name}</h3>
                                            <div class="text-xs text-daw-muted mb-4 font-mono">${a.genre || 'Unclassified'}</div>
                                            <div class="flex items-center justify-between text-[11px] text-daw-muted border-t border-daw-border pt-4">
                                                <span class="flex items-center gap-1"><i class="fa-solid fa-record-vinyl"></i> ${albumCount} Releases</span>
                                            </div>
                                        </div>
                                        <button onclick="app.deleteArtist('${a.id}')" class="absolute top-5 right-5 text-daw-muted hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" title="Delete">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>`;
                                }).join('')}
                            </div>
                            ${artists.length === 0 ? `<div class="text-center text-daw-muted mt-20 font-mono text-sm opacity-50">Roster Empty. Initialize new artist.</div>` : ''}
                        </div>`;
                }

                renderArtistDetail(container) {
                    const artist = this.cache.artists.find(a => a.id === this.state.artistId); if (!artist) return this.navigate('artists');
                    const albums = this.cache.albums.filter(a => a.artistId === artist.id).sort((a, b) => b.year - a.year);
                    
                    container.innerHTML = `
                        <div class="flex flex-col h-full fade-in">
                            <div class="h-40 bg-gradient-to-r from-daw-panel to-daw-bg border-b border-daw-border p-8 flex flex-col justify-end relative shrink-0">
                                <button onclick="app.navigate('artists')" class="absolute top-6 left-6 text-daw-muted hover:text-white text-xs font-bold uppercase tracking-wider flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Roster</button>
                                <h1 class="text-4xl font-bold text-white mb-2 font-mono tracking-tighter">${artist.name}</h1>
                                <div class="flex items-center gap-4 text-xs font-mono text-cyan-400">
                                    <span class="bg-daw-surface px-2 py-1 rounded border border-daw-border text-daw-muted">${artist.genre || 'No Genre'}</span>
                                    <span><i class="fa-solid fa-layer-group mr-1"></i> ID: ${artist.id.substring(0,8)}</span>
                                </div>
                            </div>
                            <div class="flex-1 flex min-h-0">
                                <div class="flex-1 overflow-y-auto p-8 bg-daw-bg border-r border-daw-border">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-lg font-bold text-white uppercase tracking-wider text-sm">Discography</h3>
                                        <button onclick="app.modalAddAlbum('${artist.id}')" class="text-xs bg-daw-surface hover:bg-daw-border text-white px-3 py-2 rounded border border-daw-border transition-colors font-bold uppercase tracking-wider"><i class="fa-solid fa-plus mr-1"></i> Add Release</button>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        ${albums.map(al => {
                                            let imgUrl = al.artworkBlob ? URL.createObjectURL(al.artworkBlob) : null;
                                            return `
                                            <div onclick="app.navigate('album-detail', {albumId: '${al.id}'})" class="bg-daw-panel border border-daw-border p-3 rounded hover:border-cyan-500/50 cursor-pointer group transition-all">
                                                <div class="aspect-square bg-daw-bg rounded mb-3 flex items-center justify-center text-daw-border overflow-hidden relative">
                                                    ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-compact-disc text-4xl opacity-20"></i>`}
                                                    <div class="absolute inset-0 bg-cyan-900/20 hidden group-hover:block"></div>
                                                </div>
                                                <div class="font-bold text-white truncate text-sm">${al.title}</div>
                                                <div class="text-[10px] text-daw-muted font-mono mt-1">${al.year} • ${this.getSongCount(al.id)} Tracks</div>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <div class="w-80 flex flex-col bg-daw-panel border-l border-daw-border">
                                    <div class="p-3 border-b border-daw-border bg-daw-surface"><h3 class="text-[10px] font-bold text-daw-muted uppercase tracking-widest">Engineer Notes</h3></div>
                                    <div class="flex-1 p-0"><textarea id="artist-notes" class="w-full h-full bg-daw-panel p-4 text-xs text-daw-text font-mono resize-none outline-none" placeholder="Vocal chain settings, model preferences...">${artist.notes || ''}</textarea></div>
                                    <div class="p-3 border-t border-daw-border"><button onclick="app.saveArtistNotes('${artist.id}')" id="save-artist-btn" class="w-full bg-daw-surface hover:bg-daw-border text-daw-muted hover:text-white text-xs font-bold py-2 rounded transition-colors uppercase">Update Notes</button></div>
                                </div>
                            </div>
                        </div>`;
                }

                renderAlbumDetail(container) {
                    const album = this.cache.albums.find(a => a.id === this.state.albumId); if (!album) return this.navigate('artists');
                    const artist = this.cache.artists.find(a => a.id === album.artistId);
                    const songs = this.cache.songs.filter(s => s.albumId === album.id).sort((a, b) => a.order - b.order);
                    const artUrl = album.artworkBlob ? URL.createObjectURL(album.artworkBlob) : null;
                    
                    container.innerHTML = `
                        <div class="flex flex-col h-full fade-in">
                            <div class="bg-daw-panel border-b border-daw-border p-6 flex items-center justify-between shrink-0">
                                <div class="flex items-center gap-6">
                                    <div onclick="app.triggerArtworkUpload('${album.id}')" class="w-24 h-24 bg-daw-bg rounded flex items-center justify-center cursor-pointer hover:opacity-80 overflow-hidden relative border border-daw-border group shadow-lg">
                                        ${artUrl ? `<img src="${artUrl}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-camera text-daw-muted text-2xl"></i>`}
                                        <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-[10px] text-white uppercase font-bold">Upload Art</div>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <button onclick="app.navigate('artist-detail', {artistId: '${artist.id}'})" class="text-[10px] text-cyan-500 font-bold uppercase tracking-wider hover:text-white transition-colors"><i class="fa-solid fa-arrow-left mr-1"></i> ${artist.name}</button>
                                        </div>
                                        <h1 class="text-3xl font-bold text-white font-mono tracking-tight">${album.title}</h1>
                                        <span class="text-xs text-daw-muted font-mono">${album.year} • LP Release</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button onclick="app.modalAddSong('${album.id}')" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded font-bold text-xs shadow-lg transition-colors uppercase tracking-wider"><i class="fa-solid fa-plus mr-1"></i> New Track</button>
                                    <button onclick="app.deleteAlbum('${album.id}')" class="text-daw-muted hover:text-red-400 px-3 py-2 transition-colors"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto bg-daw-bg">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-daw-surface text-[10px] font-bold text-daw-muted uppercase sticky top-0 z-10">
                                        <tr><th class="p-3 w-12 text-center">#</th><th class="p-3">Title</th><th class="p-3 w-32">Key/BPM</th><th class="p-3 w-32">Rating</th><th class="p-3 w-24 text-right">Edit</th></tr>
                                    </thead>
                                    <tbody class="text-sm text-daw-text divide-y divide-daw-border">
                                        ${songs.map((s, idx) => `
                                        <tr class="hover:bg-daw-surface/50 group transition-colors">
                                            <td class="p-3 text-center text-daw-muted font-mono text-xs">${idx + 1}</td>
                                            <td class="p-3">
                                                <a onclick="app.navigate('workstation', {songId: '${s.id}'})" class="font-bold text-white hover:text-cyan-400 cursor-pointer flex items-center gap-2 font-mono">
                                                    ${s.title} ${s.audioBlob ? '<i class="fa-solid fa-file-audio text-cyan-500 text-[10px]"></i>' : ''}
                                                </a>
                                            </td>
                                            <td class="p-3 text-xs font-mono text-daw-muted">${s.key || '-'} / ${s.bpm || '-'}</td>
                                            <td class="p-3 text-yellow-500 text-[10px]">${s.rating ? '★'.repeat(s.rating) : '<span class="text-daw-border">Unrated</span>'}</td>
                                            <td class="p-3 text-right text-xs">
                                                <button onclick="app.moveSong('${s.id}', -1)" class="text-daw-muted hover:text-white px-1"><i class="fa-solid fa-caret-up"></i></button>
                                                <button onclick="app.deleteSong('${s.id}')" class="text-daw-muted hover:text-red-400 px-1 ml-2"><i class="fa-solid fa-times"></i></button>
                                            </td>
                                        </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }

                renderWorkstation(container) {
                    const song = this.cache.songs.find(s => s.id === this.state.songId); if (!song) return this.navigate('artists');
                    const album = this.cache.albums.find(a => a.id === song.albumId);
                    const isLyrics = this.state.wsTab === 'lyrics';
                    const audioUrl = song.audioBlob ? URL.createObjectURL(song.audioBlob) : null;

                    container.innerHTML = `
                        <div class="flex h-full fade-in flex-col md:flex-row">
                            <div class="flex-1 flex flex-col border-r border-daw-border min-w-0 bg-daw-bg">
                                <div class="h-14 border-b border-daw-border bg-daw-panel px-4 flex items-center justify-between shrink-0">
                                    <div class="flex items-center gap-4">
                                        <button onclick="app.navigate('album-detail', {albumId: '${album.id}'})" class="text-daw-muted hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
                                        <span class="font-mono text-sm font-bold text-white">${song.title}</span>
                                        <div class="h-4 w-px bg-daw-border"></div>
                                        <div class="flex gap-2">
                                            <button onclick="app.setWsTab('lyrics')" class="px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider transition-all ${isLyrics ? 'bg-cyan-900/30 text-cyan-400 border border-cyan-500/30' : 'text-daw-muted hover:text-white'}">Lyrics & Struct</button>
                                            <button onclick="app.setWsTab('notes')" class="px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider transition-all ${!isLyrics ? 'bg-cyan-900/30 text-cyan-400 border border-cyan-500/30' : 'text-daw-muted hover:text-white'}">Tech & Mix</button>
                                        </div>
                                    </div>
                                    <button onclick="app.saveWorkstation()" id="save-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-1.5 rounded text-xs font-bold uppercase tracking-wider shadow-lg transition-all flex items-center gap-2">
                                        <i class="fa-solid fa-floppy-disk"></i> Save Project
                                    </button>
                                </div>

                                <div class="p-3 bg-daw-surface border-b border-daw-border">
                                    <div class="bg-daw-bg border border-daw-border rounded p-2 flex items-center gap-3 relative overflow-hidden group">
                                        ${audioUrl ? 
                                            `<div class="w-8 h-8 flex items-center justify-center bg-cyan-900/20 text-cyan-500 rounded"><i class="fa-solid fa-wave-square"></i></div>
                                             <audio controls src="${audioUrl}" class="flex-1 z-10"></audio>
                                             <button onclick="app.triggerAudioUpload('${song.id}')" class="text-[10px] text-daw-muted hover:text-white px-2 z-10 bg-daw-bg border border-daw-border py-1 rounded">Replace</button>` 
                                            : 
                                            `<div onclick="app.triggerAudioUpload('${song.id}')" class="w-full h-12 border-2 border-dashed border-daw-border hover:border-cyan-500/50 rounded flex items-center justify-center gap-2 cursor-pointer transition-colors text-daw-muted hover:text-cyan-400">
                                                <i class="fa-solid fa-upload"></i> <span class="text-xs font-mono uppercase">Drop Audio Reference / Master Here</span>
                                             </div>`
                                        }
                                    </div>
                                </div>

                                <div class="flex-1 relative bg-daw-bg">
                                    <div class="absolute inset-0 flex flex-col ${!isLyrics ? 'hidden' : ''}">
                                        <div class="px-4 py-2 bg-daw-bg border-b border-daw-border flex gap-2 overflow-x-auto scrollbar-hide">
                                            ${['[Intro]', '[Verse]', '[Chorus]', '[Bridge]', '[Outro]', '[Solo]', '[Break]'].map(t => `<button onclick="app.insertLyricTag('${t}')" class="px-2 py-1 bg-daw-surface hover:bg-daw-border text-[10px] text-cyan-200 font-mono rounded border border-daw-border whitespace-nowrap">${t}</button>`).join('')}
                                        </div>
                                        <textarea id="lyrics-editor" class="flex-1 w-full bg-daw-bg p-6 text-daw-text font-mono text-sm resize-none focus:outline-none focus:bg-daw-surface/10 leading-relaxed" placeholder="Enter lyrics and structure tags here...">${song.lyrics || ''}</textarea>
                                    </div>

                                    <div class="absolute inset-0 overflow-y-auto p-6 ${isLyrics ? 'hidden' : ''}">
                                        <div class="grid grid-cols-2 gap-6 mb-6">
                                            <div>
                                                <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Key</label>
                                                <input type="text" id="meta-key" value="${song.key || ''}" class="w-full bg-daw-surface border border-daw-border rounded p-2 text-xs font-mono text-white focus:border-cyan-500 outline-none" placeholder="e.g. C# Minor">
                                            </div>
                                            <div>
                                                <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Time Sig</label>
                                                <input type="text" id="meta-time" value="${song.timeSig || '4/4'}" class="w-full bg-daw-surface border border-daw-border rounded p-2 text-xs font-mono text-white focus:border-cyan-500 outline-none">
                                            </div>
                                            <div class="col-span-2">
                                                <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Seed / Generation ID</label>
                                                <input type="text" id="meta-seed" value="${song.seed || ''}" class="w-full bg-daw-surface border border-daw-border rounded p-2 text-xs font-mono text-cyan-400 focus:border-cyan-500 outline-none" placeholder="Paste generation ID from Suno/Udio">
                                            </div>
                                        </div>

                                        <div class="mb-6">
                                            <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Mix Issues (Flag)</label>
                                            <div class="flex flex-wrap gap-2">
                                                ${MIX_TAGS.map(tag => {
                                                    const isActive = (song.mixTags || []).includes(tag);
                                                    return `<button onclick="app.toggleMixTag('${tag}')" class="text-[10px] px-2 py-1 rounded border transition-all ${isActive ? 'bg-red-900/30 border-red-500 text-red-200' : 'bg-daw-surface border-daw-border text-daw-muted hover:text-white'}">${tag}</button>`;
                                                }).join('')}
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Engineer's Log</label>
                                            <textarea id="notes-editor" class="w-full h-40 bg-daw-surface border border-daw-border rounded p-4 text-daw-text font-mono text-xs resize-none outline-none focus:border-cyan-500">${song.notes || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="w-96 bg-daw-panel border-l border-daw-border flex flex-col shrink-0">
                                <div class="p-4 border-b border-daw-border bg-daw-surface">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-[10px] font-bold text-cyan-500 uppercase tracking-widest">Signal Chain (Prompt)</label>
                                        <button onclick="app.copyPrompt()" class="text-xs text-daw-muted hover:text-white"><i class="fa-regular fa-copy"></i></button>
                                    </div>
                                    <div id="active-prompt-display" class="bg-black/50 border border-daw-border rounded p-3 text-xs text-cyan-100 font-mono mb-3 min-h-[3rem] break-words"></div>
                                    <div class="flex gap-2">
                                        <select id="style-preset-select" onchange="app.applyPresetStyle(this.value)" class="flex-1 bg-daw-bg text-[10px] text-white border border-daw-border rounded px-2 py-1 outline-none font-mono">
                                            <option value="">Load Preset...</option>
                                            ${this.cache.styles.map(st => `<option value="${st.id}">${st.name}</option>`).join('')}
                                        </select>
                                        <button onclick="app.saveCurrentStyleToLibrary()" class="bg-daw-border hover:bg-daw-surface text-daw-muted hover:text-white px-2 rounded" title="Save Preset"><i class="fa-solid fa-bookmark"></i></button>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-hidden flex flex-col" id="style-builder-container"></div>
                            </div>
                        </div>`;
                    
                    // Attach listeners
                    const lyricEd = document.getElementById('lyrics-editor');
                    if (lyricEd) lyricEd.addEventListener('input', (e) => { song.lyrics = e.target.value; });

                    // Attach Metadata listeners
                    ['key', 'time', 'seed'].forEach(f => {
                         const el = document.getElementById(`meta-${f}`);
                         if(el) el.addEventListener('input', (e) => { song[f === 'time' ? 'timeSig' : f] = e.target.value; });
                    });
                     const notesEd = document.getElementById('notes-editor');
                     if (notesEd) notesEd.addEventListener('input', (e) => { song.notes = e.target.value; });

                    this.renderTagBuilder(document.getElementById('style-builder-container'), song.customTags || [], song.bpm || 120, (tags, bpm) => {
                        song.customTags = tags;
                        song.bpm = bpm;
                        this.updatePromptDisplay(tags, bpm);
                    });
                    this.updatePromptDisplay(song.customTags || [], song.bpm);
                }

               renderTagBuilder(container, initialTags, initialBpm, onChange) {
    let activeCat = Object.keys(TAG_LIBRARY)[0];
    let tags = [...initialTags];
    let bpm = initialBpm;

    // HELPER: Create safe IDs (removes spaces, &, etc)
    const safeId = (str) => 'cat-' + str.replace(/[^a-zA-Z0-9]/g, '');

    const render = () => {
        const activeSubCats = TAG_LIBRARY[activeCat];
        
        // Tag Chips
        const activeTagsHtml = tags.map(t => 
            `<span class="inline-flex items-center gap-1 bg-cyan-900/40 text-cyan-200 border border-cyan-500/30 px-2 py-1 rounded text-[10px] font-mono shadow-sm animate-[fadeIn_0.1s]">
                ${t} <button onclick="app.removeTag('${t}')" class="hover:text-white"><i class="fa-solid fa-times"></i></button>
            </span>`
        ).join('');

        container.innerHTML = `
            <div class="flex flex-1 min-h-0">
                <div class="w-20 bg-daw-panel border-r border-daw-border overflow-y-auto shrink-0 flex flex-col">
                    ${Object.keys(TAG_LIBRARY).map(cat => 
                        // USE safeId HERE
                        `<button id="${safeId(cat)}" class="w-full text-center py-4 text-[9px] font-bold uppercase hover:bg-daw-surface transition-colors flex flex-col items-center gap-1 ${activeCat === cat ? 'text-cyan-400 bg-daw-bg border-l-2 border-cyan-500' : 'text-daw-muted border-l-2 border-transparent'}">
                            <i class="fa-solid fa-${cat.includes('Instruments') ? 'guitar' : cat.includes('Vibe') ? 'cloud' : cat.includes('Genre') ? 'music' : 'microphone'} text-lg mb-1"></i>
                            ${cat.split(' ')[0]}
                        </button>`
                    ).join('')}
                </div>
                <div class="flex-1 overflow-y-auto p-4 bg-daw-bg">
                    <div class="mb-4 flex flex-wrap gap-2 min-h-[40px] p-2 bg-daw-surface/50 rounded border border-daw-border border-dashed">
                        ${activeTagsHtml || '<span class="text-[10px] text-daw-muted italic self-center">No modules active...</span>'}
                    </div>

                    ${Object.entries(activeSubCats).map(([sub, tagList]) => `
                        <div class="mb-5">
                            <h4 class="text-[10px] font-bold text-daw-muted uppercase mb-2 border-b border-daw-border pb-1">${sub}</h4>
                            <div class="grid grid-cols-2 gap-2">
                                ${tagList.map(t => {
                                    const isActive = tags.includes(t);
                                    return `<button class="tag-btn text-[10px] text-left px-2 py-1.5 rounded border transition-all truncate ${isActive ? 'bg-cyan-600 text-white border-cyan-500' : 'bg-daw-surface text-daw-muted border-daw-border hover:border-daw-muted'}" data-tag="${t}">${t}</button>`;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="h-auto border-t border-daw-border bg-daw-panel p-4 shrink-0">
                <div class="flex items-center gap-3 mb-3 bg-daw-surface p-2 rounded border border-daw-border">
                    <div class="w-10 h-10 rounded-full border-2 border-cyan-500 flex items-center justify-center text-[10px] font-bold text-white bg-daw-bg shadow-[0_0_10px_rgba(6,182,212,0.3)]">${bpm}</div>
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-daw-muted uppercase block mb-1">Tempo (BPM)</label>
                        <input type="range" min="60" max="200" value="${bpm}" class="w-full" id="bpm-input">
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="custom-tag" placeholder="Custom module..." class="flex-1 bg-daw-bg border border-daw-border rounded px-3 py-1 text-xs text-white outline-none focus:border-cyan-500 font-mono">
                    <button id="add-custom-btn" class="bg-daw-surface hover:bg-daw-border text-white px-3 py-1 rounded text-xs border border-daw-border"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        `;

        // Re-attach listeners using safeId
        Object.keys(TAG_LIBRARY).forEach(cat => {
            const btn = container.querySelector(`#${safeId(cat)}`);
            if(btn) btn.addEventListener('click', () => { activeCat = cat; render(); });
        });

        // Other listeners
        container.querySelectorAll('.tag-btn').forEach(btn => btn.addEventListener('click', () => { 
            const t = btn.dataset.tag; 
            if (tags.includes(t)) tags = tags.filter(x => x !== t); else tags.push(t); 
            onChange(tags, bpm); render(); 
        }));
        container.querySelector('#bpm-input').addEventListener('input', (e) => { 
            bpm = parseInt(e.target.value); 
            onChange(tags, bpm);
            container.querySelector('.rounded-full').textContent = bpm;
        });
        container.querySelector('#add-custom-btn').addEventListener('click', () => { 
            const val = container.querySelector('#custom-tag').value.trim(); 
            if (val && !tags.includes(val)) { tags.push(val); onChange(tags, bpm); render(); } 
        });
    };
    render();
}
                }

                // --- LOGIC: Workstation Saving & Management ---

                async saveWorkstation() {
                    if (!this.state.songId) return;
                    
                    const btn = document.getElementById('save-btn');
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...`;
                    btn.disabled = true;

                    try {
                        const song = this.cache.songs.find(s => s.id === this.state.songId);
                        // Fields are already updated in memory via 'input' event listeners
                        song.updatedAt = Date.now();
                        
                        await this.db.put('songs', song);
                        
                        this.showToast('Project saved successfully', 'success');
                        setTimeout(() => {
                            btn.innerHTML = `<i class="fa-solid fa-check"></i> Saved`;
                            setTimeout(() => {
                                btn.innerHTML = originalContent;
                                btn.disabled = false;
                            }, 1500);
                        }, 500);
                    } catch (error) {
                        console.error("Save Error", error);
                        this.showToast('Save failed: ' + error.message, 'error');
                        btn.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Error`;
                        btn.disabled = false;
                    }
                }

                updatePromptDisplay(tags, bpm) { 
                    const el = document.getElementById('active-prompt-display'); 
                    if (el) { 
                        const all = [...tags]; 
                        if (bpm) all.push(`${bpm} bpm`); 
                        el.textContent = all.join(', '); 
                    } 
                }

                removeTag(tagToRemove) {
                    const song = this.cache.songs.find(s => s.id === this.state.songId);
                    if (song && song.customTags) {
                        song.customTags = song.customTags.filter(t => t !== tagToRemove);
                        this.updatePromptDisplay(song.customTags, song.bpm);
                        this.render(); // Re-render to update prompt builder state
                    }
                }

                insertLyricTag(tag) {
                    const ta = document.getElementById('lyrics-editor');
                    if (!ta) return;
                    const start = ta.selectionStart;
                    const end = ta.selectionEnd;
                    const txt = ta.value;
                    const before = txt.substring(0, start);
                    const after = txt.substring(end);
                    
                    // Smart spacing
                    const needsNewline = start > 0 && txt[start - 1] !== '\n';
                    
                    ta.value = before + (needsNewline ? '\n' : '') + tag + '\n' + after;
                    
                    // Update model
                    const song = this.cache.songs.find(s => s.id === this.state.songId);
                    if (song) song.lyrics = ta.value;
                    
                    ta.focus();
                    ta.selectionStart = ta.selectionEnd = start + tag.length + (needsNewline ? 1 : 0) + 1;
                }

                toggleMixTag(tag) {
                    const song = this.cache.songs.find(s => s.id === this.state.songId);
                    if (song) {
                        if (!song.mixTags) song.mixTags = [];
                        if (song.mixTags.includes(tag)) song.mixTags = song.mixTags.filter(t => t !== tag);
                        else song.mixTags.push(tag);
                        this.render(); 
                    }
                }

                // --- LOGIC: Styles ---
                renderStyleManager(container) {
                    container.innerHTML = `
                        <div class="flex h-full fade-in">
                            <div class="w-72 bg-daw-panel border-r border-daw-border flex flex-col">
                                <div class="p-6 border-b border-daw-border flex justify-between items-center bg-daw-surface">
                                    <h2 class="text-xs font-bold text-white uppercase tracking-widest">User Presets</h2>
                                    <button onclick="app.createStyle()" class="text-[10px] bg-cyan-600 px-3 py-1.5 rounded text-white hover:bg-cyan-500 font-bold uppercase tracking-wider"><i class="fa-solid fa-plus mr-1"></i> New</button>
                                </div>
                                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                    ${this.cache.styles.map(s => `
                                        <button onclick="app.editStyle('${s.id}')" class="w-full text-left px-4 py-3 rounded text-sm text-daw-muted hover:bg-daw-surface hover:text-white transition-all flex items-center gap-3 group border border-transparent hover:border-daw-border">
                                            <div class="w-8 h-8 rounded bg-daw-bg flex items-center justify-center text-cyan-500 border border-daw-border font-mono text-xs"><i class="fa-solid fa-sliders"></i></div>
                                            <div class="flex-1 truncate">
                                                <div class="font-bold text-white truncate text-xs font-mono uppercase">${s.name}</div>
                                                <div class="text-[10px] text-daw-muted truncate">${s.bpm} BPM • ${s.tags ? s.tags.length : 0} Mods</div>
                                            </div>
                                        </button>`).join('')}
                                </div>
                            </div>
                            <div class="flex-1 bg-daw-bg flex flex-col" id="style-editor-area">
                                <div class="flex-1 flex flex-col items-center justify-center text-daw-border">
                                    <i class="fa-solid fa-sliders text-6xl mb-4 opacity-20"></i>
                                    <p class="text-sm font-mono text-daw-muted">Select a preset to tune parameters.</p>
                                </div>
                            </div>
                        </div>`;
                }

                editStyle(id) { const style = this.cache.styles.find(s => s.id === id); this.renderStyleEditor(style); }
                createStyle() { this.renderStyleEditor(null); }
                renderStyleEditor(style) {
                    const container = document.getElementById('style-editor-area');
                    this.tempStyle = style ? { ...style } : { id: generateID(), name: 'Init Preset', tags: [], bpm: 120 };
                    container.innerHTML = `
                        <div class="h-16 border-b border-daw-border flex items-center px-6 justify-between bg-daw-panel">
                            <div class="flex items-center gap-4 w-1/2">
                                <label class="text-[10px] uppercase font-bold text-daw-muted">Preset Name</label>
                                <input type="text" id="se-name" value="${this.tempStyle.name}" class="bg-daw-bg text-sm font-mono text-white border border-daw-border rounded px-3 py-1 focus:border-cyan-500 outline-none w-full">
                            </div>
                            <div class="flex gap-2">
                                ${style ? `<button onclick="app.deleteStyle('${style.id}')" class="text-daw-muted hover:text-red-500 px-3"><i class="fa-solid fa-trash"></i></button>` : ''}
                                <button onclick="app.saveStyleFromEditor()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-5 py-2 rounded font-bold text-xs uppercase tracking-wider shadow-lg">Save Preset</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden flex flex-col p-6" id="se-builder"></div>
                    `;
                    this.renderTagBuilder(document.getElementById('se-builder'), this.tempStyle.tags, this.tempStyle.bpm, (tags, bpm) => { 
                        this.tempStyle.tags = tags; 
                        this.tempStyle.bpm = bpm; 
                    });
                    document.getElementById('se-name').addEventListener('input', (e) => this.tempStyle.name = e.target.value);
                }
                
                async saveStyleFromEditor() {
                    await this.db.put('styles', this.tempStyle);
                    await this.refreshCache();
                    this.showToast('Preset Saved');
                    this.render(); // Refresh list
                }

                async deleteStyle(id) {
                    if(!confirm("Delete this style preset?")) return;
                    await this.db.delete('styles', id);
                    await this.refreshCache();
                    this.render();
                }

                saveCurrentStyleToLibrary() {
                    const song = this.cache.songs.find(s => s.id === this.state.songId);
                    if (!song) return;
                    const modal = document.getElementById('generic-modal');
                    document.getElementById('modal-title').textContent = 'Save Patch';
                    document.getElementById('modal-content').innerHTML = `
                        <label class="block text-[10px] font-bold text-daw-muted uppercase mb-2">Preset Name</label>
                        <input type="text" id="new-style-name" class="w-full bg-daw-bg border border-daw-border rounded px-3 py-2 text-white font-mono text-sm focus:border-cyan-500 outline-none" placeholder="e.g., Deep House Bass v2">
                    `;
                    modal.classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = async () => {
                        const name = document.getElementById('new-style-name').value.trim();
                        if (!name) return;
                        const style = {
                            id: generateID(),
                            name: name,
                            tags: song.customTags || [],
                            bpm: song.bpm || 120,
                            createdAt: Date.now()
                        };
                        await this.db.put('styles', style);
                        await this.refreshCache();
                        this.closeModal();
                        this.showToast("Preset Saved to Library");
                    };
                }
                
                applyPresetStyle(styleId) {
                    if(!styleId) return;
                    const style = this.cache.styles.find(s => s.id === styleId);
                    const song = this.cache.songs.find(s => s.id === this.state.songId);
                    if(style && song) {
                        if(confirm(`Overwrite current settings with preset "${style.name}"?`)) {
                            song.customTags = [...style.tags];
                            song.bpm = style.bpm;
                            this.render(); // Re-render workstation
                            this.showToast("Preset Loaded");
                        }
                    }
                }

                // --- Helpers ---
                setWsTab(tab) { this.state.wsTab = tab; this.render(); }
                getSongCount(albumId) { return this.cache.songs.filter(s => s.albumId === albumId).length; }
                
                async deleteArtist(id) { 
                    if (!confirm('Delete Artist and all associated data?')) return; 
                    const albums = this.cache.albums.filter(a => a.artistId === id); 
                    for (const alb of albums) await this.deleteAlbum(alb.id, true); 
                    await this.db.delete('artists', id); 
                    await this.refreshCache(); 
                    this.navigate('artists'); 
                }
                async deleteAlbum(id, skipConfirm = false) { 
                    if (!skipConfirm && !confirm('Delete Album?')) return; 
                    const songs = this.cache.songs.filter(s => s.albumId === id); 
                    for (const s of songs) await this.db.delete('songs', s.id); 
                    await this.db.delete('albums', id); 
                    if (!skipConfirm) { await this.refreshCache(); this.navigate('artist-detail', { artistId: this.state.artistId }); } 
                }
                async deleteSong(id) { 
                    if (!confirm('Delete Song?')) return; 
                    await this.db.delete('songs', id); 
                    await this.refreshCache(); 
                    this.navigate('album-detail', { albumId: this.state.albumId }); 
                }
                
                // --- Modals & Uploads ---
                triggerArtworkUpload(albumId) { 
                    const input = document.getElementById('global-file-input'); 
                    input.accept = "image/*"; 
                    input.onchange = (e) => { 
                        const file = e.target.files[0]; 
                        if (!file) return; 
                        const album = this.cache.albums.find(a => a.id === albumId); 
                        if (album) { album.artworkBlob = file; this.db.put('albums', album).then(() => { this.refreshCache().then(() => this.render()); }); } 
                    }; 
                    input.click(); 
                }
                triggerAudioUpload(songId) { 
                    const input = document.getElementById('global-file-input'); 
                    input.accept = "audio/*"; 
                    input.onchange = (e) => { 
                        const file = e.target.files[0]; 
                        if (!file) return; 
                        const song = this.cache.songs.find(s => s.id === songId); 
                        if (song) { song.audioBlob = file; this.db.put('songs', song).then(() => { this.refreshCache().then(() => this.render()); }); } 
                    }; 
                    input.click(); 
                }
                
                modalAddArtist() {
                    const modal = document.getElementById('generic-modal');
                    document.getElementById('modal-title').textContent = 'New Artist / Band';
                    document.getElementById('modal-content').innerHTML = `
                        <div class="space-y-4">
                            <div><label class="block text-[10px] font-bold text-daw-muted uppercase mb-1">Name</label><input id="new-artist-name" class="w-full bg-daw-bg border border-daw-border rounded p-2 text-white outline-none focus:border-cyan-500"></div>
                            <div><label class="block text-[10px] font-bold text-daw-muted uppercase mb-1">Primary Genre</label><input id="new-artist-genre" class="w-full bg-daw-bg border border-daw-border rounded p-2 text-white outline-none focus:border-cyan-500"></div>
                        </div>`;
                    modal.classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = async () => {
                        const name = document.getElementById('new-artist-name').value;
                        const genre = document.getElementById('new-artist-genre').value;
                        if (!name) return;
                        await this.db.put('artists', { id: generateID(), name, genre, createdAt: Date.now() });
                        await this.refreshCache();
                        this.closeModal();
                        this.navigate('artists');
                    };
                }
                
                modalAddAlbum(artistId) {
                    const modal = document.getElementById('generic-modal');
                    document.getElementById('modal-title').textContent = 'New Release';
                    document.getElementById('modal-content').innerHTML = `
                        <div class="space-y-4">
                            <div><label class="block text-[10px] font-bold text-daw-muted uppercase mb-1">Title</label><input id="new-album-title" class="w-full bg-daw-bg border border-daw-border rounded p-2 text-white outline-none focus:border-cyan-500"></div>
                            <div><label class="block text-[10px] font-bold text-daw-muted uppercase mb-1">Year</label><input id="new-album-year" type="number" value="${new Date().getFullYear()}" class="w-full bg-daw-bg border border-daw-border rounded p-2 text-white outline-none focus:border-cyan-500"></div>
                        </div>`;
                    modal.classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = async () => {
                        const title = document.getElementById('new-album-title').value;
                        const year = document.getElementById('new-album-year').value;
                        if (!title) return;
                        const id = generateID();
                        await this.db.put('albums', { id, artistId, title, year, createdAt: Date.now() });
                        await this.refreshCache();
                        this.closeModal();
                        this.navigate('album-detail', { albumId: id });
                    };
                }

                modalAddSong(albumId) {
                     const modal = document.getElementById('generic-modal');
                    document.getElementById('modal-title').textContent = 'New Track';
                    document.getElementById('modal-content').innerHTML = `
                        <div><label class="block text-[10px] font-bold text-daw-muted uppercase mb-1">Track Title</label><input id="new-song-title" class="w-full bg-daw-bg border border-daw-border rounded p-2 text-white outline-none focus:border-cyan-500"></div>`;
                    modal.classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = async () => {
                        const title = document.getElementById('new-song-title').value;
                        if (!title) return;
                        const id = generateID();
                        const count = this.getSongCount(albumId);
                        await this.db.put('songs', { id, albumId, title, order: count + 1, createdAt: Date.now() });
                        await this.refreshCache();
                        this.closeModal();
                        this.navigate('workstation', { songId: id });
                    };
                }

                closeModal() { document.getElementById('generic-modal').classList.add('hidden'); }
                copyPrompt() { 
                    const text = document.getElementById('active-prompt-display').textContent;
                    navigator.clipboard.writeText(text).then(() => this.showToast('Prompt copied to clipboard'));
                }
                
                // --- Settings / Library (Simplified) ---
                renderLibrary(container) {
                    // Similar to artists list but for songs
                     let allSongs = this.cache.songs.map(song => { const album = this.cache.albums.find(a => a.id === song.albumId); const artist = album ? this.cache.artists.find(a => a.id === album.artistId) : null; return { ...song, albumName: album ? album.title : 'Unknown', artistName: artist ? artist.name : 'Unknown', artistId: artist ? artist.id : null, albumId: album ? album.id : null, year: album ? album.year : '' }; });
                    allSongs.sort((a, b) => a.artistName.localeCompare(b.artistName));
                    container.innerHTML = `<div class="flex flex-col h-full fade-in"><div class="p-6 bg-daw-panel border-b border-daw-border shrink-0"><h2 class="text-2xl font-bold text-white mb-2 font-mono">MASTER LIBRARY</h2></div><div class="flex-1 overflow-y-auto p-0"><table class="w-full text-left border-collapse"><thead class="bg-daw-surface text-[10px] font-bold text-daw-muted uppercase sticky top-0 z-10 shadow-sm"><tr><th class="p-4 border-b border-daw-border">Artist</th><th class="p-4 border-b border-daw-border">Song</th><th class="p-4 border-b border-daw-border w-32">Rating</th><th class="p-4 border-b border-daw-border w-32 text-right">Actions</th></tr></thead><tbody class="text-sm text-daw-text divide-y divide-daw-border bg-daw-bg">${allSongs.map(s => `<tr class="hover:bg-daw-surface/50 group transition-colors"><td class="p-4 font-medium text-white">${s.artistName}</td><td class="p-4 font-bold text-cyan-100 font-mono">${s.title}</td><td class="p-4 text-yellow-500 text-[10px]">${s.rating ? '★'.repeat(s.rating) : ''}</td><td class="p-4 text-right"><button onclick="app.navigate('workstation', {songId: '${s.id}'})" class="text-[10px] bg-daw-surface hover:text-white text-daw-muted px-3 py-1.5 rounded transition-colors border border-daw-border uppercase font-bold">Open Session</button></td></tr>`).join('')}</tbody></table></div></div>`;
                }

                renderSettings(container) {
                    container.innerHTML = `<div class="flex flex-col h-full fade-in p-8"><h2 class="text-3xl font-bold text-white mb-2 font-mono">SYSTEM DATA</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mt-8"><div class="bg-daw-panel border border-daw-border rounded-xl p-6 relative group hover:border-cyan-500/50 transition-colors"><h3 class="text-lg font-bold text-white font-mono mb-2">JSON Export</h3><p class="text-sm text-daw-muted mb-6">Download full database dump for backup or automation.</p><button onclick="app.downloadBackup()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-colors flex items-center justify-center gap-2 text-xs uppercase tracking-wider"><i class="fa-solid fa-download"></i> Download Payload</button></div></div></div>`;
                }
                
                async downloadBackup() { 
                    const json = await this.db.exportAll(); 
                    constblob = new Blob([json], { type: 'application/json' }); 
                    const url = URL.createObjectURL(blob); 
                    const a = document.createElement('a'); 
                    a.href = url; 
                    a.download = `suno_companion_backup_${new Date().toISOString().split('T')[0]}.json`; 
                    a.click(); 
                }
            }

            const app = new App();
        });
    </script>
</body>
</html>




