<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suno Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Modern Glass Theme */
        :root {
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
            --neon-purple: #a855f7;
            --neon-blue: #3b82f6;
            --neon-pink: #ec4899;
        }

        body {
            background-color: #020617;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(168, 85, 247, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.08), transparent 25%);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: #e2e8f0;
            overscroll-behavior: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Glass Panel Utility */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
        }

        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
        }

        /* Tabs Animation */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modern Range Slider */
        /* Modern Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            height: 24px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #f8fafc;
            border: 2px solid var(--neon-purple);
            margin-top: -6px;
            box-shadow: 0 0 10px var(--neon-purple);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Selection States */
        /* Replaced .btn-selected-* with utility classes in JS, but keeping helper classes if needed for specificity overrides */
        .selected-ring-purple {
            box-shadow: 0 0 0 2px var(--neon-purple);
            background: rgba(168, 85, 247, 0.2);
            color: white;
        }

        .selected-ring-blue {
            box-shadow: 0 0 0 2px var(--neon-blue);
            background: rgba(59, 130, 246, 0.2);
            color: white;
        }

        .selected-ring-pink {
            box-shadow: 0 0 0 2px var(--neon-pink);
            background: rgba(236, 72, 153, 0.2);
            color: white;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col selection:bg-purple-500/30 selection:text-white">

    <!-- Header -->
    <header class="glass-header sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center shadow-lg shadow-purple-500/20">
                    <i data-lucide="music" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1
                        class="font-bold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                        Suno Architect</h1>
                </div>
            </div>

            <!-- Scrollable Nav -->
            <nav class="flex-1 overflow-x-auto no-scrollbar mask-gradient-x">
                <div class="flex space-x-1 p-1">
                    <button onclick="switchTab('artist')" id="tab-btn-artist"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        Artist
                    </button>
                    <button onclick="switchTab('dials')" id="tab-btn-dials"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        Tuner
                    </button>
                    <button onclick="switchTab('style')" id="tab-btn-style"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        Blueprint
                    </button>
                    <button onclick="switchTab('lyrics')" id="tab-btn-lyrics"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        Lyrics
                    </button>
                    <button onclick="switchTab('library')" id="tab-btn-library"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        Library
                    </button>
                    <button onclick="switchTab('json')" id="tab-btn-json"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap">
                        JSON
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-6 space-y-8">
        <!-- TAB: ARTIST -->
        <div id="tab-artist" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Artist Creator -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="glass-panel p-6 space-y-6">
                        <div class="flex items-center gap-3 pb-4 border-b border-white/5">
                            <div
                                class="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400">
                                <i data-lucide="mic-2" class="w-4 h-4"></i>
                            </div>
                            <h2 class="text-sm font-bold uppercase tracking-wider text-slate-300">Artist Builder</h2>
                        </div>

                        <div class="space-y-4">
                            <div class="space-y-1.5">
                                <label
                                    class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</label>
                                <input type="text" id="artist-name" placeholder="E.g. Neon Horizon"
                                    class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3 text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/50 transition-all">
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Bio /
                                    Notes</label>
                                <textarea id="artist-bio" placeholder="Signature sound characteristic..."
                                    class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3 text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/50 transition-all h-24 resize-none"></textarea>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Signature
                                    Exclusions</label>
                                <input type="text" id="artist-exclusions" placeholder="Never uses... (e.g. Male Vocals)"
                                    class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3 text-red-300 placeholder:text-slate-600 focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all"
                                    oninput="updateExclusions(this.value)">
                            </div>

                            <div class="bg-black/20 rounded-xl p-4 border border-white/5">
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                                    <i data-lucide="activity" class="w-3 h-3"></i> Current Sound Profile
                                </h4>
                                <div id="artist-preview-stats" class="space-y-2 text-xs font-mono text-slate-400">
                                    <!-- JS Populated -->
                                    <p class="italic text-slate-600">Configure settings in Tuner or Blueprint first...
                                    </p>
                                </div>
                            </div>

                            <button onclick="saveArtist()"
                                class="w-full py-4 rounded-xl bg-gradient-to-r from-pink-600 to-rose-600 text-white font-bold shadow-lg shadow-pink-900/40 hover:scale-[1.02] active:scale-[0.98] transition-all">
                                Capture Artist Profile
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Artist Roster -->
                <div class="lg:col-span-7">
                    <div class="glass-panel p-6 h-full min-h-[500px] flex flex-col">
                        <div class="flex items-center justify-between pb-4 border-b border-white/5 mb-4">
                            <h3 class="font-bold text-slate-200 flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4 text-slate-400"></i>
                                Artist Roster
                            </h3>
                            <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Saved
                                Profiles</span>
                        </div>

                        <div id="artist-list" class="flex-1 space-y-3 overflow-y-auto pr-2 custom-scrollbar">
                            <!-- JS Populated -->
                            <div class="flex flex-col items-center justify-center h-40 text-slate-600 italic">
                                <i data-lucide="ghost" class="w-8 h-8 mb-2 opacity-20"></i>
                                <span>No artists signed yet</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: TUNER (Dials) -->
        <div id="tab-dials" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Controls -->
                <div class="lg:col-span-7 space-y-6">

                    <!-- Genre Select -->
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-4">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Base
                                Foundation</label>
                            <span class="text-[10px] text-slate-500">Select Primary Genre</span>
                        </div>

                        <!-- Filter Chips -->
                        <div id="dial-category-filters" class="flex flex-wrap gap-2 mb-4">
                            <!-- JS Injected -->
                        </div>

                        <div class="relative group">
                            <select id="dial-genre-select" onchange="updateDials()"
                                class="w-full appearance-none bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-3 text-slate-200 focus:outline-none focus:border-purple-500/50 transition-all font-medium">
                                <option value="">Select Base Genre...</option>
                                <!-- JS Populated -->
                            </select>
                            <div
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none group-hover:text-purple-400 transition-colors">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Faders -->
                    <div class="glass-panel p-8 space-y-8">
                        <!-- Weirdness -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-end">
                                <label
                                    class="flex items-center gap-2 text-sm font-bold text-purple-400 uppercase tracking-wider">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i> Innovation
                                </label>
                                <span id="tags-weirdness"
                                    class="text-xs font-mono text-purple-300 bg-purple-500/10 px-2 py-1 rounded border border-purple-500/20">Standard</span>
                            </div>
                            <input type="range" id="dial-weirdness" min="0" max="100" value="0" oninput="updateDials()"
                                class="w-full">
                            <div
                                class="flex justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                                <span>Safe</span>
                                <span>Experimental</span>
                            </div>
                        </div>

                        <!-- Era -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-end">
                                <label
                                    class="flex items-center gap-2 text-sm font-bold text-emerald-400 uppercase tracking-wider">
                                    <i data-lucide="history" class="w-4 h-4"></i> Texture
                                </label>
                                <span id="tags-era"
                                    class="text-xs font-mono text-emerald-300 bg-emerald-500/10 px-2 py-1 rounded border border-emerald-500/20">Clean</span>
                            </div>
                            <input type="range" id="dial-era" min="0" max="100" value="50" oninput="updateDials()"
                                class="w-full">
                            <div
                                class="flex justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                                <span>Vintage</span>
                                <span>Future</span>
                            </div>
                        </div>

                        <!-- Intensity -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-end">
                                <label
                                    class="flex items-center gap-2 text-sm font-bold text-yellow-400 uppercase tracking-wider">
                                    <i data-lucide="zap" class="w-4 h-4"></i> Energy
                                </label>
                                <span id="tags-intensity"
                                    class="text-xs font-mono text-yellow-300 bg-yellow-500/10 px-2 py-1 rounded border border-yellow-500/20">Balanced</span>
                            </div>
                            <input type="range" id="dial-intensity" min="0" max="100" value="50" oninput="updateDials()"
                                class="w-full">
                            <div
                                class="flex justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                                <span>Chill</span>
                                <span>Hype</span>
                            </div>
                        </div>

                        <!-- Tempo -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-end">
                                <label
                                    class="flex items-center gap-2 text-sm font-bold text-red-400 uppercase tracking-wider">
                                    <i data-lucide="gauge" class="w-4 h-4"></i> Speed
                                </label>
                                <span id="tags-tempo"
                                    class="text-xs font-mono text-red-300 bg-red-500/10 px-2 py-1 rounded border border-red-500/20">Mid</span>
                            </div>
                            <input type="range" id="dial-tempo" min="0" max="100" value="50" oninput="updateDials()"
                                class="w-full">
                            <div
                                class="flex justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                                <span>Slow</span>
                                <span>Fast</span>
                            </div>
                        </div>

                        <!-- Vocals -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-end">
                                <label
                                    class="flex items-center gap-2 text-sm font-bold text-blue-400 uppercase tracking-wider">
                                    <i data-lucide="mic" class="w-4 h-4"></i> Vocals
                                </label>
                                <span id="tags-vocals"
                                    class="text-xs font-mono text-blue-300 bg-blue-500/10 px-2 py-1 rounded border border-blue-500/20">Standard</span>
                            </div>
                            <input type="range" id="dial-vocals" min="0" max="100" value="75" oninput="updateDials()"
                                class="w-full">
                            <div
                                class="flex justify-between text-[10px] text-slate-500 font-mono uppercase tracking-widest">
                                <span>Instrumental</span>
                                <span>Lyrical</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview -->
                <div class="lg:col-span-5">
                    <div class="glass-panel p-6 sticky top-24 border-t-4 border-t-purple-500">
                        <div class="flex items-center justify-between mb-6">
                            <h3
                                class="text-sm font-bold uppercase tracking-widest text-slate-300 flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_red]"></div>
                                Live Profile
                            </h3>
                        </div>

                        <div class="space-y-4 font-mono text-xs">
                            <!-- Preview Rows (Cleaned up) -->
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-slate-500 uppercase">Base</span>
                                <span id="preview-genre" class="text-slate-200">...</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-purple-500 uppercase">Innovation</span>
                                <span id="preview-weirdness" class="text-purple-300 text-right">...</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-emerald-500 uppercase">Texture</span>
                                <span id="preview-era" class="text-emerald-300 text-right">...</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-yellow-500 uppercase">Energy</span>
                                <span id="preview-intensity" class="text-yellow-300 text-right">...</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-red-500 uppercase">Speed</span>
                                <span id="preview-tempo" class="text-red-300 text-right">...</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/5 pb-2">
                                <span class="text-blue-500 uppercase">Vocals</span>
                                <span id="preview-vocals" class="text-blue-300 text-right">...</span>
                            </div>
                        </div>

                        <button onclick="applyDialsToMain()"
                            class="mt-8 w-full py-4 rounded-xl relative overflow-hidden group bg-slate-800 border border-slate-700 hover:border-purple-500 transition-all">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                            </div>
                            <span
                                class="relative z-10 font-bold text-slate-300 group-hover:text-white uppercase tracking-wider text-xs flex items-center justify-center gap-2">
                                Send to Blueprint <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: BLUEPRINT -->
        <div id="tab-style" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left Column: Controls -->
                <div class="lg:col-span-7 space-y-6 pb-20">
                    <!-- Genre Section -->
                    <section class="glass-panel p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="list-music" class="w-5 h-5 text-purple-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">1. Foundation</h2>
                        </div>
                        <div id="genre-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                            <!-- JS will inject genres here -->
                        </div>
                        <div id="subgenre-wrapper" class="hidden bg-slate-950/30 p-4 rounded-xl border border-white/5">
                            <p class="text-xs text-slate-500 mb-3 uppercase tracking-wider font-semibold">Subgenres</p>
                            <div id="subgenre-container" class="flex flex-wrap gap-2">
                                <!-- JS will inject subgenres here -->
                            </div>
                        </div>
                    </section>

                    <!-- Instruments & Voice -->
                    <section class="glass-panel p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="mic-vocal" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">2. The Players</h2>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <p class="text-xs text-slate-500 mb-2 uppercase tracking-wider font-semibold">Vocals</p>
                                <input type="text" id="singer-desc" placeholder="E.g. 'Raspy Male Baritone'"
                                    class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-2.5 text-sm text-slate-300 mb-3 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all"
                                    oninput="updatePrompt()">
                                <div id="voices-container" class="flex flex-wrap gap-2"></div>
                            </div>

                            <div>
                                <p class="text-xs text-slate-500 mb-2 uppercase tracking-wider font-semibold">
                                    Instrumentation</p>
                                <div class="relative mb-3">
                                    <input type="text" id="instrument-search" placeholder="Search instruments..."
                                        class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-2.5 text-sm text-slate-300 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10">
                                    <i data-lucide="search"
                                        class="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                </div>
                                <div id="instruments-container"
                                    class="flex flex-wrap gap-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Mood & Tempo -->
                    <section class="glass-panel p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="zap" class="w-5 h-5 text-yellow-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">3. Vibe & Grid</h2>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <p class="text-xs text-slate-500 mb-2 uppercase tracking-wider font-semibold">Atmosphere
                                </p>
                                <div id="moods-container" class="flex flex-wrap gap-2"></div>
                            </div>

                            <div>
                                <p class="text-xs text-slate-500 mb-2 uppercase tracking-wider font-semibold">Tempo</p>
                                <div class="relative">
                                    <select id="tempo-select" onchange="updatePrompt()"
                                        class="w-full appearance-none bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-2.5 text-sm text-slate-300 focus:outline-none focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/50 transition-all">
                                        <option value="">Select Tempo...</option>
                                        <!-- JS Populated -->
                                    </select>
                                    <div
                                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none">
                                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Production -->
                    <section class="glass-panel p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="sliders-horizontal" class="w-5 h-5 text-emerald-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">4. The Mix</h2>
                        </div>
                        <div id="production-container" class="flex flex-wrap gap-2"></div>
                    </section>

                    <!-- Exclusions -->
                    <section class="glass-panel p-6 border-red-500/20 shadow-red-900/10">
                        <div class="flex items-center gap-3 mb-4">
                            <i data-lucide="ban" class="w-5 h-5 text-red-400"></i>
                            <h2 class="text-lg font-semibold text-slate-200">5. Forbidden Sounds</h2>
                        </div>
                        <input type="text" id="exclusion-input" placeholder="e.g. Drums, Vocals, Acoustic..."
                            class="w-full bg-slate-950/50 border border-slate-800 rounded-xl px-4 py-2.5 text-sm text-slate-300 focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-red-900/50"
                            oninput="updateExclusions(this.value)">
                    </section>
                </div>

                <!-- Right Column: Sticky Output -->
                <div class="lg:col-span-5">
                    <div
                        class="glass-panel p-6 sticky top-24 border-t-4 border-t-purple-500 shadow-2xl shadow-purple-900/20">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-white">Style Prompt</h3>
                            <div class="flex space-x-1">
                                <button onclick="saveCurrentPrompt()"
                                    class="p-2 text-slate-400 hover:text-emerald-400 hover:bg-emerald-400/10 rounded-lg transition-colors"
                                    title="Save to Library">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-clear-all" onclick="clearAll()"
                                    class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors"
                                    title="Reset All">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <div class="relative mb-4 group">
                            <textarea id="style-output" readonly
                                class="w-full h-48 bg-slate-950/80 border border-slate-700/50 rounded-xl p-4 text-purple-100 font-mono text-sm leading-relaxed resize-none focus:outline-none focus:border-purple-500/50 transition-all custom-scrollbar"
                                placeholder="Constructing prompt..."></textarea>
                            <div id="char-count"
                                class="absolute bottom-3 right-3 text-[10px] text-slate-500 bg-black/60 px-2 py-0.5 rounded-full backdrop-blur-sm border border-white/5">
                                0/120
                            </div>
                        </div>

                        <!-- Exclusions Output -->
                        <div class="mb-4">
                            <label
                                class="text-[10px] text-slate-500 uppercase font-bold mb-1.5 block flex justify-between">
                                <span>Negative Prompt</span>
                                <i data-lucide="ban" class="w-3 h-3 text-red-500/50"></i>
                            </label>
                            <div class="flex gap-2">
                                <input id="style-exclusions-output" readonly
                                    class="w-full bg-slate-950/50 border border-slate-800 rounded-lg px-3 py-2 text-slate-400 font-mono text-xs focus:outline-none"
                                    placeholder="No exclusions">
                                <button onclick="copyToClipboard('style-exclusions-output', this)"
                                    class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg transition-colors border border-slate-700">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="copyToClipboard('style-output', this)"
                                class="w-full py-3.5 rounded-xl font-bold flex items-center justify-center space-x-2 transition-all bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-900/30 group active:scale-[0.98]">
                                <i data-lucide="copy" class="w-5 h-5 group-hover:hidden"></i>
                                <i data-lucide="check" class="w-5 h-5 hidden group-[.copied]:block"></i>
                                <span class="btn-text">Copy Prompt</span>
                            </button>

                            <div id="length-warning"
                                class="hidden flex items-start space-x-2 text-amber-400 bg-amber-900/20 border border-amber-500/20 p-3 rounded-xl text-xs">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                <p>Prompt exceeds recommended length (>120 chars). Suno may ignore the end.</p>
                            </div>
                        </div>

                        <div class="mt-6 pt-6 border-t border-white/10">
                            <button onclick="switchTab('lyrics')"
                                class="w-full py-2.5 bg-slate-800/50 hover:bg-slate-800 text-slate-300 hover:text-white text-sm rounded-xl transition-colors flex items-center justify-center space-x-2 border border-white/5 hover:border-white/10">
                                <span>Go to Lyrics Editor</span>
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: LYRICS -->
        <div id="tab-lyrics" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-[calc(100vh-140px)] min-h-[600px]">
                <!-- Main Editor -->
                <div class="lg:col-span-8 h-full flex flex-col glass-panel overflow-hidden">
                    <div
                        class="border-b border-white/5 p-4 flex items-center justify-between bg-white/5 backdrop-blur-md">
                        <h2 class="font-semibold text-slate-200 flex items-center gap-2">
                            <i data-lucide="mic" class="w-4 h-4 text-purple-400"></i>
                            Lyrics & Structure
                        </h2>

                        <div class="flex items-center gap-3">
                            <span
                                class="text-[10px] text-slate-500 hidden sm:block font-mono bg-black/20 px-2 py-1 rounded">
                                Use metatags [Chorus] to control flow
                            </span>
                            <button onclick="saveCurrentPrompt()"
                                class="p-2 text-slate-400 hover:text-emerald-400 hover:bg-emerald-400/10 rounded-lg transition-colors"
                                title="Save to Library">
                                <i data-lucide="save" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex-grow relative bg-slate-950/30">
                        <textarea id="lyrics-input"
                            class="w-full h-full p-6 bg-transparent text-slate-200 font-mono text-sm leading-relaxed focus:outline-none resize-none custom-scrollbar"
                            placeholder="[Intro]&#10;..."></textarea>
                    </div>

                    <div
                        class="border-t border-white/5 p-4 bg-white/5 backdrop-blur-md flex justify-between items-center">
                        <div class="text-xs text-slate-500 hidden sm:block">
                            Pro Tip: Use <span
                                class="font-mono bg-slate-700/50 px-1 py-0.5 rounded text-slate-300">Da-a-shes</span>
                            for melismas.
                        </div>
                        <button onclick="copyToClipboard('lyrics-input', this)"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-2 shadow-lg shadow-purple-900/20">
                            <i data-lucide="copy" class="w-3 h-3"></i>
                            <span class="btn-text">Copy Lyrics</span>
                        </button>
                    </div>
                </div>

                <!-- Toolbox -->
                <div class="lg:col-span-4 space-y-6 h-full overflow-y-auto pb-10 custom-scrollbar pr-2">

                    <!-- AI Generator -->
                    <div
                        class="glass-panel p-5 border-indigo-500/20 shadow-indigo-900/10 bg-gradient-to-br from-indigo-900/10 to-purple-900/10">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i>
                            <h3 class="font-semibold text-indigo-200 text-sm">AI Lyricist</h3>
                        </div>

                        <div class="space-y-3">
                            <div class="flex gap-2">
                                <input type="password" id="api-key" placeholder="Gemini API Key"
                                    class="flex-grow bg-slate-950/50 border border-slate-700/50 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-indigo-500/50 transition-all">
                                <button onclick="validateAndLoadModels()"
                                    class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors border border-slate-700/50"
                                    title="Connect">
                                    <i data-lucide="link" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <select id="ai-model"
                                class="w-full bg-slate-900/50 border border-slate-700/50 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-indigo-500/50">
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                <option value="gemini-pro">Gemini 1.0 Pro</option>
                            </select>

                            <input type="text" id="lyric-topic" placeholder="Song topic..."
                                class="w-full bg-slate-900/50 border border-slate-700/50 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-indigo-500/50">

                            <button onclick="generateLyrics('structure', event)"
                                class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-xs font-bold text-white transition-all shadow-lg shadow-indigo-900/20 flex items-center justify-center gap-2">
                                <i data-lucide="wand-2" class="w-3 h-3"></i> Generate
                            </button>
                        </div>
                    </div>

                    <!-- Structure Tags -->
                    <div class="glass-panel p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i>
                            <h3 class="font-semibold text-slate-200 text-sm">Structure</h3>
                        </div>
                        <div id="structure-tags-container" class="grid grid-cols-2 gap-2">
                            <!-- JS Injected -->
                        </div>
                    </div>

                    <!-- Performance Cues -->
                    <div class="glass-panel p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="mic-2" class="w-4 h-4 text-yellow-400"></i>
                            <h3 class="font-semibold text-slate-200 text-sm">Performance</h3>
                        </div>
                        <div id="performance-tags-container" class="grid grid-cols-2 gap-2">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: LIBRARY -->
        <div id="tab-library" class="tab-content">
            <div class="max-w-4xl mx-auto space-y-6 pb-20">
                <div class="glass-panel p-8">
                    <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4">
                        <i data-lucide="library" class="w-6 h-6 text-blue-400"></i>
                        <div>
                            <h2 class="text-xl font-bold text-white">Saved Prompts</h2>
                            <p class="text-sm text-slate-500">Local browser storage</p>
                        </div>
                    </div>

                    <div id="library-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- JS populated -->
                        <div class="text-center py-10 text-slate-500 col-span-2 italic flex flex-col items-center">
                            <i data-lucide="archive" class="w-8 h-8 opacity-20 mb-2"></i>
                            Empty library
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: JSON -->
        <div id="tab-json" class="tab-content">
            <div class="max-w-4xl mx-auto space-y-8 pb-20">
                <div class="glass-panel p-8">
                    <div class="flex items-center justify-between mb-6 border-b border-white/5 pb-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-3">
                            <i data-lucide="code" class="w-6 h-6 text-green-400"></i>
                            JSON Export
                        </h2>
                        <button onclick="copyToClipboard('json-output', this)"
                            class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded-lg font-medium transition-colors flex items-center space-x-2 shadow-lg shadow-green-900/20">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="btn-text">Copy JSON</span>
                        </button>
                    </div>

                    <p class="text-sm text-slate-400 mb-4">
                        Raw metadata format for archiving or advanced usage.
                    </p>

                    <div class="relative">
                        <textarea id="json-output" readonly
                            class="w-full h-96 bg-slate-950/50 border border-slate-700/50 rounded-xl p-6 text-emerald-400 font-mono text-sm leading-relaxed resize-none focus:outline-none focus:border-green-500/50 custom-scrollbar"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA SECTION ---
        const PROMPT_PREFIX = "A song in the style of ";
        const LYRICS_PREFIX = "";

        const GENRES = {
            "Electronic": ["Future Bass", "Synthwave", "Techno", "House", "Trance", "Dubstep", "Ambient", "IDM", "Drum and Bass", "Hardstyle", "Lo-Fi", "UK Garage"],
            "Rock": ["Alternative Rock", "Indie Rock", "Hard Rock", "Metalcore", "Heavy Metal", "Punk", "Psychedelic Rock", "Grunge", "Shoegaze", "Post-Rock", "Math Rock", "Pop Punk"],
            "Pop": ["Synth Pop", "Indie Pop", "K-Pop", "Electropop", "Dream Pop", "Art Pop", "Hyperpop", "City Pop", "Disco", "Funk"],
            "Hip Hop": ["Trap", "Boom Bap", "Grime", "Drill", "Lo-Fi Hip Hop", "Jazz Rap", "Cloud Rap", "Experimental Hip Hop", "Old School"],
            "Jazz & Soul": ["Neo Soul", "Nu Jazz", "R&B", "Future Soul", "Acid Jazz", "Bossa Nova", "Funk", "Gospel", "Smooth Jazz"],
            "Classical & Score": ["Cinematic", "Epic Orchestral", "Piano Solo", "Chamber Pop", "Neoclassical", "Film Score", "Video Game Music"],
            "World": ["Afrobeat", "Reggaeton", "Latin", "Celtic", "Middle Eastern", "Flamenco", "Bhangra", "Klezmer"]
        };

        const INSTRUMENTS = [
            "Synthesizer", "Electric Guitar", "Bass Guitar", "Acoustic Guitar", "Piano", "Drums", "808s",
            "Violin", "Cello", "Strings", "Brass Section", "Saxophone", "Trumpet",
            "Flute", "Harp", "Koto", "Sitar", "Kalimba", "Marimba", "Steel Drums",
            "Analog Synths", "Wobble Bass", "Distorted 808", "Orchestra"
        ];

        const VOICES = [
            "Female Vocals", "Male Vocals", "Androgynous Vocals", "Choir",
            "Ethereal", "Aggressive", "Soft", "Whispery", "Powerful", "Auto-Tuned",
            "Raspy", "Operatic", "Deep", "High-Pitched", "Spoken Word", "Rapping",
            "Duet", "Vocal Chops", "Reverb-Heavy Vocals"
        ];

        const MOODS = [
            "Uplifting", "Melancholic", "Dark", "Euphoric", "Chill", "Energetic",
            "Aggressive", "Romantic", "Nostalgic", "Dreamy", "Mysterious", "Hopeful",
            "Sad", "Happy", "Angry", "Relaxing", "Intense", "Epic", "Cinematic",
            "Trippy", "Groovy", "Funky", "Edgy", "Sentimental"
        ];

        const TEMPO_FEEL = ["Slow", "Medium", "Fast", "Upbeat", "Driving", "Laid Back", "Frenetic", "Half-Time", "Double-Time", "Varying Tempo"];

        const PRODUCTION = [
            "High Fidelity", "Lo-Fi", "Vintage", "Clean", "Distorted",
            "Reverb", "Delay", "Wide Stereo", "Compressed", "Raw",
            "Studio Quality", "Live Recording", "Sampled", "Granular",
            "Minimalist", "Maximalist", "Wall of Sound"
        ];

        // --- DIAL MAPPINGS ---
        // 0-4 scale mappings to tags (Weirdness, Era, Intensity, Tempo, Vocals)
        const TAGS_WEIRDNESS = [
            ["Pop Structure", "Conventional", "Radio Friendly"],
            ["Standard", "Classic Structure"],
            ["Slightly Experimental", "Unique Structure"],
            ["Avant-Garde", "Experimental", "Unconventional"],
            ["Abstract", "Chaos", "Non-Linear", "Glitch"]
        ];

        const TAGS_ERA = [
            ["1950s", "Vintage", "Retro", "Old School"],
            ["1980s", "Synthwave", "Retro-Futurism"],
            ["1990s", "Golden Age", "Classic"],
            ["2000s", "Modern Classic"],
            ["Modern", "Contemporary", "Futuristic", "2020s"]
        ];

        const TAGS_INTENSITY = [
            ["Minimal", "Ambient", "Soft", "Quiet"],
            ["Mellow", "Relaxed", "Chill"],
            ["Balanced", "Mid-Tempo"],
            ["High Energy", "Driving", "Powerful"],
            ["Explosive", "Aggressive", "Hard", "Intense"]
        ];

        const TAGS_TEMPO = [
            ["Downtempo", "Slow", "70 BPM"],
            ["Mid-Tempo", "Groovy", "90 BPM"],
            ["Upbeat", "110 BPM", "Standard"],
            ["Fast", "Driving", "130 BPM"],
            ["Very Fast", "Frenetic", "160+ BPM"]
        ];

        const TAGS_VOCALS = [
            ["Instrumental", "No Vocals"],
            ["Minimal Vocals", "Vocal Chops"],
            ["Standard Vocals", "Verse-Chorus"],
            ["Vocal Heavy", "Lyrical"],
            ["Acapella", "Vocals Only"]
        ];

        const METATAGS = [
            { label: "[Intro]", tag: "[Intro]" },
            { label: "[Verse]", tag: "[Verse]" },
            { label: "[Chorus]", tag: "[Chorus]" },
            { label: "[Bridge]", tag: "[Bridge]" },
            { label: "[Outro]", tag: "[Outro]" },
            { label: "[Instrumental Break]", tag: "[Instrumental Break]" },
            { label: "[Drop]", tag: "[Drop]" },
            { label: "[Hook]", tag: "[Hook]" }
        ];

        const PERFORMANCE_TAGS = [
            { label: "Whisper", tag: "(Whispered)" },
            { label: "Shout", tag: "(Shouted)" },
            { label: "Spoken", tag: "(Spoken)" },
            { label: "Ad-Lib", tag: "(Ad-Lib)" }
        ];

        // --- STATE ---
        let state = {
            genreCat: "",
            subgenres: [],
            instruments: [],
            voices: [],
            moods: [],
            tempo: "",
            production: [],
            singerDescription: "",
            exclusions: ""
        };

        let dialState = {
            previewGenre: "",
            previewInstruments: [],
            previewVoices: [],
            previewMoods: [],
            previewProduction: [],
            previewTempo: ""
        };

        let deleteConfirm = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initGenreUI();
            initDialsGenreUI();
            initMultiSelectUI("instruments-container", INSTRUMENTS, "instruments", "selected-ring-blue");
            initMultiSelectUI("voices-container", VOICES, "voices", "selected-ring-blue");
            initMultiSelectUI("moods-container", MOODS, "moods", "selected-ring-purple"); // Changed to purple/pink
            initMultiSelectUI("production-container", PRODUCTION, "production", "selected-ring-purple"); // Changed to purple/pink which is my new green equivalent visually

            initTempoUI();
            initLyricsTags();
            initDB();

            // Search Listener
            document.getElementById('instrument-search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const container = document.getElementById('instruments-container');
                Array.from(container.children).forEach(btn => {
                    const txt = btn.textContent.toLowerCase();
                    if (txt.includes(term)) btn.style.display = 'block';
                    else btn.style.display = 'none';
                });
            });

            // Restore defaults
            updateDials();
            updatePrompt();
            document.getElementById('lyrics-input').value = LYRICS_PREFIX;
        });

        // --- UI BUILDERS ---

        function initGenreUI() {
            const container = document.getElementById('genre-container');
            container.innerHTML = '';
            Object.keys(GENRES).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `p-3 rounded-xl text-sm border transition-all text-left bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600 hover:text-slate-200`;
                btn.textContent = cat;
                btn.onclick = () => selectGenreCat(cat, btn);
                btn.dataset.val = cat;
                container.appendChild(btn);
            });
        }

        function initDialsGenreUI() {
            const container = document.getElementById('dial-category-filters');
            container.innerHTML = '';

            // Add "ALL" button
            const allBtn = document.createElement('button');
            allBtn.className = "px-3 py-1 rounded-full text-[10px] border transition-colors cursor-pointer bg-purple-500 text-white border-purple-500 font-bold";
            allBtn.textContent = "ALL";
            allBtn.onclick = () => filterDialsGenre('ALL', allBtn);
            container.appendChild(allBtn);

            // Add Category buttons
            Object.keys(GENRES).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-1 rounded-full text-[10px] border transition-colors cursor-pointer bg-slate-900 border-slate-700 text-slate-400 hover:border-slate-500";
                btn.textContent = cat;
                btn.onclick = () => filterDialsGenre(cat, btn);
                container.appendChild(btn);
            });

            populateDialSelect(null);
        }

        function filterDialsGenre(category, btnElement) {
            const container = document.getElementById('dial-category-filters');
            Array.from(container.children).forEach(b => {
                b.className = "px-3 py-1 rounded-full text-[10px] border transition-colors cursor-pointer bg-slate-900 border-slate-700 text-slate-400 hover:border-slate-500";
            });
            btnElement.className = "px-3 py-1 rounded-full text-[10px] border transition-colors cursor-pointer bg-purple-500 text-white border-purple-500 font-bold shadow-lg shadow-purple-500/20";
            populateDialSelect(category === 'ALL' ? null : category);
        }

        function populateDialSelect(filterCategory) {
            const select = document.getElementById('dial-genre-select');
            const currentValue = select.value;
            select.innerHTML = '';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.textContent = filterCategory ? `[ SELECT ${filterCategory.toUpperCase()} GENRE ]` : "Select Base Genre...";
            select.appendChild(defaultOpt);

            const categories = filterCategory ? [filterCategory] : Object.keys(GENRES);

            categories.forEach(cat => {
                if (filterCategory) {
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        option.dataset.category = cat;
                        select.appendChild(option);
                    });
                } else {
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = cat;
                    GENRES[cat].forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        option.dataset.category = cat;
                        optGroup.appendChild(option);
                    });
                    select.appendChild(optGroup);
                }
            });

            if (currentValue) {
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === currentValue) {
                        exists = true;
                        break;
                    }
                }
                if (exists) select.value = currentValue;
            }
        }

        function initMultiSelectUI(containerId, dataList, stateKey, activeClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            dataList.forEach(item => {
                const btn = document.createElement('button');
                // Base classes
                btn.className = "px-3 py-1.5 rounded-full text-xs transition-all border font-medium cursor-pointer select-none bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600";

                if (state[stateKey].includes(item)) {
                    // Active state handled by updateVisuals usually but for init:
                    // We let the loop handle it
                }

                btn.textContent = item;
                btn.dataset.value = item;

                btn.onclick = () => {
                    toggleSelection(item, stateKey);
                    updateBtnVisual(btn, state[stateKey].includes(item), activeClass);
                };
                container.appendChild(btn);
            });
            // Initial visual sync
            setTimeout(() => { // minimal delay to ensure DOM
                state[stateKey].forEach(item => {
                    // find btn
                    const btn = Array.from(container.children).find(b => b.textContent === item);
                    if (btn) updateBtnVisual(btn, true, activeClass);
                });
            }, 0);
        }

        function updateBtnVisual(btn, isSelected, activeClass) {
            if (isSelected) {
                btn.className = `px-3 py-1.5 rounded-full text-xs transition-all border font-medium cursor-pointer select-none ${activeClass} shadow-md`;
            } else {
                btn.className = "px-3 py-1.5 rounded-full text-xs transition-all border font-medium cursor-pointer select-none bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600";
            }
        }

        function initTempoUI() {
            const select = document.getElementById('tempo-select');
            TEMPO_FEEL.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                select.appendChild(opt);
            });
        }

        function initLyricsTags() {
            const structureContainer = document.getElementById('structure-tags-container');
            METATAGS.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700/50 rounded-lg text-xs font-mono text-left text-purple-300 transition-colors hover:text-purple-200";
                btn.textContent = t.label;
                btn.onclick = () => insertTag(t.tag);
                structureContainer.appendChild(btn);
            });

            const perfContainer = document.getElementById('performance-tags-container');
            PERFORMANCE_TAGS.forEach(t => {
                const btn = document.createElement('button');
                btn.className = "px-3 py-2 bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700/50 rounded-lg text-xs font-mono text-left text-yellow-300 transition-colors hover:text-yellow-200";
                btn.textContent = t.label;
                btn.onclick = () => insertTag(t.tag);
                perfContainer.appendChild(btn);
            });
        }

        // --- LOGIC ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Reset Nav Buttons
            document.querySelectorAll('nav button').forEach(btn => {
                btn.className = "px-4 py-2 rounded-full text-sm font-medium transition-all text-slate-400 hover:text-white whitespace-nowrap";
            });

            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Active Nav Button
            const activeBtn = document.getElementById(`tab-btn-${tabName}`);
            activeBtn.className = "px-4 py-2 rounded-full text-sm font-bold transition-all bg-white text-slate-900 shadow-lg shadow-white/10 whitespace-nowrap";

            if (tabName === 'json') generateJsonOutput();
            if (tabName === 'library') renderLibrary();
            if (tabName === 'artist') {
                updateArtistPreviewStats();
                renderArtistList();
            }
        }

        function selectGenreCat(cat, btnElement, preserveSelection = false) {
            state.genreCat = cat;
            if (!preserveSelection) state.subgenres = [];

            const allBtns = document.getElementById('genre-container').children;
            Array.from(allBtns).forEach(b => {
                b.className = `p-3 rounded-xl text-sm border transition-all text-left bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600`;
            });
            if (!btnElement) btnElement = Array.from(allBtns).find(b => b.textContent === cat);

            if (btnElement) {
                btnElement.className = `p-3 rounded-xl text-sm border transition-all text-left bg-gradient-to-br from-purple-600 to-indigo-600 border-purple-500 text-white font-bold shadow-lg shadow-purple-900/40`;
            }

            const subWrapper = document.getElementById('subgenre-wrapper');
            const subContainer = document.getElementById('subgenre-container');
            subContainer.innerHTML = '';

            if (GENRES[cat]) {
                subWrapper.classList.remove('hidden');
                GENRES[cat].forEach(sub => {
                    const sBtn = document.createElement('button');
                    // Default Subgenre
                    sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600";

                    if (state.subgenres.includes(sub)) {
                        sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-purple-500/20 border-purple-500 text-purple-200 shadow-[0_0_10px_rgba(168,85,247,0.2)]";
                    }

                    sBtn.textContent = sub;
                    sBtn.onclick = () => {
                        if (state.subgenres.includes(sub)) {
                            state.subgenres = state.subgenres.filter(s => s !== sub);
                            sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600";
                        } else {
                            state.subgenres.push(sub);
                            sBtn.className = "px-3 py-1.5 rounded-full text-xs transition-colors border bg-purple-500/20 border-purple-500 text-purple-200 shadow-[0_0_10px_rgba(168,85,247,0.2)]";
                        }
                        updatePrompt();
                    };
                    subContainer.appendChild(sBtn);
                });
            } else {
                subWrapper.classList.add('hidden');
            }
            updatePrompt();
        }

        function toggleSelection(item, listKey) {
            const list = state[listKey];
            if (list.includes(item)) {
                state[listKey] = list.filter(i => i !== item);
            } else {
                state[listKey].push(item);
            }
            updatePrompt();
        }

        function updateExclusions(val) {
            state.exclusions = val;
            const exIn = document.getElementById('exclusion-input');
            const artEx = document.getElementById('artist-exclusions');
            const exOut = document.getElementById('style-exclusions-output');

            if (exIn && exIn.value !== val) exIn.value = val;
            if (artEx && artEx.value !== val) artEx.value = val;
            if (exOut) exOut.value = val;

            if (document.getElementById('tab-artist').classList.contains('active')) updateArtistPreviewStats();
        }

        function updatePrompt() {
            const select = document.getElementById('tempo-select');
            state.tempo = select.value;
            state.singerDescription = document.getElementById('singer-desc').value;

            const parts = [];
            if (state.subgenres.length > 0) parts.push(...state.subgenres);
            else if (state.genreCat) parts.push(state.genreCat);

            if (state.tempo) parts.push(state.tempo);
            if (state.moods.length > 0) parts.push(state.moods.join(", "));
            if (state.instruments.length > 0) parts.push(state.instruments.join(", "));
            if (state.singerDescription) parts.push(state.singerDescription);
            if (state.voices.length > 0) parts.push(state.voices.join(", "));
            if (state.production.length > 0) parts.push(state.production.join(", "));

            const text = PROMPT_PREFIX + parts.join(", ");
            document.getElementById('style-output').value = text;
            document.getElementById('char-count').textContent = `${text.length}/120`;

            const warning = document.getElementById('length-warning');
            if (text.length > 120) warning.classList.remove('hidden');
            else warning.classList.add('hidden');

            if (document.getElementById('tab-json').classList.contains('active')) generateJsonOutput();
            if (document.getElementById('tab-artist').classList.contains('active')) updateArtistPreviewStats();
        }

        function insertTag(tag) {
            const textarea = document.getElementById('lyrics-input');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end);

            const isStructureTag = tag.startsWith("[") && !tag.includes("Whisper");
            const prefix = (isStructureTag && before.length > 0 && !before.endsWith("\n")) ? "\n\n" : "";
            const suffix = isStructureTag ? "\n" : "";

            textarea.value = before + prefix + tag + suffix + after;
            textarea.focus();
            const newPos = start + prefix.length + tag.length + suffix.length;
            textarea.setSelectionRange(newPos, newPos);
        }

        // --- GEMINI LYRICS ---
        async function generateLyrics(type, event) {
            const apiKey = document.getElementById('api-key').value.trim();
            const selectedModel = document.getElementById('ai-model').value;
            // Validations omitted for brevity in thought but kept in code
            if (!apiKey) { alert("Please enter API Key"); return; }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Generating...`;
            btn.disabled = true;

            const topic = document.getElementById('lyric-topic').value.trim() || "anything";
            const genre = state.genreCat + (state.subgenres.length ? " (" + state.subgenres.join(", ") + ")" : "");
            const mood = state.moods.join(", ") || "general";

            const promptText = `
            Act as a professional songwriter. Write complete lyrics + structure.
            Genre: ${genre}, Mood: ${mood}, Topic: ${topic}.
            Include [Verse], [Chorus] tags and performance cues like [Whisper].
            Output ONLY lyrics/tags.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "API Error");

                const lyrics = data.candidates[0].content.parts[0].text.trim();
                const textarea = document.getElementById('lyrics-input');
                if (textarea.value === LYRICS_PREFIX || textarea.value === "") textarea.value = LYRICS_PREFIX + lyrics;
                else textarea.value += "\n\n" + lyrics;
                textarea.scrollTop = textarea.scrollHeight;
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- UTILS ---
        function clearAll() {
            if (!confirm("Reset everything?")) return;
            state = { genreCat: "", subgenres: [], instruments: [], voices: [], moods: [], tempo: "", production: [], singerDescription: "", exclusions: "" };

            // Reset UI
            document.getElementById('tempo-select').value = "";
            document.getElementById('singer-desc').value = "";
            document.getElementById('exclusion-input').value = "";
            updatePrompt();

            // Re-render
            updateAllVisuals();
        }

        function updateAllVisuals() {
            if (state.genreCat) {
                const catBtns = document.getElementById('genre-container').children;
                // find btn
                const btn = Array.from(catBtns).find(b => b.textContent === state.genreCat);
                if (btn) selectGenreCat(state.genreCat, btn, true);
            } else {
                // Clear genre selection visually
                const catBtns = document.getElementById('genre-container').children;
                Array.from(catBtns).forEach(b => {
                    b.className = `p-3 rounded-xl text-sm border transition-all text-left bg-slate-950/50 border-slate-800 text-slate-400 hover:border-slate-600`;
                });
                document.getElementById('subgenre-wrapper').classList.add('hidden');
            }

            syncButtonList('instruments-container', state.instruments, "selected-ring-blue");
            syncButtonList('voices-container', state.voices, "selected-ring-blue");
            syncButtonList('moods-container', state.moods, "selected-ring-purple");
            syncButtonList('production-container', state.production, "selected-ring-purple");

            document.getElementById('tempo-select').value = state.tempo;
        }

        function syncButtonList(containerId, stateList, activeClass) {
            const container = document.getElementById(containerId);
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                const isSel = stateList.includes(btn.textContent);
                updateBtnVisual(btn, isSel, activeClass);
            });
        }

        function copyToClipboard(id, btn) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');

            // Visual feedback
            const originalHTML = btn.innerHTML;
            const isGroup = btn.classList.contains('group');
            if (isGroup) btn.classList.add('copied');

            // If it has text span
            const span = btn.querySelector('.btn-text');
            if (span) span.textContent = "Copied!";

            setTimeout(() => {
                if (span) span.textContent = "Copy";
                if (isGroup) btn.classList.remove('copied');
                btn.innerHTML = originalHTML; // Restore icon
            }, 2000);
        }

        // --- DIALS LOGIC (Simplified for Modern UI) ---
        // Need to update sliders to standard standard vars but keeping mapping logic
        function updateDials() {
            const subGenre = document.getElementById('dial-genre-select').value;
            const w = parseInt(document.getElementById('dial-weirdness').value);
            const e = parseInt(document.getElementById('dial-era').value);
            const i = parseInt(document.getElementById('dial-intensity').value);
            const t = parseInt(document.getElementById('dial-tempo').value);
            const v = parseInt(document.getElementById('dial-vocals').value);

            const pick = (arr, val) => arr[Math.min(Math.floor(val / (100 / arr.length)), arr.length - 1)];

            // Mappings from CONSTANTS
            const wTags = pick(TAGS_WEIRDNESS, w);
            const eTags = pick(TAGS_ERA, e);
            const iTags = pick(TAGS_INTENSITY, i);
            const tTags = pick(TAGS_TEMPO, t);
            const vTags = pick(TAGS_VOCALS, v);

            // Update badges
            document.getElementById('tags-weirdness').textContent = wTags.join(", ");
            document.getElementById('tags-era').textContent = eTags.join(", ");
            document.getElementById('tags-intensity').textContent = iTags.join(", ");
            document.getElementById('tags-tempo').textContent = tTags.join(", ");
            document.getElementById('tags-vocals').textContent = vTags.join(", ");

            // Update Preview
            document.getElementById('preview-genre').textContent = subGenre || "Select Genre...";
            document.getElementById('preview-weirdness').textContent = wTags.join(", ");
            document.getElementById('preview-era').textContent = eTags.join(", ");
            document.getElementById('preview-intensity').textContent = iTags.join(", ");
            document.getElementById('preview-tempo').textContent = tTags.join(", ");
            document.getElementById('preview-vocals').textContent = vTags.join(", ");

            // Store in dialState
            dialState = {
                previewGenre: subGenre,
                previewInstruments: wTags, // weird -> instruments/style
                previewProduction: eTags, // era -> production
                previewMoods: iTags, // intensity -> moods
                previewTempo: tTags[0],
                previewVoices: vTags
            };
        }

        function applyDialsToMain() {
            if (!dialState.previewGenre) { alert("Select a genre first!"); return; }

            // Map Dials to Main State
            state.subgenres = dialState.previewGenre ? dialState.previewGenre.split(", ") : [];
            // Merge tags
            // Note: This logic is loose, just appending dial tags to respective categories
            state.subgenres.push(...dialState.previewInstruments);
            state.production = [...dialState.previewProduction];
            state.moods = [...dialState.previewMoods];
            state.tempo = dialState.previewTempo;
            state.voices = [...dialState.previewVoices];

            // Try to match genre cat
            const sel = document.querySelector(`#dial-genre-select option[value="${dialState.previewGenre.split(",")[0]}"]`);
            if (sel && sel.parentElement.tagName === 'OPTGROUP') {
                state.genreCat = sel.parentElement.label;
            }

            updateAllVisuals();
            switchTab('style');
        }

        function generateJsonOutput() {
            const data = {
                genre: [state.genreCat, ...state.subgenres].filter(Boolean).join(", "),
                instruments: state.instruments.join(", "),
                persona: [state.singerDescription, ...state.voices].filter(Boolean).join(", "),
                style_tags: [state.tempo, ...state.moods].filter(Boolean).join(", "),
                recording: state.production.join(", "),
                exclusions: state.exclusions
            };
            document.getElementById('json-output').value = JSON.stringify(data, null, 4);
        }

        // --- DB & ARTIST ---
        const DB_NAME = 'SunoArchitectDB';
        const DB_VERSION = 2;
        let db;

        function initDB() {
            const r = indexedDB.open(DB_NAME, DB_VERSION);
            r.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains("prompts")) db.createObjectStore("prompts", { keyPath: "id" }).createIndex("timestamp", "timestamp");
                if (!db.objectStoreNames.contains("artists")) db.createObjectStore("artists", { keyPath: "id" });
            };
            r.onsuccess = (e) => {
                db = e.target.result;
                renderLibrary();
                if (document.getElementById('tab-artist').classList.contains('active')) renderArtistList();
            };
        }

        function saveCurrentPrompt() {
            const txt = document.getElementById('style-output').value;
            if (!txt) { alert("Empty prompt!"); return; }
            const name = prompt("Name this save:", state.subgenres[0] || "Untitled");
            if (!name) return;

            const tx = db.transaction(["prompts"], "readwrite");
            tx.objectStore("prompts").add({
                id: Date.now(),
                name,
                state: JSON.parse(JSON.stringify(state)),
                text: txt,
                lyrics: document.getElementById('lyrics-input').value,
                timestamp: new Date()
            });
            tx.oncomplete = () => { alert("Saved!"); renderLibrary(); };
        }

        function loadPrompt(id) {
            db.transaction(["prompts"]).objectStore("prompts").get(id).onsuccess = (e) => {
                const d = e.target.result;
                if (d) {
                    state = d.state;
                    if (d.lyrics) document.getElementById('lyrics-input').value = d.lyrics;
                    updateAllVisuals();
                    switchTab('style');
                }
            };
        }

        function deletePrompt(id) {
            if (!confirm("Delete?")) return;
            db.transaction(["prompts"], "readwrite").objectStore("prompts").delete(id).oncomplete = renderLibrary;
        }

        function renderLibrary() {
            if (!db) return;
            const list = document.getElementById('library-list');
            list.innerHTML = '';
            let count = 0;
            db.transaction("prompts").objectStore("prompts").index("timestamp").openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    count++;
                    const item = cursor.value;
                    const el = document.createElement('div');
                    el.className = "bg-slate-900/50 border border-slate-700/50 rounded-xl p-4 flex flex-col gap-3 group hover:border-purple-500/50 transition-colors";
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-slate-200">${item.name}</h3>
                            <button onclick="deletePrompt(${item.id})" class="text-slate-600 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <div class="text-xs text-slate-500 bg-black/20 p-2 rounded line-clamp-2 font-mono">${item.text}</div>
                        <button onclick="loadPrompt(${item.id})" class="mt-auto w-full py-2 bg-purple-600/20 text-purple-300 hover:bg-purple-600 hover:text-white rounded-lg text-xs font-bold transition-all">Load</button>
                     `;
                    list.appendChild(el);
                    cursor.continue();
                }
                if (count === 0 && !cursor) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-500 col-span-2 italic">Nothing saved yet.</div>`;
                }
                lucide.createIcons();
            };
        }

        // Artist Logic
        function saveArtist() {
            const name = document.getElementById('artist-name').value;
            // Assume validation handled
            const profile = { genreCat: state.genreCat, subgenres: [...state.subgenres], instruments: [...state.instruments], voices: [...state.voices], production: [...state.production], singerDescription: state.singerDescription, exclusions: state.exclusions };

            db.transaction(["artists"], "readwrite").objectStore("artists").add({
                id: Date.now(),
                name,
                bio: document.getElementById('artist-bio').value,
                profile
            }).oncomplete = () => { alert("Artist Saved!"); renderArtistList(); };
        }

        function loadArtist(id) {
            db.transaction("artists").objectStore("artists").get(id).onsuccess = (e) => {
                const a = e.target.result;
                if (a) {
                    state = { ...state, ...a.profile, moods: [] }; // Reset moods
                    updateAllVisuals();
                    switchTab('style');
                }
            };
        }

        function deleteArtist(id) {
            if (confirm("Delete Artist?")) db.transaction(["artists"], "readwrite").objectStore("artists").delete(id).oncomplete = renderArtistList;
        }

        function renderArtistList() {
            if (!db) return;
            const list = document.getElementById('artist-list');
            list.innerHTML = '';
            let count = 0;
            db.transaction("artists").objectStore("artists").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    count++;
                    const a = cursor.value;
                    const el = document.createElement('div');
                    el.className = "p-4 rounded-xl bg-slate-900/50 border border-slate-800/50 hover:border-pink-500/50 transition-all cursor-pointer group";
                    el.onclick = (ev) => { if (!ev.target.closest('button')) loadArtist(a.id); };
                    el.innerHTML = `
                        <div class="flex justify-between mb-2">
                             <h4 class="font-bold text-slate-200 group-hover:text-pink-400">${a.name}</h4>
                             <button onclick="deleteArtist(${a.id})" class="text-slate-600 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <div class="text-xs text-slate-500 line-clamp-2">${a.bio || "No bio"}</div>
                     `;
                    list.appendChild(el);
                    cursor.continue();
                }
                if (count === 0 && !cursor) {
                    list.innerHTML = `<div class="text-center py-10 text-slate-500 italic">No artists.</div>`;
                }
                lucide.createIcons();
            };
        }

        function updateArtistPreviewStats() {
            const div = document.getElementById('artist-preview-stats');
            if (!div) return;
            if (!state.genreCat && !state.subgenres.length) {
                div.innerHTML = `<p class="italic text-slate-600">Start simply: Select a genre foundation...</p>`;
                return;
            }
            div.innerHTML = `
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-slate-500">Foundation</span> <span class="text-purple-400">${state.genreCat}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-slate-500">Subs</span> <span class="text-slate-300 w-1/2 truncate text-right">${state.subgenres.join(", ")}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-slate-500">Vocal Tag</span> <span class="text-blue-400 w-1/2 truncate text-right">${state.voices.join(", ")}</span></div>
             `;
        }
    </script>
</body>

</html>
